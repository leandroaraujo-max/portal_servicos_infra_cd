<!-- Tab_WMS.html - Aba de Cancelamento de Impressões WMS -->
<!-- v1.7.0: Nova funcionalidade de gerenciamento de filas de impressão do cluster WMS -->

<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
        Cancelamento de Filas de Impressão WMS
    </h2>
    <p class="text-sm text-gray-500 mb-6">
        Solicite o cancelamento de trabalhos de impressão pendentes em todo o cluster WMS.
        A limpeza será executada automaticamente após aprovação.
    </p>

    <div class="space-y-6">
        <!-- Step 1: Solicitante (Dados completos BQ) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Solicitante (ID, Nome, Usuário ou Email)
                </label>
                <div class="flex gap-2">
                    <input type="text" v-model="wmsUserId" @keyup.enter="fetchWmsUserInfo"
                        placeholder="Busca inteligente..."
                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <button @click="fetchWmsUserInfo" :disabled="wmsSearchingUser"
                        class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all flex items-center">
                        <svg v-if="wmsSearchingUser" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <svg v-else class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
                <div v-if="wmsUserFound" class="mt-2 p-2 bg-green-50 rounded border border-green-100 animate-fade-in">
                    <p class="text-[10px] text-green-700 font-bold uppercase tracking-tight">
                        ✅ {{ wmsUserFound.nome }}
                    </p>
                    <p class="text-[9px] text-green-600">
                        {{ wmsUserFound.filial }} | {{ wmsUserFound.user_name }} | {{ wmsUserFound.email }}
                    </p>
                </div>
            </div>
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Filial (Filtro de Impressoras)
                </label>
                <input type="text" v-model="wmsPrinterFilter"
                    placeholder="Digite para filtrar impressoras pela filial..."
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 uppercase">
                <p class="mt-1 text-[9px] text-gray-400">Ex: 4811, 0034, LUBM</p>
            </div>
        </div>

        <!-- Step 2: Seleção da Fila de Impressão -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Fila de Impressão
                </label>
                <select v-model="wmsQueueName"
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <option value="" disabled>Selecione a Fila...</option>
                    <option v-for="printer in filteredWmsPrinters" :key="printer" :value="printer">{{ printer }}
                    </option>
                </select>
                <p class="mt-1 text-[9px] text-gray-400">
                    {{ wmsPrinterCache.length }} impressoras disponíveis no cluster WMS.
                </p>
            </div>
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Analista Responsável
                </label>
                <select v-model="wmsAnalyst"
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <option value="" disabled>Selecione o Analista...</option>
                    <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                </select>
            </div>
        </div>

        <!-- Step 3: Justificativa -->
        <div class="border-b pb-6">
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                Justificativa (Obrigatório)
            </label>
            <textarea v-model="wmsJustification" rows="3"
                placeholder="Descreva o motivo da solicitação de limpeza da fila..."
                class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 resize-none"></textarea>
        </div>

        <!-- Resumo e Botão -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div v-if="wmsUserFound && wmsQueueName"
                class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-200 w-full md:w-auto">
                <span class="font-bold">Resumo:</span>
                Limpar a fila <span class="font-mono bg-orange-100 px-1 rounded">{{ wmsQueueName }}</span>
                para <span class="font-medium">{{ wmsUserFound.nome }}</span>
            </div>
            <button @click="submitWmsRequest"
                :disabled="wmsLoading || !wmsUserFound || !wmsQueueName || !wmsAnalyst || !wmsJustification"
                class="w-full md:w-auto bg-orange-600 hover:bg-orange-700 text-white px-10 py-3 rounded-xl text-sm font-bold transition-all disabled:opacity-50 shadow-lg flex items-center justify-center gap-2 transform hover:scale-105 active:scale-95">
                <svg v-if="wmsLoading" class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <svg v-else class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" />
                </svg>
                SOLICITAR LIMPEZA DE FILA
            </button>
        </div>
    </div>

    <!-- Status Message -->
    <div v-if="wmsLoading"
        class="mt-6 flex items-center justify-center p-8 bg-orange-50 rounded-lg border border-orange-100 flex-col gap-3">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
        <p class="text-sm text-orange-700">{{ wmsStatusMsg || 'Processando solicitação...' }}</p>
    </div>

    <!-- Success Message -->
    <div v-if="wmsSuccess"
        class="mt-6 border-l-4 border-green-500 bg-green-50 p-6 rounded-r-lg shadow-sm animate-fade-in">
        <h3 class="text-lg font-bold text-green-800 mb-1">Solicitação Registrada com Sucesso!</h3>
        <p class="text-sm text-green-700">
            A solicitação de limpeza da fila <b>{{ wmsQueueName }}</b> foi enviada para aprovação.
            Após aprovação, o Daemon executará a limpeza automaticamente em todos os servidores do cluster.
        </p>
        <p class="text-xs text-green-600 mt-2">ID da Solicitação: <span class="font-mono">{{ wmsRequestId }}</span></p>
    </div>
</div>