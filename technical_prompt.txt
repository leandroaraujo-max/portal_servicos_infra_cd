# Documentação Técnica e Código Fonte COMPLETO

### Arquivos App Script\AppsScript_Backend.js
```
// --- VERSÃO API: 1.7.0 (WMS CLUSTER FEATURE) ---
const PROJECT_ID_API = 'maga-bigdata';

/**
 * v1.7.0: Função para incluir arquivos HTML parciais (Modularização Frontend)
 * Uso no template: <?!= include('Tab_Resets') ?>
 */
function include(filename) {
    return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// ÚNICA PLANILHA DE GESTÃO (Obtida dinamicamente via Database.js)
// [CONSTANTE REMOVIDA] ID_PLANILHA_GESTAO foi descontinuado na v1.6.6 

// Config email Admin
const EMAIL_ADMIN = "leandro.araujo@luizalabs.com";
const LOGO_BASE64 = 'data:image/png;base64,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'

function doGet(e) {
    // 1. ACTIONS & APPROVALS (Action via Email Link)
    if (e && e.parameter && e.parameter.action) {
        // Handle actions like 'finalizar', 'approve', 'reject'
        if (e.parameter.action === 'finalizar' && e.parameter.id) {
            return finalizarAtendimentoBitlocker(e.parameter.id, e.parameter.analista);
        }
        return handleApprovalAction(e);
    }

    // 2. API & DAEMON (Mode via URL)
    if (e && e.parameter && e.parameter.mode) {
        // v1.5.0: Lista Analistas Otimizada
        if (e.parameter.mode === 'get_analysts_api') {
            return ContentService.createTextOutput(JSON.stringify(getAnalystsListAPI())).setMimeType(ContentService.MimeType.JSON);
        }

        // v1.7.0: WMS Cluster API (Daemon)
        if (e.parameter.mode === 'get_wms_cluster') {
            return ContentService.createTextOutput(JSON.stringify(getWmsClusterNodes())).setMimeType(ContentService.MimeType.JSON);
        }


        // DIAGNÓSTICO DE AMBIENTE (v1.6.5)
        if (e.parameter.mode === 'diag') {
            return ContentService.createTextOutput(JSON.stringify(handleDiagnostic())).setMimeType(ContentService.MimeType.JSON);
        }

        // Daemon v4 Main Queue (Reset & Mirror)
        if (e.parameter.mode === 'get_daemon_queue') {
            return handleUnifiedQueue();
        }

        // Legacy/Specific Checks
        if (e.parameter.mode === 'check_mirror_queue') {
            return ContentService.createTextOutput(handleMirrorQueueCheck()).setMimeType(ContentService.MimeType.JSON);
        }
        if (e.parameter.mode === 'get_analysts') {
            return ContentService.createTextOutput(JSON.stringify(getAnalystsList())).setMimeType(ContentService.MimeType.JSON);
        }
        if (e.parameter.mode === 'api') {
            return handlePowerShellQueueRequest();
        }
        if (e.parameter.mode === 'debug_full') {
            return ContentService.createTextOutput(debugSheetReader()).setMimeType(ContentService.MimeType.JSON);
        }

        // DEBUG TEMPORARIO: Estrutura da Planilha
        if (e.parameter.mode === 'debug_queue') {
            const ss = getDatabaseConnection();
            const sheet = ss.getSheetByName("Solicitações");
            const data = sheet.getDataRange().getDisplayValues();
            const headers = data[0];
            const lastRows = data.slice(-10).map((r, idx) => ({
                row_idx: data.length - 10 + idx + 1,
                id: r[0],
                nome: r[4],
                status_proc: r[9],
                status_aprov: r[10],
                tipo: r[11],
                raw: r
            }));
            return ContentService.createTextOutput(JSON.stringify({
                sheet_name: sheet.getName(),
                total_rows: data.length,
                headers: headers,
                last_items: lastRows
            })).setMimeType(ContentService.MimeType.JSON);
        }
    }

    // 3. WEB APP (INTERFACE PADRÃO COM LOGO)
    var tmp = HtmlService.createTemplateFromFile('AppsScript_Web_Index');
    tmp.LOGO_BASE64 = LOGO_BASE64; // Injeta a variável no template HTML
    return tmp.evaluate()
        .setTitle('Reset de Usuários - Suporte Infra CDs')
        .addMetaTag('viewport', 'width=device-width, initial-scale=1')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// =========================================================================
// AUTH SYSTEM (Login, Senha, Token)
// =========================================================================

function getAuthSheet() {
    const ss = getDatabaseConnection();
    let sheet = ss.getSheetByName("AUTH");
    if (!sheet) {
        sheet = ss.insertSheet("AUTH");
        sheet.setTabColor("Red");
    }

    if (sheet.getLastRow() === 0) {
        sheet.appendRow(["ID_MAGALU", "NOME", "EMAIL", "SENHA_HASH", "SALT", "STATUS", "PRIMEIRO_ACESSO", "DATA_CRIACAO"]);
        sheet.getRange(1, 1, 1, 8).setFontWeight("bold").setBackground("#e6b8af");
    }
    return sheet;
}

function fetchUserByID(id) {
    if (!id) throw new Error("ID obrigatório");
    const sanID = String(id).replace(/\D/g, "");

    const sql = `
        SELECT t2.NOME, t1.email
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE CAST(t2.ID AS STRING) = '${sanID}'
        AND t2.SITUACAO = 'Em Atividade Normal'
        LIMIT 1
    `;

    const rows = executeQueryBQ(sql);
    if (!rows || rows.length === 0) {
        throw new Error("ID não encontrado ou inativo no BigQuery.");
    }

    return {
        nome: rows[0][0],
        email: rows[0][1]
    };
}

// 2. LOGIN COM GOOGLE (NOVO)
// =========================================================================
// AUTH SYSTEM (Login via Domínio Corporativo)
// =========================================================================

// Lista Branca de Domínios Permitidos (Domain-Only Auth)
const ALLOWED_DOMAINS = [
    'aiqfome.com',
    'canaltech.com.br',
    'coopluiza.com.br',
    'epocacosmeticos.com.br',
    'fintechmagalu.com.br',
    'gflogistica.com.br',
    'hubsales.com.br',
    'jovemnerd.com.br',
    'luizalabs.com',
    'magalu.cloud',
    'magalupay.com.br',
    'magazineluiza.com.br',
    'mtgparticipacoes.com.br',
    'netshoes.com',
    'netshoes.com.br',
    'pjdagropastoril.com.br',
    'sode.com.br',
    'stealthelook.com.br'
];

function loginWithGoogle() {
    const email = Session.getActiveUser().getEmail();

    if (!email) {
        throw new Error("Não foi possível identificar sua conta Google. Certifique-se de dar permissão ao script.");
    }

    const domain = email.split("@")[1];

    if (!ALLOWED_DOMAINS.includes(domain)) {
        throw new Error("Acesso Negado: Utilize sua conta corporativa. Contas pessoais (@gmail.com) ou de outros domínios não são permitidas. Por favor, faça logout da conta atual e entre com seu e-mail corporativo.");
    }

    // Se o domínio for válido, o acesso é concedido (Domain-Only Trust)
    // Buscamos dados no BQ apenas para enriquecer a sessão, sem bloquear se falhar ou não achar.
    let userDetails = null;
    try {
        userDetails = getUserDetails(email);
    } catch (e) {
        console.warn("Falha ao buscar detalhes no BQ para " + email + ": " + e.message);
    }

    return {
        success: true,
        token: email,
        name: (userDetails && userDetails.nome) ? userDetails.nome : email.split("@")[0],
        email: email,
        filial: (userDetails && userDetails.filial) ? userDetails.filial : "EXTERNO/CORPORATIVO",
        centro_custo: (userDetails && userDetails.centro_custo) ? userDetails.centro_custo : "",
        cargo: (userDetails && userDetails.cargo) ? userDetails.cargo : ""
    };
}

function getUserDetails(email) {
    if (!email) return null;
    // Ajuste conforme seu schema real no BigQuery
    const sql = `
        SELECT ID, NOME, FILIAL, CENTRO_CUSTO, CARGO 
        FROM \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\`
        WHERE EMAIL = '${email}'
        LIMIT 1
    `;
    const rows = executeQueryBQ(sql);
    if (!rows || rows.length === 0) return null;

    const r = rows[0]; // [ID, NOME, FILIAL, CENTRO_CUSTO, CARGO]
    return {
        id: r[0],
        nome: r[1],
        filial: r[2],
        centro_custo: r[3],
        cargo: r[4]
    };
}

/* FUNÇÕES DE LOGIN MANUAL DESATIVADAS
// 1. SOLICITA ACESSO
function requestAccess(id, nome, email) { ... }
 
// 2. LOGIN
function login(email, password) { ... }
 
// 3. TROCA DE SENHA
function changePassword(email, newPass, isFirstAccessFlow) { ... }
 
// 5. RECUPERAÇÃO DE SENHA
function requestPasswordReset(email) { ... }
*/

// =========================================================================
// API ENDPOINT (GET)
// =========================================================================

// [DUPLICATE DOGET REMOVED]

// Lógica de Fila isolada - ATUALIZADA para incluir email_gestor
// Lógica de Fila isolada - ATUALIZADA para incluir Resets e Espelhos
function handlePowerShellQueueRequest() {
    const ss = getDatabaseConnection();
    let usersToReset = [];

    // 1. FILA DE RESET (Solicitações)
    let sheetQueue = ss.getSheetByName("Solicitações");
    if (sheetQueue) {
        const qData = sheetQueue.getDataRange().getDisplayValues();
        if (qData.length > 1) {
            for (let i = 1; i < qData.length; i++) {
                let row = qData[i];
                if (row.length < 11) continue; // Precisa ter col 10 (Status_Aprovacao)

                let status = String(row[9]).toUpperCase().trim();          // Coluna J
                let statusAprovacao = String(row[10]).toUpperCase().trim(); // Coluna K

                if (status === "PENDENTE" && (statusAprovacao === "APROVADO" || statusAprovacao === "REPROVADO")) {
                    let filial = row[2];
                    let centroCusto = row[6];
                    let emailsLideres = [];
                    try { emailsLideres = fetchLeadersEmails(filial, centroCusto); } catch (e) { }

                    let emailGestor = (emailsLideres && emailsLideres.length > 0) ? emailsLideres[0] : "";

                    usersToReset.push({
                        task_type: "RESET",
                        id_solicitacao: row[0],
                        user_name: row[3],
                        nome: row[4],
                        email_colaborador: row[5],
                        email_gestor: emailGestor,
                        centro_custo: centroCusto,
                        aba: filial,
                        analista: row[7],
                        solicitante: row[8],
                        emails_lideres: emailsLideres,
                        status_aprovacao: statusAprovacao
                    });
                }
            }
        }
    }

    // 2. FILA DE ESPELHO (Espelho_Solicitacoes)
    let sheetMirror = ss.getSheetByName("Espelho_Solicitacoes");
    if (sheetMirror) {
        const mData = sheetMirror.getDataRange().getValues();
        if (mData.length > 1) {
            for (let i = 1; i < mData.length; i++) {
                let status = String(mData[i][7]).toUpperCase().trim();          // Coluna H
                let statusAprovacao = String(mData[i][9]).toUpperCase().trim(); // Coluna J

                if (status === "PENDENTE_EXECUCAO" && (statusAprovacao === "APROVADO" || statusAprovacao === "REPROVADO")) {
                    usersToReset.push({
                        task_type: "MIRROR",
                        id_solicitacao: String(mData[i][0]),
                        user_modelo: mData[i][2],
                        targets: JSON.parse(mData[i][3]), // Array de destinos
                        grupos: JSON.parse(mData[i][4]),  // Array de grupos
                        solicitante: mData[i][5],
                        analista: mData[i][6],
                        aba: "ESPELHO",
                        nome: "Espelho - " + mData[i][2],
                        user_name: "Multiplos",
                        status_aprovacao: statusAprovacao
                    });
                }
            }
        }
    }

    if (usersToReset.length === 0) {
        return ContentService.createTextOutput(JSON.stringify({ error: "[v1.0.5] Fila Vazia." }))
            .setMimeType(ContentService.MimeType.JSON);
    }

    return ContentService.createTextOutput(JSON.stringify(usersToReset)).setMimeType(ContentService.MimeType.JSON);
}

// =========================================================================
// GESTÃO DE ANALISTAS
// =========================================================================

function ATUALIZAR_CADASTRO_ANALISTAS() {
    const ss = getDatabaseConnection();
    let sheet = ss.getSheetByName("Analistas");

    if (!sheet) {
        sheet = ss.insertSheet("Analistas");
        sheet.appendRow(["ID_MAGALU", "NOME", "EMAIL", "SITUACAO_RH", "DATA_ATUALIZACAO"]);
        sheet.getRange(1, 1, 1, 5).setFontWeight("bold").setBackground("#d9ead3");
        throw new Error("Aba 'Analistas' criada. Insira IDs na Coluna A e execute novamente.");
    }

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) throw new Error("Insira IDs na coluna A.");

    const rangeIds = sheet.getRange(2, 1, lastRow - 1, 1);
    const ids = rangeIds.getValues().flat().filter(id => id && String(id).trim() !== "");

    if (ids.length === 0) throw new Error("Nenhum ID encontrado na coluna A.");

    const cleanIds = ids.map(id => `'${String(id).replace(/\D/g, "")}'`).join(",");

    const sql = `
        SELECT 
            CAST(t2.ID AS STRING) as ID,
            t2.NOME, 
            t1.email,
            t2.SITUACAO
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE CAST(t2.ID AS STRING) IN (${cleanIds})
    `;

    const rows = executeQueryBQ(sql);

    const resultMap = new Map();
    rows.forEach(r => {
        resultMap.set(String(r[0]), {
            nome: r[1],
            email: r[2],
            situacao: r[3]
        });
    });

    const outputData = [];
    const timestamp = new Date();

    ids.forEach(id => {
        const cleanId = String(id).replace(/\D/g, "");
        const data = resultMap.get(cleanId);
        if (data) {
            const nomeFormatado = toTitleCase(data.nome);
            const emailMinusculo = String(data.email).toLowerCase();
            outputData.push([nomeFormatado, emailMinusculo, data.situacao, timestamp]);
        } else {
            outputData.push(["NÃO ENCONTRADO NO BQ", "-", "ERRO", timestamp]);
        }
    });

    sheet.getRange(2, 2, outputData.length, 4).setValues(outputData);
    Logger.log("Atualização concluída.");
}

function toTitleCase(str) {
    if (!str) return "";
    return String(str).toLowerCase().split(' ').map(function (word) {
        return (word.charAt(0).toUpperCase() + word.slice(1));
    }).join(' ');
}



function getAnalystsList() {
    const cache = CacheService.getScriptCache();
    const cached = cache.get("LISTA_ANALISTAS_SHEET_V2");
    if (cached) return JSON.parse(cached);

    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Analistas");
    if (!sheet) return ["ERRO: Aba Analistas não existe"];

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];

    const data = sheet.getRange(2, 2, lastRow - 1, 3).getValues();

    const activeAnalysts = data
        .filter(r => {
            const nome = r[0];
            const situacao = String(r[2]).toLowerCase();
            return nome && nome !== "NÃO ENCONTRADO NO BQ" && (situacao.includes("atividade") || situacao.includes("normal"));
        })
        .map(r => r[0])
        .sort();

    cache.put("LISTA_ANALISTAS_SHEET_V2", JSON.stringify(activeAnalysts), 1200);
    return activeAnalysts;
}

// =========================================================================
// FUNÇÕES WEB APP (BUSCA, FILA)
// =========================================================================

function getFiliaisList() {
    const cache = CacheService.getScriptCache();
    const cached = cache.get("FILIAIS_LIST_BQ");
    if (cached) return JSON.parse(cached);

    const sql = `
        SELECT DISTINCT FILIAL 
        FROM \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` 
        WHERE SITUACAO = 'Em Atividade Normal' 
        ORDER BY FILIAL
    `;
    try {
        const rows = executeQueryBQ(sql);
        const filiais = rows.map(r => r[0]);
        cache.put("FILIAIS_LIST_BQ", JSON.stringify(filiais), 21600);
        return filiais;
    } catch (e) {
        return ["Erro ao buscar filiais (BQ)"];
    }
}

/**
 * BUSCA UNIVERAL / CORINGA BIGQUERY (v1.1.3)
 * Sem limites de resultados conforme solicitado.
 */
function searchUserBQ(query) {
    if (!query) throw new Error("Informe um termo para busca.");
    const term = String(query).replace(/'/g, "").toUpperCase().trim();

    const sql = `
        SELECT 
            t2.ID,
            t1.user_name,
            t2.NOME,
            t2.CARGO,
            t1.email,
            t2.CENTRO_CUSTO,
            t2.FILIAL
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE (
            UPPER(t1.user_name) = '${term}' 
            OR UPPER(t2.NOME) LIKE '%${term}%'
            OR CAST(t2.ID AS STRING) = '${term}'
            OR CAST(t2.FILIAL AS STRING) = '${term}'
            OR UPPER(t1.email) = '${term}'
            OR UPPER(t1.email) LIKE '%${term}%'
        )
        AND t2.SITUACAO = 'Em Atividade Normal'
        ORDER BY t2.NOME
    `;

    try {
        const rows = executeQueryBQ(sql);
        let auditados = getUsuariosAuditados();

        return rows.map(row => ({
            id: row[0],
            user_name: row[1],
            nome: row[2],
            cargo: row[3],
            email: row[4],
            centro_custo: row[5],
            filial: row[6],
            ja_resetado: auditados.has(String(row[1]).toUpperCase().trim())
        }));
    } catch (e) {
        throw new Error("Erro BQ: " + e.message);
    }
}

/**
 * v1.5.1: Registra solicitação de BitLocker na fila com dados completos do BQ
 */
function submitBitlockerRequest(payload) {
    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Solicitações");
    const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");

    const u = payload.userData || {};
    const lastRow = sheet.getLastRow();

    // Cálculo do próximo ID
    let nextId = 1;
    if (lastRow > 1) {
        const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
        nextId = Math.max(...ids.map(Number)) + 1;
    }

    // Chamada Zendesk
    const ticketId = abrirTicketZendesk({
        tipo_tarefa: "BITLOCKER",
        valor: payload.hostname,
        email_solicitante: payload.requester,
        email_analista: payload.analystEmail || payload.analyst,
        subcategoria: "acessos_bitlocker",
        filial: u.filial || "" // Passa filial do userData para tag Zendesk
    });

    sheet.appendRow([
        nextId,                              // ID (A)
        timestamp,                           // DATA (B)
        u.filial || "BITLOCKER",             // FILIAL (C)
        u.user_name || payload.hostname,     // USER_NAME (D) - Prioriza username, fallback para hostname
        u.nome || "Estação AD",              // NOME (E)
        u.email || "-",                      // EMAIL_COLAB (F)
        u.centro_custo || "-",               // CENTRO_CUSTO (G)
        payload.analystEmail || payload.analyst, // ANALISTA (H)
        payload.requester,                   // SOLICITANTE (I)
        "PENDENTE",                          // STATUS_PROCESSAMENTO (J)
        "APROVADO",                          // STATUS_APROVACAO (K)
        "BITLOCKER",                         // TIPO_TAREFA (L)
        payload.passwordId,                  // DETALHES_ADICIONAIS (M) -> 8 Dígitos do ID da Senha
        "", "", "", "",                      // N, O, P, Q
        ticketId || "FALHA_ZD"               // R
    ]);

    return { success: true, requestId: nextId };
}

function submitResetQueue(requestData) {
    // Dispatch para função específica de desbloqueio se necessário
    if (requestData.task_type === "DESBLOQUEIO_CONTA" || requestData.task_type === "UNLOCK") {
        return submitUnlockRequest(requestData);
    }

    const ss = getDatabaseConnection();
    let queueSheet = ss.getSheetByName("Solicitações");

    if (!queueSheet) {
        queueSheet = ss.insertSheet("Solicitações");
        // SCHEMA v1.3.0 (A-Q)
        queueSheet.appendRow(["ID", "DATA_HORA", "FILIAL", "USER_NAME", "NOME", "EMAIL_COLAB", "CENTRO_CUSTO", "ANALISTA_RESPONSAVEL", "SOLICITANTE", "STATUS_PROCESSAMENTO", "STATUS_APROVACAO", "TIPO_TAREFA", "DETALHES_ADICIONAIS", "MODELO", "DESTINOS", "GRUPOS", "ULTIMO_LEMBRETE"]);
        queueSheet.setTabColor("Blue");
        queueSheet.getRange(1, 1, 1, 17).setFontWeight("bold").setBackground("#cfe2f3");
        queueSheet.setFrozenRows(1);
    }

    const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss"); // Formato String para consistência visual
    const requesterEmail = Session.getActiveUser().getEmail();

    // Mapeia Analista
    const analystData = mapAnalystByEmail(requesterEmail);
    const finalAnalystEmail = analystData ? analystData.email : requesterEmail;
    const finalAnalystName = analystData ? analystData.nome : requestData.analyst;
    const emailType = (requestData.task_type === "DESBLOQUEIO_CONTA") ? "DESBLOQUEIO" : "RESET";

    // 1. OTIMIZAÇÃO: Cálculo de IDs em lote
    let startId = 1;
    const lastRow = queueSheet.getLastRow();
    if (lastRow > 1) {
        const ids = queueSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
        const maxId = ids.reduce((max, val) => {
            const num = parseInt(val, 10);
            return !isNaN(num) && num > max ? num : max;
        }, 0);
        startId = maxId + 1;
    }

    // 2. OTIMIZAÇÃO: Construção da matriz de dados (Bulk Insert)
    const rowsToAdd = requestData.users.map((u, index) => {
        const currentId = startId + index;
        const ticketId = abrirTicketZendesk({
            tipo_tarefa: requestData.task_type || "RESET",
            valor: u.user_name,
            email_solicitante: requesterEmail,
            email_analista: finalAnalystEmail,
            subcategoria: (requestData.task_type === "DESBLOQUEIO_CONTA") ? "acessos_desbloquei_usuario" : "acessos_reset_de_senha",
            filial: requestData.filial // Passa a filial para formatar a tag tkf_filial_XXX
        });

        return [
            currentId,                      // A (0)
            timestamp,                      // B (1)
            requestData.filial || u.filial, // C (2)
            u.user_name,                    // D (3)
            u.nome,                         // E (4)
            u.email,                        // F (5)
            u.centro_custo,                 // G (6)
            finalAnalystEmail,              // H (7)
            requesterEmail,                 // I (8)
            "PENDENTE",                     // J (9)
            "PENDENTE",                     // K (10)
            requestData.task_type || "RESET", // L (11)
            "",                             // M (12)
            "",                             // N (13)
            "",                             // O (14)
            "",                             // P (15)
            "",                             // Q (16)
            ticketId || "FALHA_ZD"          // R (17)
        ];
    });

    if (rowsToAdd.length > 0) {
        queueSheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    }

    SpreadsheetApp.flush();

    // 3. OBSERVAÇÃO SOBRE EMAILS:
    // Enviar 1000 emails pode exceder cota/tempo. 
    // Mantemos o envio individual por enquanto, mas em blocos grandes idealmente seria assíncrono.
    // Para simplificar e atender o requisito de "registros individuais", focamos na planilha.
    // O envio abaixo pode demorar.

    // Opcional: Limitar envio de emails em massa para evitar timeout ou usar Gatilho.
    // Pelo pedido do usuário, "gerar solicitações" é prioridade.

    try {
        if (requestData.users.length <= 20) {
            // Envia para volumes pequenos
            requestData.users.forEach((u, i) => {
                sendApprovalEmail(finalAnalystName, finalAnalystEmail, (startId + i), emailType, u.user_name, u.nome);
            });
        } else {
            // Para volumes grandes, envia apenas um resumo ou processa assincronamente (TODO)
            // Por segurança, não vamos travar o script tentando enviar 1000 emails síncronos.
        }
    } catch (e) {
        console.error("Erro ao enviar emails de aprovação:", e);
    }


    return { success: true, count: rowsToAdd.length };
}

/**
 * Submissão específica para Desbloqueio de Conta (Fornecida pelo Usuário + Adaptação Filial)
 * Integra gravação em Planilha + Abertura de Ticket Zendesk
 */
function submitUnlockRequest(requestData) {
    const ss = getDatabaseConnection();
    let queueSheet = ss.getSheetByName("Solicitações");

    // Garante que os cabeçalhos existam
    ensureHeaders(queueSheet);

    const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");
    const requesterEmail = Session.getActiveUser().getEmail();

    // Identidade 2: Analista selecionado
    const analystData = mapAnalystByEmail(requesterEmail);
    const finalAnalystEmail = analystData ? analystData.email : (requestData.analyst || requesterEmail);

    // 1. Cálculo de ID sequencial
    const lastRow = queueSheet.getLastRow();
    let startId = 1;
    if (lastRow > 1) {
        const ids = queueSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
        const validIds = ids.map(Number).filter(n => !isNaN(n));
        if (validIds.length > 0) {
            startId = Math.max(...validIds) + 1;
        }
    }

    // 2. Processamento
    const rowsToAdd = requestData.users.map((u, index) => {
        const currentId = startId + index;

        // Integração Zendesk
        let ticketId = "FALHA_ZD";
        try {
            ticketId = abrirTicketZendesk({
                tipo_tarefa: "DESBLOQUEIO_CONTA",
                valor: u.user_name,
                email_solicitante: requesterEmail,
                email_analista: finalAnalystEmail,
                subcategoria: "acessos_desbloquei_usuario",
                filial: u.filial
            });
        } catch (e) {
            console.error("Erro Zendesk no Desbloqueio:", e.message);
            ticketId = `FALHA_ZD: ${e.message}`;
        }

        // Se o retorno da função for uma string de erro (começa com FALHA_ZD), usa ela
        if (ticketId && String(ticketId).startsWith("FALHA_ZD")) {
            // Mantém o erro
        } else if (!ticketId) {
            ticketId = "FALHA_ZD: Retorno Nulo";
        }

        // Retorna a linha completa (A até R)
        return [
            currentId,          // A
            timestamp,          // B
            u.filial,           // C
            u.user_name,        // D
            u.nome,             // E
            u.email,            // F
            u.centro_custo,     // G
            finalAnalystEmail,  // H
            requesterEmail,     // I
            "PENDENTE",         // J
            "APROVADO",         // K (Auto-aprovado)
            "DESBLOQUEIO_CONTA",// L
            "", "", "", "", "", // M-Q
            ticketId            // R
        ];
    });

    // 3. Gravação
    if (rowsToAdd.length > 0) {
        queueSheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    }

    return { success: true, count: rowsToAdd.length, firstTicketId: rowsToAdd[0][17] };
}


/**
 * v1.7.0: Função genérica para submissão de solicitações (WMS, etc)
 * Chamada pelo Frontend via google.script.run.submitRequest(payload)
 */
function submitRequest(data) {
    try {
        const ss = getDatabaseConnection();
        let queueSheet = ss.getSheetByName("Solicitações");

        if (!queueSheet) {
            return { success: false, message: "Aba Solicitações não encontrada" };
        }

        const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");
        const requesterEmail = Session.getActiveUser().getEmail();

        // Obter próximo ID
        const lastRow = queueSheet.getLastRow();
        let nextId = 1;
        if (lastRow > 1) {
            const ids = queueSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
            const maxId = ids.reduce((max, val) => {
                const num = parseInt(val, 10);
                return !isNaN(num) && num > max ? num : max;
            }, 0);
            nextId = maxId + 1;
        }

        // Mapeia Analista
        const analystData = mapAnalystByEmail(requesterEmail);
        const finalAnalystEmail = analystData ? analystData.email : (data.analista || requesterEmail);

        // Chamada Zendesk
        const ticketId = abrirTicketZendesk({
            tipo_tarefa: "WMS_PRINT_CLEAN",
            valor: data.queue_name,
            email_solicitante: requesterEmail,
            email_analista: finalAnalystEmail,
            subcategoria: "acessos_limpeza_de_fila_de_impressão",
            filial: data.filial || "" // Passa filial da busca para tag Zendesk
        });

        // Monta a linha no schema padrão (A-R)
        const row = [
            nextId,                           // A: ID
            timestamp,                        // B: DATA_HORA
            data.filial || "",                // C: FILIAL
            data.user_name || "",             // D: USER_NAME
            data.nome || "",                  // E: NOME
            data.email || "",                 // F: EMAIL_COLAB
            data.centro_custo || "",          // G: CENTRO_CUSTO
            finalAnalystEmail,                // H: ANALISTA_RESPONSAVEL
            requesterEmail,                   // I: SOLICITANTE
            "PENDENTE",                       // J: STATUS_PROCESSAMENTO
            "PENDENTE",                       // K: STATUS_APROVACAO (Exige aprovação)
            data.tipo || "WMS_PRINT_CLEAN",   // L: TIPO_TAREFA
            data.justificativa || "",         // M: DETALHES_ADICIONAIS
            data.queue_name || "",            // N: MODELO (usado para queue_name no WMS)
            "",                               // O: DESTINOS
            "",                               // P: GRUPOS
            "",                               // Q: ULTIMO_LEMBRETE
            ticketId || "FALHA_ZD"            // R: TICKET ZENDESK
        ];

        queueSheet.appendRow(row);

        // Envia email de aprovação para o analista
        sendApprovalEmail(
            data.analista,      // Nome
            finalAnalystEmail,  // Email
            nextId,             // ID
            "WMS_PRINT_CLEAN",  // Tipo
            data.queue_name,    // Info1: Fila
            data.justificativa  // Info2: Justificativa
        );

        console.log(`[WMS] Solicitação #${nextId} criada (PENDENTE): ${data.tipo} - ${data.queue_name}`);
        return { success: true, id: nextId };

    } catch (e) {
        console.error("Erro em submitRequest:", e);
        return { success: false, message: e.message };
    }
}

/**
 * Busca dados do analista na aba 'Analistas' usando o e-mail da sessão.
 */
function mapAnalystByEmail(email) {
    if (!email) return null;
    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Analistas");
    if (!sheet) return null;

    const data = sheet.getDataRange().getValues();
    // Pula cabeçalho (i=1)
    for (let i = 1; i < data.length; i++) {
        // Coluna C (Index 2) é o EMAIL
        if (String(data[i][2]).toLowerCase().trim() === String(email).toLowerCase().trim()) {
            return {
                nome: data[i][1], // Coluna B
                email: data[i][2], // Coluna C
                situacao: data[i][3] // Coluna D
            };
        }
    }
    return null;
}

/**
 * Retorna o próximo ID sequencial para a aba Solicitações
 */
function getNextQueueId(sheet) {
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return 1;

    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    let maxId = 0;
    ids.forEach(id => {
        const numId = parseInt(id, 10);
        if (!isNaN(numId) && numId > maxId) {
            maxId = numId;
        }
    });

    return maxId + 1;
}

function getQueueWeb() {
    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Solicitações");
    if (!sheet) return [];

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];

    // Retorna todos os registros (sem limite) - Ajustado para v1.2.1 + Zendesk
    const data = sheet.getRange(2, 1, lastRow - 1, 18).getValues();

    return data.reverse().map(r => ({
        id: r[0],
        data: (r[1] instanceof Date) ? r[1].toISOString() : r[1],
        filial: String(r[2]),
        user: r[3],
        nome: r[4],
        analista: r[7],  // Col H (7) - Restaurado
        status: r[9],    // Col J (9) - Restaurado
        aprovacao: r[10],// Col K (10) - Restaurado
        tipo: r[11],     // Col L (11) - Restaurado
        ticket_zendesk: r[17] || "" // Nova Coluna R
    }));
}

function getUsuariosAuditados() {
    let set = new Set();
    try {
        const ss = getDatabaseConnection();
        let sheet = ss.getSheetByName("Auditoria");
        if (!sheet) return set;

        if (sheet.getLastRow() > 1) {
            const dados = sheet.getRange(2, 3, sheet.getLastRow() - 1, 1).getValues();
            dados.forEach(r => set.add(String(r[0]).toUpperCase().trim()));
        }
    } catch (e) { }
    return set;
}

// ATUALIZADO: doPost agora processa e salva email_gestor + ID auto-incremental
function doPost(e) {
    try {
        const data = JSON.parse(e.postData.contents);
        const ss = getDatabaseConnection();

        // 1. REPORTE DE STATUS DO DAEMON (v4.8)
        if (data.action === "report_status") {
            const sheetFila = ss.getSheetByName("Solicitações");
            const idReq = String(data.id).trim();
            const filaData = sheetFila.getDataRange().getValues();

            let found = false;
            let targetRowIndex = -1;
            let row = null;

            // Busca reversa
            for (let i = filaData.length - 1; i >= 1; i--) {
                if (String(filaData[i][0]).trim() === idReq) {
                    targetRowIndex = i;
                    row = filaData[i];
                    break;
                }
            }

            if (row) {
                // Atualiza status e mensagem
                row[9] = data.status; // Coluna J (Status)
                row[12] = `[${new Date().toLocaleString()}] ${data.message} ${row[12] ? '| ' + row[12] : ''}`; // Coluna M (Detalhes) - Append

                // Lógica de Fechamento Zendesk
                if (data.status === "CONCLUIDO") {
                    const ticketId = row[17]; // Coluna R
                    // Tenta nome colaborador (4) ou solicitante (8)
                    const nomeParaMsg = (row[4] && row[4] !== "N/A" && row[4] !== "") ? row[4] : row[8];

                    if (ticketId && ticketId !== "FALHA_ZD") {
                        fecharTicketZendesk(ticketId, nomeParaMsg);
                    }
                }

                // Salva linha atualizada
                sheetFila.getRange(targetRowIndex + 1, 1, 1, row.length).setValues([row]);
                found = true;
            }

            for (let i = 1; i < filaData.length; i++) {
                if (String(filaData[i][0]).trim() === idReq) {
                    // Col 10 (J): Status Processamento
                    // Col 13 (M): Detalhes Adicionais (Mensagem de Erro/Sucesso)
                    sheetFila.getRange(i + 1, 10).setValue(data.status);
                    if (data.message) {
                        sheetFila.getRange(i + 1, 13).setValue(data.message);
                    }
                    break;
                }
            }

            // Registra Auditoria para Resets/Desbloqueios
            if (data.status === "CONCLUIDO" || data.status === "ERRO") {
                const sheetAudit = ss.getSheetByName("Auditoria");
                if (sheetAudit) {
                    const row = filaData.find(r => String(r[0]).trim() === idReq);
                    if (row && (row[11] === "RESET" || row[11] === "DESBLOQUEIO_CONTA")) {
                        const nextId = getNextAuditId(sheetAudit);
                        sheetAudit.appendRow([
                            nextId,
                            new Date(),
                            row[2], // Filial
                            row[3], // User Name
                            "***",   // Senha (não trafegada no reporte por segurança)
                            data.status,
                            data.analista || row[7],
                            row[5], // Email Colab
                            "",     // Email Gestor (opcional)
                            row[6], // CC
                            data.message || "",
                            row[8]  // Solicitante
                        ]);
                    }
                }
            }
            return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
        }

        // 1.1 LÓGICA DE ATUALIZAÇÃO DO AGENTE (FETCH_GROUPS)
        if (data.action === "update_mirror_result" && data.type !== "EXECUTE_MIRROR") {
            return updateMirrorResult(data);
        }

        // 1.2 BITLOCKER RESULT
        if (data.action === "update_bitlocker_result") {
            return updateBitlockerCustody(data); // FIX: Nome correto da função
        }

        // 2. LÓGICA DE EXECUÇÃO FINAL (Vindo do Script do Analista)
        if (data.type === "EXECUTE_MIRROR") {
            const sheetExec = ss.getSheetByName("Espelho_Solicitacoes");
            if (sheetExec) {
                const idReq = String(data.id_solicitacao).trim();
                const mData = sheetExec.getDataRange().getValues();
                for (let i = 1; i < mData.length; i++) {
                    if (String(mData[i][0]).trim() === idReq) {
                        sheetExec.getRange(i + 1, 8).setValue("FINALIZADO");
                        sheetExec.getRange(i + 1, 9).setValue(""); // Limpa erro
                        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
                    }
                }
            }
            return ContentService.createTextOutput("ID Espelho não encontrado").setMimeType(ContentService.MimeType.TEXT);
        }

        // 3. UPDATE PRINTER CACHE (v1.7.0 - WMS)
        if (data.action === "update_printer_cache") {
            const printers = data.printers || [];
            if (printers.length === 0) {
                return ContentService.createTextOutput("Lista de impressoras vazia").setMimeType(ContentService.MimeType.TEXT);
            }

            let cacheSheet = ss.getSheetByName("Cache_Impressoras");
            if (!cacheSheet) {
                cacheSheet = ss.insertSheet("Cache_Impressoras");
                cacheSheet.appendRow(["LastSync", "PrinterName"]);
            }

            // Limpa dados antigos (preserva header)
            const lastRow = cacheSheet.getLastRow();
            if (lastRow > 1) {
                cacheSheet.deleteRows(2, lastRow - 1);
            }

            // Insere novas impressoras
            const now = new Date();
            const rows = printers.map(p => [now, p]);
            if (rows.length > 0) {
                cacheSheet.getRange(2, 1, rows.length, 2).setValues(rows);
            }

            console.log(`[WMS] Cache atualizado: ${printers.length} impressoras`);
            return ContentService.createTextOutput(`OK: ${printers.length} impressoras`).setMimeType(ContentService.MimeType.TEXT);
        }

        return ContentService.createTextOutput("Ação não reconhecida").setMimeType(ContentService.MimeType.TEXT);
    } catch (e) {
        return ContentService.createTextOutput("Erro: " + e.message).setMimeType(ContentService.MimeType.TEXT);
    }
}

// =========================================================================
// FEATURE ESPELHO DE USUÁRIOS
// =========================================================================

function submitMirrorRequest(userModelo, requester) {
    if (!userModelo) throw new Error("Usuário modelo é obrigatório.");

    const ss = getDatabaseConnection();
    // SEGREGAÇÃO v1.3.4: Usa aba dedicada 'Dados_Espelhamento' para busca volátil
    let sheet = ss.getSheetByName("Dados_Espelhamento");

    if (!sheet) {
        sheet = ss.insertSheet("Dados_Espelhamento");
        sheet.appendRow(["ID", "DATA", "USER_MODELO", "SOLICITANTE", "STATUS", "GRUPOS_JSON", "MSG_ERRO"]);
        sheet.setTabColor("Orange");
        sheet.getRange(1, 1, 1, 7).setFontWeight("bold").setBackground("#f9cb9c");
    }

    const nextId = getNextMirrorId(sheet);
    const timestamp = new Date();

    sheet.appendRow([
        nextId,
        timestamp,
        userModelo,
        requester,
        "BUSCANDO_GRUPOS",
        "",
        ""
    ]);
    SpreadsheetApp.flush(); // Força escrita imediata

    return { success: true, requestId: nextId, message: "Solicitação enviada. Aguardando agente..." };
}

function checkMirrorStatus(requestId) {
    const ss = getDatabaseConnection();
    // SEGREGAÇÃO v1.3.4: Lê da aba Dados_Espelhamento
    const sheet = ss.getSheetByName("Dados_Espelhamento");
    if (!sheet) throw new Error("Aba Dados_Espelhamento não encontrada.");

    const data = sheet.getDataRange().getValues();
    // Busca pelo ID (Coluna A - index 0)
    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === String(requestId).trim()) {
            // Schema Dados_Espelhamento:
            // 0:ID, 1:DATA, 2:MODELO, 3:SOLICITANTE, 4:STATUS, 5:GRUPOS, 6:ERRO
            const status = String(data[i][4] || "").toUpperCase().trim();
            const jsonGrupos = data[i][5];
            const msgErro = data[i][6];

            if (status === "CONCLUIDO" || status === "GRUPOS_ENCONTRADOS" || status === "SUCESSO") {
                let grupos = [];
                if (jsonGrupos) {
                    if (String(jsonGrupos).trim().indexOf('[') === 0) {
                        try { grupos = JSON.parse(jsonGrupos); } catch (e) { grupos = []; }
                    } else {
                        // Fallback split ;
                        grupos = String(jsonGrupos).split(';').filter(g => g);
                    }
                }
                return { status: "CONCLUIDO", groups: grupos };
            }

            if (status === "ERRO" || status === "REPROVADO") {
                return { status: "ERRO", message: msgErro || "Erro ao buscar grupos." };
            }

            return { status: "PENDENTE" };
        }
    }
    throw new Error("Solicitação não encontrada.");
}

// Chamado pelo PowerShell via GET
function handleMirrorQueueCheck() {
    const ss = getDatabaseConnection();
    let requests = [];

    // 1. Busca na fila de capturar grupos (Espelho_Fila) - NÃO PRECISA DE APROVAÇÃO (É SÓ LEITURA)
    const sheetFila = ss.getSheetByName("Espelho_Fila");
    if (sheetFila) {
        const dataFila = sheetFila.getDataRange().getValues();
        for (let i = 1; i < dataFila.length; i++) {
            const status = String(dataFila[i][4]).trim();
            if (status === "BUSCANDO_GRUPOS") {
                requests.push({
                    type: "FETCH_GROUPS",
                    id: String(dataFila[i][0]),
                    user_modelo: dataFila[i][2]
                });
            }
        }
    }

    // 2. Busca na fila de executar espelhamento (Espelho_Solicitacoes) - PRECISA DE APROVAÇÃO
    const sheetExec = ss.getSheetByName("Espelho_Solicitacoes");
    if (sheetExec) {
        const dataExec = sheetExec.getDataRange().getValues();
        for (let i = 1; i < dataExec.length; i++) {
            const status = String(dataExec[i][7]).trim();          // Coluna H (8)
            const statusAprovacao = String(dataExec[i][9]).trim(); // Coluna J (10)

            // Só processa se estiver Pendente de Execução E Aprovado pelo analista
            if (status === "PENDENTE_EXECUCAO" && statusAprovacao === "APROVADO") {
                requests.push({
                    type: "EXECUTE_MIRROR",
                    id: String(dataExec[i][0]),
                    user_modelo: dataExec[i][2],
                    destinos: JSON.parse(dataExec[i][3]),
                    grupos: JSON.parse(dataExec[i][4])
                });
            }
        }
    }

    return ContentService.createTextOutput(JSON.stringify(requests)).setMimeType(ContentService.MimeType.JSON);
}

// Chamado pelo PowerShell via POST
function updateMirrorResult(payload) {
    const ss = getDatabaseConnection();
    const type = payload.type || "FETCH_GROUPS";

    // SEGREGAÇÃO v1.3.4: Define aba alvo baseado no tipo
    const sheetName = (type === "FETCH_GROUPS") ? "Dados_Espelhamento" : "Solicitações";
    const sheet = ss.getSheetByName(sheetName);

    if (!sheet) return ContentService.createTextOutput("Erro: Aba " + sheetName + " nao existe").setMimeType(ContentService.MimeType.TEXT);

    const idReq = String(payload.id || payload.requestId).trim();
    const status = payload.status;
    const msg = payload.msg_error;
    const grupos = payload.grupos || payload.groups; // Payload do Daemon

    const data = sheet.getDataRange().getValues();

    // Mapeamento de Colunas (0-based)
    // Se Dados_Espelhamento: Status=4(E), Grupos=5(F), Erro=6(G)
    // Se Solicitações: Status=9(J), Detalhes=12(M)

    // Config: [StatusCol, ErrorCol, ResultCol]
    let cfg = (type === "FETCH_GROUPS") ? [4, 6, 5] : [9, 12, null];

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === idReq) {

            // SUCESSO
            if (status === "SUCESSO" || status === "GRUPOS_ENCONTRADOS" || status === "CONCLUIDO") {
                // Para FETCH, status é GRUPOS_ENCONTRADOS ou SUCESSO -> CONCLUIDO
                // Para EXECUTE, status é CONCLUIDO -> FINALIZADO (ou mantém CONCLUIDO se padronizou)

                // Vamos padronizar escrita:
                if (type === "FETCH_GROUPS") {
                    sheet.getRange(i + 1, cfg[0] + 1).setValue("CONCLUIDO");
                    if (grupos) sheet.getRange(i + 1, cfg[2] + 1).setValue(grupos);
                } else {
                    sheet.getRange(i + 1, cfg[0] + 1).setValue("CONCLUIDO");
                    // Se houver mensagem de sucesso, pode por em detalhes? opcional.
                }
            }
            // REPROVADO
            else if (status === "REPROVADO") {
                sheet.getRange(i + 1, cfg[0] + 1).setValue("REPROVADO");
                // Se for solicitações, temos STATUS_APROVACAO na col K (10)
                if (type !== "FETCH_GROUPS") sheet.getRange(i + 1, 11).setValue("REPROVADO");
                sheet.getRange(i + 1, cfg[1] + 1).setValue(msg);
            }
            // ERRO
            else {
                sheet.getRange(i + 1, cfg[0] + 1).setValue("ERRO");
                sheet.getRange(i + 1, cfg[1] + 1).setValue(msg);
            }

            SpreadsheetApp.flush();
            return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
        }
    }
    return ContentService.createTextOutput("ID nao encontrado").setMimeType(ContentService.MimeType.TEXT);
}





function getBitlockerKey(requestId) {
    const ss = getDatabaseConnection();
    const sheetKeys = ss.getSheetByName("Bitlocker_Keys");
    if (!sheetKeys) return { success: false, message: "Base de chaves não encontrada" };

    const data = sheetKeys.getDataRange().getValues();
    // Busca de baixo para cima para pegar o mais recente se houver duplicidade (retry)
    for (let i = data.length - 1; i >= 1; i--) {
        if (String(data[i][0]).trim() === String(requestId).trim()) {
            return {
                success: true,
                recoveryKey: data[i][3],
                passwordId: data[i][4],
                hostname: data[i][2]
            };
        }
    }
    return { success: false, message: "Chave não encontrada ou ainda não processada." };
}

function getNextMirrorId(sheet) {
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return 1;
    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    let max = 0;
    ids.forEach(id => {
        let n = parseInt(id, 10);
        if (!isNaN(n) && n > max) max = n;
    });
    return max + 1;
}

/**
 * 2ª ETAPA DO ESPELHO: Registra a execução para o Analista
 */
/**
 * 2ª ETAPA DO ESPELHO: Registra a execução para o Analista
 */
// 1. EXECUÇÃO DE ESPELHAMENTO (Agora vai para a fila Unificada "Solicitações")
function submitMirrorExecution(payload) {
    if (!payload.modelUser || !payload.targets || payload.targets.length === 0) {
        throw new Error("Dados incompletos para espelhamento.");
    }

    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Solicitações");
    const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");

    // FIX v1.3.6: Individualização de Solicitações
    // Cada alvo gera uma linha independente na aba Solicitações.

    // Normalização de input (garante array de objetos ou strings)
    let targetsData = [];
    if (typeof payload.targets[0] === 'object') {
        targetsData = payload.targets; // Já é [{user_name, nome, email, centro_custo}, ...]
    } else {
        // Fallback para strings (legado)
        targetsData = payload.targets.map(t => ({
            user_name: String(t),
            nome: "Usuário AD",
            email: "",
            centro_custo: ""
        }));
    }

    // Calcula IDs em lote para performance (Evita chamadas repetidas de getNextQueueId)
    let startId = 1;
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
        // Pega o maior ID da coluna A
        const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
        const maxId = ids.reduce((max, val) => {
            const num = parseInt(val, 10);
            return !isNaN(num) && num > max ? num : max;
        }, 0);
        startId = maxId + 1;
    }

    // Prepara as linhas para inserção em lote
    const rowsToAdd = targetsData.map((t, index) => {
        const currentId = startId + index;

        // Coluna O (Destinos) para o Daemon espera um ARRAY JSON.
        // Como estamos individualizando, cada linha manda um array com 1 único elemento.
        const targetArrayForDaemon = [t.user_name];

        return [
            currentId,                      // A (0) ID Único
            timestamp,                      // B (1) Data
            t.filial || "ESPELHO",          // C (2) Filial Real (ou fallback se vazio)
            t.user_name,                    // D (3) User Name Real
            t.nome,                         // E (4) Nome Real (SEM sufixo Espelho)
            t.email || "",                  // F (5) Email Real
            t.centro_custo || "",           // G (6) Centro de Custo Real
            payload.analyst,                // H (7) Analista
            payload.requester,              // I (8) Solicitante
            "PENDENTE",                     // J (9) Status
            "PENDENTE",                     // K (10) Status Aprovação (CORREÇÃO: Fluxo de Email necessário)
            "MIRROR",                       // L (11) Tipo
            "",                             // M (12) Detalhes
            payload.modelUser,              // N (13) Modelo
            JSON.stringify(targetArrayForDaemon), // O (14) Destinos (Array de 1)
            JSON.stringify(payload.groups), // P (15) Grupos
            ""                              // Q (16) SLA
        ];
    });

    // Inserção em lote (performance)
    if (rowsToAdd.length > 0) {
        sheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    }

    SpreadsheetApp.flush();

    // Envio de Emails de Aprovação (Limitado a 20 para evitar timeout)
    try {
        if (rowsToAdd.length <= 20) {
            targetsData.forEach((t, index) => {
                const reqId = startId + index;
                // Assumindo sendApprovalEmail(requesterName, requesterEmail, requestId, type, targetUser, targetName)
                // Usamos payload.analyst como destinatário da aprovação
                const analystName = payload.analyst.split('@')[0];
                sendApprovalEmail(analystName, payload.analyst, reqId, "MIRROR", t.user_name, t.nome);
            });
        }
    } catch (e) {
        // Log silently
    }

    // Dispara gatilho SLA
    try { ScriptApp.newTrigger("runSLACheck").timeBased().after(1000).create(); } catch (e) { }

    return { success: true, message: rowsToAdd.length + " espelhamento(s) solicitado(s) individualmente e enviados para aprovação!" };
}

// =========================================================================
// FLUXO DE APROVAÇÃO (DO GET WEB APP)
// =========================================================================

// [DUPLICATE DOGET REMOVED]

function handleApprovalAction(e) {
    const action = e.parameter.action; // approve | reject
    const id = e.parameter.id;
    const type = e.parameter.type; // RESET | MIRROR

    if (!id) return HtmlService.createHtmlOutput("<h3>Erro: ID não informado.</h3>");

    const ss = getDatabaseConnection();
    // UNIFICAÇÃO v1.2.1: Tudo na aba Solicitações
    const sheetName = "Solicitações";
    const statusCol = 11; // Coluna K (Status Aprovação) (1-based index)

    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return HtmlService.createHtmlOutput("<h3>Erro: Base de dados não encontrada.</h3>");

    const data = sheet.getDataRange().getValues();
    let found = false;
    let newStatus = (action === "approve") ? "APROVADO" : "REPROVADO";

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === String(id)) {
            // Verifica se já foi finalizado (Col J = Index 9)
            if (String(data[i][9]).match(/SUCESSO|CONCLU|FINALIZADO/)) {
                return HtmlService.createHtmlOutput("<h2 style='color:orange'>Atenção: Esta solicitação já foi finalizada.</h2>");
            }

            // Atualiza STATUS_APROVACAO
            sheet.getRange(i + 1, statusCol).setValue(newStatus);
            found = true;
            break;
        }
    }

    if (found) {
        let cor = (action === "approve") ? "green" : "red";
        let texto = (action === "approve") ? "APROVADA" : "REPROVADA";
        return HtmlService.createHtmlOutput(`
                <div style='font-family: Arial; text-align: center; padding: 50px;'>
                    <h1 style='color:${cor}'>SOLICITAÇÃO ${texto} COM SUCESSO!</h1>
                    <p>O sistema processará a requisição conforme sua decisão.</p>
                    <p>Pode fechar esta janela.</p>
                </div>
            `);
    } else {
        return HtmlService.createHtmlOutput("<h3 style='color:red'>Erro: ID da solicitação não encontrado.</h3>");
    }
}

function sendRejectionEmail(requesterEmail, analystEmail, requestId, type) {
    if (!requesterEmail) return;

    const subject = `🚫 Solicitação Reprovada: #${requestId}`;
    // Tenta obter nome do analista a partir do email (opcional, ou usa o proprio email)
    const analystName = analystEmail ? analystEmail.split("@")[0] : "Suporte";

    // Se analystEmail for válido, usamos a personificação. Se não, vai genérico.
    // Para simplificar, usamos a mesma logica do sendApproval

    let htmlBody = `
        <div style="font-family: Arial, sans-serif; padding: 20px; color: #333;">
            <h2 style="color: #dc2626;">Solicitação Reprovada</h2>
            <p>Olá,</p>
            <p>Informamos que sua solicitação <strong>#${requestId}</strong> (${type}) foi <strong>REPROVADA</strong> pelo analista responsável.</p>
            <p><strong>Motivo/Ação:</strong> Para entender o motivo da rejeição ou ajustar a solicitação, por favor entre em contato diretamente com o analista responsável.</p>
            
            <p style="background-color: #f3f4f6; padding: 10px; border-radius: 5px; margin-top: 15px;">
                <strong>Analista Responsável:</strong> ${analystEmail || "Não identificado"}<br>
            </p>
            
            <hr style="margin-top: 30px; border: 0; border-top: 1px solid #eee;">
            <p style="font-size: 12px; color: #666;">Sistema de Gerenciamento de Identidades</p>
        </div>
    `;

    try {
        MailApp.sendEmail({
            to: requesterEmail,
            subject: subject,
            name: `Sistema de Reset (via ${analystName})`,
            replyTo: analystEmail || requesterEmail, // Se reclamar, user fala com analista
            htmlBody: htmlBody
        });
    } catch (e) {
        console.error("Erro envio reprovação: " + e.message);
    }
}

function sendApprovalEmail(analystName, analystEmail, requestId, type, info1, info2) {
    const ss = getDatabaseConnection();
    const sheetAnalistas = ss.getSheetByName("Analistas");
    if (!sheetAnalistas) return;

    const data = sheetAnalistas.getDataRange().getValues();
    let emailDestino = "";

    // Busca o email do analista na planilha (caso não venha por parâmetro ou para validar)
    for (let i = 1; i < data.length; i++) {
        if (String(data[i][1]).trim() === String(analystName).trim()) {
            emailDestino = data[i][2];
            break;
        }
    }

    if (!emailDestino) {
        if (analystEmail && analystEmail.includes("@")) {
            emailDestino = analystEmail;
        } else {
            return;
        }
    }

    // Constrói Links
    const scriptUrl = ScriptApp.getService().getUrl();
    const linkApprove = `${scriptUrl}?action=approve&id=${requestId}&type=${type}`;
    const linkReject = `${scriptUrl}?action=reject&id=${requestId}&type=${type}`;

    let subject = "";
    let detailHtml = "";

    if (type === "RESET") {
        subject = `🔐 Validação: Reset Senha #${requestId}`;
        detailHtml = `<p><strong>Tipo:</strong> RESET DE SENHA</p>
                      <p><strong>ID Chamado:</strong> #${requestId}</p>
                      <p><strong>Usuário:</strong> ${info1}</p>
                      <p><strong>Nome:</strong> ${info2}</p>`;
    } else if (type === "DESBLOQUEIO" || type === "DESBLOQUEIO_CONTA") {
        subject = `🔓 Validação: Desbloqueio Conta #${requestId}`;
        detailHtml = `<p><strong>Tipo:</strong> DESBLOQUEIO DE CONTA</p>
                      <p><strong>ID Chamado:</strong> #${requestId}</p>
                      <p><strong>Usuário:</strong> ${info1}</p>
                      <p><strong>Nome:</strong> ${info2}</p>`;
    } else if (type === "WMS_PRINT_CLEAN" || type === "WMS") {
        subject = `🖨️ Validação: Limpeza Fila WMS #${requestId}`;
        detailHtml = `<p><strong>Tipo:</strong> CANCELAMENTO DE IMPRESSÕES WMS</p>
                      <p><strong>ID Chamado:</strong> #${requestId}</p>
                      <p><strong>Fila de Impressão:</strong> ${info1}</p>
                      <p><strong>Justificativa:</strong> ${info2}</p>`;
    } else {
        subject = `👥 Validação: Espelhamento #${requestId}`;
        detailHtml = `<p><strong>Tipo:</strong> ESPELHAMENTO (MIRROR)</p>
                      <p><strong>ID Chamado:</strong> #${requestId}</p>
                      <p><strong>Usuário Modelo:</strong> ${info1}</p>
                      <p><strong>Detalhes:</strong> ${info2}</p>`;
    }

    try {
        MailApp.sendEmail({
            to: emailDestino,
            subject: subject,
            name: `Sistema de Reset (via ${analystName})`,
            replyTo: analystEmail || emailDestino,
            htmlBody: `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        @media only screen and (max-width: 480px) {
                            .container { padding: 15px !important; margin: 10px !important; width: auto !important; }
                            .btn-container { text-align: center !important; }
                            .btn { 
                                display: block !important; 
                                width: 100% !important; 
                                margin: 10px 0 !important; 
                                padding: 15px 0 !important; 
                                text-align: center !important;
                                box-sizing: border-box !important;
                            }
                        }
                    </style>
                </head>
                <body style="margin: 0; padding: 0; background-color: #f9fafb;">
                    <div class="container" style="font-family: 'Segoe UI', Arial, sans-serif; padding: 30px; border: 1px solid #e5e7eb; border-radius: 12px; max-width: 600px; margin: 40px auto; background-color: #ffffff; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                        <h2 style="color: #1e40af; margin-top: 0; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">Validação de Solicitação Técnica</h2>
                        <p style="color: #374151; font-size: 16px;">Olá <strong>${analystName}</strong>,</p>
                        <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">Uma nova solicitação requer sua <strong>APROVAÇÃO</strong> manual antes de ser executada pelo Agente AD.</p>
                        
                        <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 25px 0; border: 1px solid #e5e7eb;">
                             ${detailHtml}
                        </div>

                        <div class="btn-container" style="text-align: center; margin-top: 35px;">
                            <a href="${linkApprove}" class="btn" style="background-color: #16a34a; color: white; padding: 14px 28px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block; margin: 5px; min-width: 160px; font-size: 14px; letter-spacing: 0.5px;">
                                ✅ APROVAR
                            </a>
                            <a href="${linkReject}" class="btn" style="background-color: #dc2626; color: white; padding: 14px 28px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block; margin: 5px; min-width: 160px; font-size: 14px; letter-spacing: 0.5px;">
                                🚫 REPROVAR
                            </a>
                        </div>
                        
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #f3f4f6; color: #9ca3af; font-size: 12px; text-align: center;">
                            <p>* Ao clicar em um dos botões, sua decisão será registrada e processada.<br>
                            Sistema de Gerenciamento de Identidades - Suporte Infra CDs</p>
                        </div>
                    </div>
                </body>
                </html>
            `
        });
    } catch (e) {
        console.error("Erro ao enviar email aprovação: " + e.message);
    }
}

/**
 * Retorna o próximo ID sequencial para a aba Auditoria
 */
function getNextAuditId(sheet) {
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return 1; // Primeira solicitação

    // Lê todos os IDs existentes na coluna A (exceto cabeçalho)
    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();

    // Encontra o maior ID numérico
    let maxId = 0;
    ids.forEach(id => {
        const numId = parseInt(id, 10);
        if (!isNaN(numId) && numId > maxId) {
            maxId = numId;
        }
    });

    return maxId + 1;
}

/**
 * FUNÇÃO UTILITÁRIA: Numera registros existentes na aba Auditoria
 * Execute manualmente uma vez para preencher IDs em registros antigos
 */
function NUMERAR_AUDITORIA_EXISTENTE() {
    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Auditoria");
    if (!sheet) throw new Error("Aba Auditoria não encontrada.");

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) throw new Error("Nenhum registro para numerar.");

    // Verifica se primeira coluna é "ID" no cabeçalho
    const header = sheet.getRange(1, 1).getValue();
    if (String(header).toUpperCase() !== "ID") {
        throw new Error("A coluna A deve ter o cabeçalho 'ID'. Ajuste a planilha manualmente.");
    }

    // Gera IDs sequenciais para linhas sem ID
    const existingIds = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    const updates = [];

    let currentId = 1;
    for (let i = 0; i < existingIds.length; i++) {
        const val = existingIds[i][0];
        if (!val || val === "" || val === null) {
            updates.push([currentId]);
        } else {
            // Mantém ID existente se válido
            const existingNum = parseInt(val, 10);
            if (!isNaN(existingNum)) {
                currentId = existingNum;
                updates.push([existingNum]);
            } else {
                updates.push([currentId]);
            }
        }
        currentId++;
    }

    // Escreve todos os IDs de volta
    sheet.getRange(2, 1, updates.length, 1).setValues(updates);
    Logger.log("Numeração concluída. " + updates.length + " registros processados.");
}

// =========================================================================
// HELPERS (BIGQUERY e UTILS)
// =========================================================================

function executeQueryBQ(sql) {
    try {
        const request = { query: sql, useLegacySql: false };
        let queryResults = BigQuery.Jobs.query(request, PROJECT_ID_API);
        const jobId = queryResults.jobReference.jobId;

        let sleepTimeMs = 500;
        while (!queryResults.jobComplete) {
            Utilities.sleep(sleepTimeMs);
            sleepTimeMs *= 2;
            if (sleepTimeMs > 5000) sleepTimeMs = 5000;
            queryResults = BigQuery.Jobs.getQueryResults(PROJECT_ID_API, jobId);
        }

        let rows = queryResults.rows;
        while (queryResults.pageToken) {
            queryResults = BigQuery.Jobs.getQueryResults(PROJECT_ID_API, jobId, { pageToken: queryResults.pageToken });
            if (queryResults.rows) rows = rows.concat(queryResults.rows);
        }

        if (!rows) return [];
        return rows.map(r => r.f.map(c => c.v));

    } catch (e) {
        throw new Error("Erro ao consultar BigQuery: " + e.message);
    }
}

function fetchLeadersEmails(filial, centroCusto) {
    if (!filial) return [];
    const sanFilial = String(filial).replace(/'/g, "").trim();
    const sanCC = centroCusto ? String(centroCusto).replace(/'/g, "").trim() : "";

    // PASSO 1: Busca líderes no mesmo Centro de Custo
    if (sanCC) {
        const sqlCC = `
            SELECT DISTINCT t1.email
            FROM \`maga-bigdata.kirk.assignee\` AS t1
            INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
                ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
            WHERE 
                CAST(t2.FILIAL AS STRING) = '${sanFilial}'
                AND t2.CENTRO_CUSTO = '${sanCC}'
                AND t2.SITUACAO = 'Em Atividade Normal'
                AND (
                    UPPER(t2.CARGO) LIKE '%GERENTE%' 
                    OR UPPER(t2.CARGO) LIKE '%GESTOR%'
                    OR UPPER(t2.CARGO) LIKE '%GESTORA%'
                    OR UPPER(t2.CARGO) LIKE '%COORDENADOR%' 
                    OR UPPER(t2.CARGO) LIKE '%COORDENADORA%'
                )
            LIMIT 10
        `;

        const rowsCC = executeQueryBQ(sqlCC);
        if (rowsCC && rowsCC.length > 0) {
            const emailsCC = rowsCC.map(r => r[0]).filter(e => e && e.includes('@'));
            if (emailsCC.length > 0) {
                console.log("Líderes encontrados no CC: " + emailsCC.join(", "));
                return emailsCC;
            }
        }
    }

    // PASSO 2: Fallback - Busca líderes na Filial inteira (apenas cargos de alta responsabilidade)
    const sqlFilial = `
        SELECT DISTINCT t1.email, t2.CARGO
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE 
            CAST(t2.FILIAL AS STRING) = '${sanFilial}'
            AND t2.SITUACAO = 'Em Atividade Normal'
            AND (
                UPPER(t2.CARGO) LIKE '%GERENTE%' 
                OR UPPER(t2.CARGO) LIKE '%GESTOR%'
                OR UPPER(t2.CARGO) LIKE '%GESTORA%'
                OR UPPER(t2.CARGO) LIKE '%COORDENADOR%' 
                OR UPPER(t2.CARGO) LIKE '%COORDENADORA%'
            )
        ORDER BY 
            CASE 
                WHEN UPPER(t2.CARGO) LIKE '%GERENTE%' THEN 1
                WHEN UPPER(t2.CARGO) LIKE '%COORDENADOR%' OR UPPER(t2.CARGO) LIKE '%COORDENADORA%' THEN 2
                WHEN UPPER(t2.CARGO) LIKE '%GESTOR%' OR UPPER(t2.CARGO) LIKE '%GESTORA%' THEN 3
                ELSE 4
            END
        LIMIT 15
    `;

    const rowsFilial = executeQueryBQ(sqlFilial);
    if (!rowsFilial || rowsFilial.length === 0) {
        console.log("Nenhum líder encontrado na filial " + sanFilial);
        return [];
    }

    const emailsFilial = rowsFilial.map(r => r[0]).filter(e => e && e.includes('@'));
    console.log("Líderes encontrados na FILIAL (fallback): " + emailsFilial.join(", "));
    return emailsFilial;
}


// =========================================================================
// API UNIFICADA (DAEMON V4)
// =========================================================================

function handleUnifiedQueue() {
    const ss = getDatabaseConnection();
    let requests = [];

    // 1. FILA ÚNICA UNIFICADA (v1.2.0)
    const sheetMaster = ss.getSheetByName("Solicitações");
    if (sheetMaster) {
        const data = sheetMaster.getDataRange().getDisplayValues();
        for (let i = 1; i < data.length; i++) {
            let row = data[i];

            let statusProc = row[9] ? String(row[9]).toUpperCase().trim() : "";  // Col J
            let statusAprov = row[10] ? String(row[10]).toUpperCase().trim() : ""; // Col K
            let taskType = row[11] ? String(row[11]).toUpperCase().trim() : "RESET"; // Col L

            if (statusProc === "PENDENTE" && (statusAprov === "APROVADO" || statusAprov === "REPROVADO")) {
                let r = {
                    id_solicitacao: row[0],
                    task_type: taskType,
                    status_aprovacao: statusAprov,
                    analista: row[7],     // Col H
                    solicitante: row[8],  // Col I
                    aba: row[2],          // Col C (Filial)
                    nome: row[4],
                    user_name: row[3],
                };

                // Dados Específicos por Tipo
                if (taskType === "MIRROR" || taskType === "ESPELHO_USUARIO" || taskType === "FETCH_GROUPS") {
                    r.user_modelo = row[13]; // Col N

                    // FETCH_GROUPS não tem targets/grupos ainda
                    if (taskType !== "FETCH_GROUPS") {
                        r.targets = JSON.parse(row[14] || "[]"); // Col O
                        r.grupos = JSON.parse(row[15] || "[]");  // Col P
                    }
                } else if (taskType === "BITLOCKER") {
                    // BitLocker não precisa de senha
                    r.hostname = row[3]; // Col D = User Name / Hostname
                    r.password_id_prefix = row[12]; // Col M = Prefixo do ID da Senha
                } else if (taskType === "WMS_PRINT_CLEAN") {
                    // v1.7.0: WMS Print Queue Clean
                    r.queue_name = row[13]; // Col N = MODELO (queue_name para WMS)
                    r.filial = row[2];      // Col C = Filial
                    r.justificativa = row[12]; // Col M = DETALHES_ADICIONAIS
                } else {
                    // Reset / Unlock
                    r.nova_senha = generatePassword();
                    r.email_colaborador = row[5];
                    r.centro_custo = row[6];
                }

                requests.push(r);
            }
        }
    }

    // 2. FETCH GROUPS (SEGREGAÇÃO v1.3.4 - Lê de Dados_Espelhamento)
    const sheetFila = ss.getSheetByName("Dados_Espelhamento");
    if (sheetFila) {
        const fData = sheetFila.getDataRange().getValues();
        for (let i = 1; i < fData.length; i++) {
            let status = String(fData[i][4]).trim();
            if (status === "BUSCANDO_GRUPOS") {
                requests.push({
                    task_type: "FETCH_GROUPS",
                    id_solicitacao: String(fData[i][0]),
                    user_modelo: fData[i][2]
                });
            }
        }
    }

    return ContentService.createTextOutput(JSON.stringify(requests)).setMimeType(ContentService.MimeType.JSON);
}

function debugSheetReader() {
    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Solicitações");
    if (!sheet) return "Sheet nao encontrada";
    // Ultimas 5 linhas
    const values = sheet.getDataRange().getDisplayValues();
    const headers = values[0]; // Header
    const last5 = values.slice(-5);

    return JSON.stringify({
        headers: headers,
        last_rows: last5
    });
}

function generatePassword() {
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*";
    let password = "";
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

/**
 * SISTEMA DE SLA (v1.3.0)
 * Monitora e envia lembretes a cada 1h para itens pendentes há > 2h.
 * Os lembretes param automaticamente quando o status deixa de ser 'PENDENTE'.
 */
function runSLACheck() {
    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Solicitações");
    if (!sheet) return;

    ensureHeaders(sheet);
    const data = sheet.getDataRange().getValues();
    const now = new Date();
    const TWO_HOURS = 2 * 60 * 60 * 1000;
    const ONE_HOUR = 1 * 60 * 60 * 1000;

    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const createdAt = row[1]; // Col B (Index 1)
        const anaEmail = row[7];  // Col H (Index 7)
        const statusAprov = String(row[10] || "").toUpperCase().trim(); // Col K (Index 10)
        const id = row[0];
        const tipo = row[11]; // Col L (Index 11)
        const usuarioNome = row[4]; // Col E (Index 4)
        const ultimoLembrete = row[16]; // Col Q (Index 16)

        // FILTRO CRÍTICO: Somente PENDENTE e criadas há mais de 2 horas
        if (statusAprov === "PENDENTE" && (createdAt instanceof Date) && (now - createdAt) > TWO_HOURS) {

            let deveNotificar = false;
            if (!ultimoLembrete || !(ultimoLembrete instanceof Date)) {
                deveNotificar = true; // Primeiro lembrete
            } else if ((now - ultimoLembrete) >= ONE_HOUR) {
                deveNotificar = true; // Lembrete recorrente
            }

            if (deveNotificar && anaEmail && anaEmail.includes("@")) {
                try {
                    const template = HtmlService.createTemplateFromFile('AppsScript_SLA_Template');
                    template.analistaNome = anaEmail.split('.')[0].toUpperCase();
                    template.idSolicitacao = id;
                    template.tipoTarefa = tipo;
                    template.dataCriacao = createdAt.toLocaleString();
                    template.usuarioNome = usuarioNome;

                    const htmlBody = template.evaluate().getContent();

                    GmailApp.sendEmail(anaEmail, "⚠️ ALERTA DE SLA: Solicitação #" + id + " pendente", "", {
                        htmlBody: htmlBody,
                        name: "Suporte Infra (Alerta SLA)"
                    });

                    // Registra timestamp do envio para controle de recorrência - Col Q (Index 17 para o Sheets)
                    sheet.getRange(i + 1, 17).setValue(now);
                    console.log("SLA: Lembrete enviado para " + anaEmail + " (ID #" + id + ")");
                } catch (e) {
                    console.error("Erro SLA p/ " + anaEmail + ": " + e);
                }
            }
        }
    }
}

/**
 * Cria o trigger horário se ele não existir
 */
function setupSLATrigger() {
    const fn = "runSLACheck";
    const triggers = ScriptApp.getProjectTriggers();
    if (!triggers.some(t => t.getHandlerFunction() === fn)) {
        ScriptApp.newTrigger(fn).timeBased().everyHours(1).create();
        console.log("Trigger de SLA configurado.");
    }
}

function ensureHeaders(sheet) {
    const expected = ["ID", "DATA_HORA", "FILIAL", "USER_NAME", "NOME", "EMAIL_COLAB", "CENTRO_CUSTO", "ANALISTA_RESPONSAVEL", "SOLICITANTE", "STATUS_PROCESSAMENTO", "STATUS_APROVACAO", "TIPO_TAREFA", "DETALHES_ADICIONAIS", "MODELO", "DESTINOS", "GRUPOS", "ULTIMO_LEMBRETE"];
    const currentHeaders = sheet.getRange(1, 1, 1, expected.length).getValues()[0];

    let needsUpdate = false;
    for (let i = 0; i < expected.length; i++) {
        if (String(currentHeaders[i] || "").trim() !== expected[i]) {
            needsUpdate = true;
            break;
        }
    }

    if (needsUpdate) {
        sheet.getRange(1, 1, 1, expected.length).setValues([expected]).setFontWeight("bold").setBackground("#cfe2f3");
        sheet.setFrozenRows(1);
    }
}
function getAnalystsList() {
    // Tenta usar a lista global do Frontend.js, senão usa fallback
    if (typeof LISTA_ANALISTAS !== 'undefined') {
        return LISTA_ANALISTAS;
    }
    return [
        "Adriano Machado", "Andson Santos", "Bruna Mueller", "Bruno Montilha", "Carlos Boaventura",
        "Caroline Lima", "Cassiano Teles", "Cleriston Rodrigues", "Didimo Silva", "Douglas Souza",
        "EdsonJunior", "Eduardo Silva", "Estermah Santos", "Fabiano  Rosa", "Francisco Regis",
        "Gabriel Namura", "Gabriel Lima", "Gabriel Villar", "Genison Santos", "Gladson Ferreira",
        "Glauber Vieira", "Helder Ito", "Iugner Santos", "Jacob Lima", "Jair Dias", "Jeronimo Moraes",
        "Kaio Vargas", "Karine Oliveira", "Leandro Araujo", "Leo Rezende", "Levi Dantas",
        "Lucas Silva", "Marcos Freiberger", "Matheus Sinflorio", "Max Weber", "MichelleRodrigues",
        "Naldimar Barros", "Paulo Bizzi", "Pedro Figur", "Rafaela Camecran", "Raiane  Aguiar",
        "Rodrigo Lima", "Rodrigo Costa", "Silas Ferreira", "Thiago Miranda", "Thiago Honorio",
        "Victor Pedroza", "Vinicius Silva", "Wesley Faria", "William Fernandes"
    ];
}

/**
 * v1.5.0: API Otimizada para lista de analistas
 * Retorna apenas {nome, email} de analistas ATIVOS
 */
function getAnalystsListAPI() {
    const cache = CacheService.getScriptCache();
    const cached = cache.get("API_ANALISTAS_LITE");
    if (cached) return JSON.parse(cached);

    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Analistas");
    if (!sheet) return [];

    const data = sheet.getDataRange().getValues();
    const activeAnalysts = [];

    // Pula header
    for (let i = 1; i < data.length; i++) {
        const nome = data[i][1];
        const email = data[i][2];
        const situacao = String(data[i][3]).toLowerCase();

        if (nome && email && (situacao.includes("atividade") || situacao.includes("normal") || situacao.includes("ativo"))) {
            activeAnalysts.push({
                name: toTitleCase(nome),
                email: String(email).toLowerCase()
            });
        }
    }

    // Cache de 1 hora
    cache.put("API_ANALISTAS_LITE", JSON.stringify(activeAnalysts), 3600);
    return activeAnalysts;
}

/**
 * v1.5.9: Armazena custódia do BitLocker e atualiza dados na fila
 */
function updateBitlockerCustody(payload) {
    const ss = getDatabaseConnection();

    // 1. Aba de Custódia (Segura, não synced BQ)
    let sheetKeys = ss.getSheetByName("Bitlocker");
    const expected = ["ID_SOLICITACAO", "DATA_AD", "FILIAL", "HOSTNAME_ID", "RECOVERY_KEY", "KEY_ID"];

    if (!sheetKeys) {
        sheetKeys = ss.insertSheet("Bitlocker");
        sheetKeys.appendRow(expected);
        sheetKeys.getRange(1, 1, 1, expected.length).setFontWeight("bold").setBackground("#e6b8af");
    }

    // Garante headers
    if (sheetKeys.getLastRow() === 0) {
        sheetKeys.appendRow(expected);
    } else if (String(sheetKeys.getRange(1, 1).getValue()) !== "ID_SOLICITACAO") {
        sheetKeys.insertRowBefore(1);
        sheetKeys.getRange(1, 1, 1, expected.length).setValues([expected]);
    }

    // 2. Registra Chave na aba de Custódia
    sheetKeys.appendRow([
        String(payload.id).trim(),
        new Date(),
        payload.filial || "-",
        payload.hostname,
        payload.recoveryKey,
        payload.recoveryKeyId
    ]);

    // 3. Atualiza Fila Principal (Solicitações)
    const sheetFila = ss.getSheetByName("Solicitações");
    const data = sheetFila.getDataRange().getValues();
    const reqId = String(payload.id).trim();

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === reqId) {
            // Col 4 (D): Atualiza para o Hostname Real (estava o ID de 8 dígitos)
            sheetFila.getRange(i + 1, 4).setValue(payload.hostname);

            // Col 10 (J): Status Processamento
            sheetFila.getRange(i + 1, 10).setValue("LOCALIZADO");

            // Col 13 (M): Detalhes Adicionais
            sheetFila.getRange(i + 1, 13).setValue("Chave localizada e enviada para e-mail do analista.");
            break;
        }
    }
    return ContentService.createTextOutput("OK_CUSTODY").setMimeType(ContentService.MimeType.TEXT);
}

/**
 * v1.5.0: Finalização Manual pelo Analista (Link no Email)
 */
function finalizarAtendimentoBitlocker(id, analistaEmail) {
    const ss = getDatabaseConnection();
    const sheet = ss.getSheetByName("Solicitações");
    const data = sheet.getDataRange().getValues();
    const reqId = String(id).trim(); // Conversão Explícita de Tipo

    for (let i = 1; i < data.length; i++) {
        // Comparação segura de String
        if (String(data[i][0]).trim() === reqId) {
            const row = i + 1;

            // Verifica se já não estava concluído
            if (String(data[i][9]).toUpperCase() === "CONCLUÍDO") {
                return HtmlService.createHtmlOutput(`
                    <div style="font-family: sans-serif; text-align: center; padding: 50px;">
                        <h2 style="color: #f59e0b;">⚠️ Atenção</h2>
                        <p>A solicitação <strong>${id}</strong> já havia sido finalizada anteriormente.</p>
                        <button onclick="window.close()" style="padding: 10px 20px; cursor: pointer;">Fechar</button>
                    </div>
                `);
            }

            sheet.getRange(row, 10).setValue("CONCLUÍDO"); // Status
            sheet.getRange(row, 13).setValue("Atendimento presencial realizado. Finalizado por: " + (analistaEmail || "Link Email"));

            // Log Auditoria Opcional (se tiver aba Auditoria)
            // ...

            return HtmlService.createHtmlOutput(`
                <div style="font-family: sans-serif; text-align: center; padding: 50px;">
                    <h2 style="color: #10b981;">✅ Atendimento Finalizado!</h2>
                    <p>A solicitação <strong>${id}</strong> foi marcada como CONCLUÍDA.</p>
                    <p>Obrigado, ${analistaEmail || 'Analista'}.</p>
                    <button onclick="window.close()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer;">Fechar Janela</button>
                </div>
            `);
        }
    }

    return HtmlService.createHtmlOutput(`
        <div style="font-family: sans-serif; text-align: center; padding: 50px;">
            <h2 style="color: #ef4444;">❌ Erro</h2>
            <p>Solicitação <strong>${id}</strong> não encontrada.</p>
        </div>
    `);
}

```

### Arquivos App Script\AppsScript_Web_Index.html
```
<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Portal de Serviços - Suporte Infra CDs</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --magalu-blue: #0086FF;
            --magalu-blue-dark: #0066CC;
            --magalu-blue-darker: #004499;
            --magalu-pink: #E91E76;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Rainbow Strip - Magalu Colors */
        .rainbow-strip {
            height: 4px;
            background: linear-gradient(90deg,
                    #E91E76 0%,
                    #FF5722 16%,
                    #FF9800 32%,
                    #4CAF50 48%,
                    #2196F3 64%,
                    #9C27B0 80%,
                    #E91E76 100%);
            background-size: 200% 100%;
            animation: rainbow-flow 8s linear infinite;
        }

        @keyframes rainbow-flow {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        /* Master Style v1.1.3 - Azul Magalu + Borda Degradê */
        .header-gradient {
            background-color: #0086FF !important;
            position: relative;
        }

        .header-gradient::after {
            content: "";
            position: absolute;
            bottom: 0px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0086FF 0%, #E91E76 50%, #FFC107 100%);
            z-index: 10;
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.2s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Status Badges - Enhanced */
        .badge-pending {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: #92400E;
            border: 1px solid #F59E0B;
        }

        .badge-success {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #065F46;
            border: 1px solid #10B981;
        }

        .badge-error {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: #991B1B;
            border: 1px solid #EF4444;
        }

        /* Button Primary - Magalu Style */
        .btn-magalu {
            background: linear-gradient(135deg, var(--magalu-blue) 0%, var(--magalu-blue-dark) 100%);
            transition: all 0.2s ease;
        }

        .btn-magalu:hover {
            background: linear-gradient(135deg, var(--magalu-blue-dark) 0%, var(--magalu-blue-darker) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 134, 255, 0.4);
        }

        /* Input Focus - Enhanced */
        input:focus,
        select:focus {
            border-color: var(--magalu-blue) !important;
            box-shadow: 0 0 0 3px rgba(0, 134, 255, 0.15) !important;
        }

        /* Table Row Hover */
        .table-row-hover:hover {
            background-color: #EFF6FF !important;
        }

        /* Avatar Glow */
        .avatar-glow {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full">

        <div v-if="currentView === 'login'"
            class="flex min-h-full items-center justify-center py-12 px-4 sm:px-6 lg:px-8 h-full"
            style="background: linear-gradient(135deg, #004499 0%, #0066CC 50%, #0086FF 100%);">

            <!-- Rainbow Strip no topo -->
            <div class="rainbow-strip fixed top-0 left-0 right-0"></div>

            <div
                class="w-full max-w-md space-y-8 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-white/20">
                <div class="text-center flex flex-col items-center">
                    <div class="p-2 mb-2">
                        <img :src="appLogo" alt="LuizaLabs" class="h-16 w-auto mx-auto drop-shadow-md">
                    </div>
                    <h2 class="mt-2 text-3xl font-bold tracking-tight text-gray-900">Portal de Serviços</h2>
                    <p class="text-sm font-medium text-blue-600">Suporte Infra CDs</p>
                    <p class="mt-4 text-sm text-gray-500">
                        Acesso exclusivo com conta Google corporativa
                    </p>
                </div>

                <div class="mt-8">
                    <button @click="handleLogin" :disabled="isLoading"
                        class="group relative flex w-full justify-center items-center gap-3 rounded-lg border border-gray-300 bg-white py-3 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 transition-all shadow-sm">

                        <svg class="h-5 w-5" aria-hidden="true" viewBox="0 0 24 24">
                            <path
                                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                fill="#4285F4" />
                            <path
                                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                fill="#34A853" />
                            <path
                                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                fill="#FBBC05" />
                            <path
                                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                fill="#EA4335" />
                        </svg>

                        {{ isLoading ? 'Autenticando...' : 'Entrar com Google' }}
                    </button>

                    <p v-if="authForm.errorMessage"
                        class="mt-4 text-center text-sm text-red-600 bg-red-50 p-2 rounded border border-red-100">
                        {{ authForm.errorMessage }}
                    </p>
                </div>

                <!-- Versão no canto inferior -->
                <div class="text-center text-xs text-gray-400 pt-4 border-t border-gray-100">
                    v1.9.2 • Leandro Araújo
                </div>
            </div>
        </div>

        <div v-if="currentView === 'app'" class="flex flex-col h-full">

            <header class="header-gradient text-white shadow-lg z-20 py-1 sm:py-0">
                <div
                    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-[4rem] sm:h-20 flex flex-col sm:flex-row items-center justify-between py-2 sm:py-0 gap-2">
                    <div class="flex items-center justify-between w-full sm:w-auto">
                        <div class="flex items-center space-x-2 sm:space-x-3 cursor-pointer hover:opacity-80 transition-opacity"
                            @click="switchTab('new')">
                            <img :src="appLogo" alt="LuizaLabs" class="h-6 sm:h-8 w-auto filter brightness-0 invert">
                            <div class="leading-tight">
                                <div class="font-bold text-sm sm:text-xl tracking-tight">Portal de Serviços</div>
                                <div class="text-[10px] text-blue-200/80">Suporte Infra CDs</div>
                            </div>
                        </div>
                        <div class="flex sm:hidden items-center space-x-2">
                            <div class="h-8 w-8 rounded-full bg-white/20 flex items-center justify-center text-[10px] font-bold"
                                @click="logout">
                                {{ userInitials }}
                            </div>
                        </div>
                    </div>

                    <div class="w-full sm:w-auto overflow-x-auto no-scrollbar pb-1 sm:pb-0">
                        <div class="flex space-x-1 bg-white/10 rounded-lg p-1 min-w-max">
                            <button @click="switchTab('new')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'new', 'text-white/80 hover:text-white': currentTab !== 'new'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Resets
                            </button>
                            <button @click="switchTab('mirror')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'mirror', 'text-white/80 hover:text-white': currentTab !== 'mirror'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Espelhos
                            </button>
                            <button @click="switchTab('unlock')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'unlock', 'text-white/80 hover:text-white': currentTab !== 'unlock'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Desbloqueios
                            </button>

                            <button @click="switchTab('bitlocker')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'bitlocker', 'text-white/80 hover:text-white': currentTab !== 'bitlocker'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                BitLocker
                            </button>
                            <button @click="switchTab('wms')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'wms', 'text-white/80 hover:text-white': currentTab !== 'wms'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path
                                        d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" />
                                </svg>
                                WMS
                            </button>
                            <button @click="loadQueue"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'queue', 'text-white/80 hover:text-white': currentTab !== 'queue'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Solicitações
                            </button>
                        </div>
                    </div>

                    <div class="hidden sm:flex items-center space-x-4">
                        <div class="text-right">
                            <div class="text-[11px] font-medium opacity-90 leading-none mb-1">{{ userEmail }}</div>
                            <div class="text-[9px] text-white/60">Sessão Corporativa</div>
                        </div>
                        <div class="h-10 w-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center text-sm font-bold avatar-glow cursor-pointer hover:bg-white/30 transition-all"
                            @click="logout" title="Sair">
                            {{ userInitials }}
                        </div>
                    </div>
                </div>
            </header>
            <!-- Rainbow Strip (Removed for gold border style) -->


            <main class="flex-1 overflow-auto p-4 sm:p-6 lg:p-8">
                <div class="max-w-7xl mx-auto space-y-6">

                    <!-- ESPELHO DE ACESSO TAB -->
                    <div v-if="currentTab === 'mirror'" class="space-y-6">
                        <!-- PROGRESS BAR -->
                        <div class="flex items-center justify-center space-x-4 mb-8">
                            <div class="flex items-center">
                                <span :class="mirrorStep >= 1 ? 'bg-blue-600' : 'bg-gray-300'"
                                    class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm">1</span>
                                <span class="ml-2 text-sm font-medium"
                                    :class="mirrorStep >= 1 ? 'text-blue-600' : 'text-gray-500'">Modelo e Grupos</span>
                            </div>
                            <div class="w-16 h-0.5 bg-gray-200"></div>
                            <div class="flex items-center">
                                <span :class="mirrorStep >= 2 ? 'bg-blue-600' : 'bg-gray-300'"
                                    class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm">2</span>
                                <span class="ml-2 text-sm font-medium"
                                    :class="mirrorStep >= 2 ? 'text-blue-600' : 'text-gray-500'">Usuários Destino</span>
                            </div>
                        </div>

                        <!-- ETAPA 1: MODELO -->
                        <div v-if="mirrorStep === 1" class="space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h2 class="text-lg font-medium text-gray-900 mb-4">Etapa 1: Definir Usuário Modelo</h2>
                                <p class="text-sm text-gray-500 mb-6">Digite o <b>Usuário de Rede</b> de quem já possui
                                    os acessos.</p>

                                <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
                                    <div class="flex-1">
                                        <label
                                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Usuário
                                            Modelo</label>
                                        <input type="text" v-model="mirrorForm.modelUser"
                                            @keyup.enter="fetchMirrorGroups" placeholder="Ex: usuario_ad"
                                            class="block w-full px-3 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg border bg-white">
                                    </div>
                                    <button @click="fetchMirrorGroups"
                                        :disabled="mirrorLoading || !mirrorForm.modelUser"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center justify-center">
                                        {{ mirrorLoading ? 'Buscando...' : 'Listar Grupos' }}
                                    </button>
                                </div>
                                <div v-if="mirrorStatusMsg"
                                    class="mt-4 flex items-center justify-between bg-orange-50 border border-orange-100 rounded-lg p-3">
                                    <div class="text-sm text-orange-600 font-medium flex items-center gap-2">
                                        <svg class="animate-spin h-4 w-4 text-orange-600"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                            </path>
                                        </svg>
                                        {{ mirrorStatusMsg }}
                                    </div>
                                    <button @click="cancelMirrorPoll"
                                        class="text-xs text-red-600 hover:text-red-800 font-bold underline">
                                        CANCELAR
                                    </button>
                                </div>
                            </div>

                            <div v-if="mirrorGroups.length > 0"
                                class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 animate-fade-in">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-md font-bold text-gray-800">Selecione os Grupos a Espelhar ({{
                                        mirrorGroups.length }})</h3>
                                    <div class="text-sm text-gray-500 space-x-2">
                                        <button @click="selectAllGroups(true)"
                                            class="text-blue-600 hover:underline">Marcar Todos</button>
                                        <span>|</span>
                                        <button @click="selectAllGroups(false)"
                                            class="text-blue-600 hover:underline">Desmarcar Todos</button>
                                    </div>
                                </div>
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[300px] overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50">
                                    <label v-for="grp in mirrorGroups" :key="grp.name"
                                        class="flex items-start space-x-3 p-2 hover:bg-white rounded border border-transparent hover:border-gray-200 transition-all cursor-pointer">
                                        <input type="checkbox" v-model="grp.selected"
                                            class="mt-1 rounded border-gray-300 text-blue-600 h-4 w-4">
                                        <span class="text-xs text-gray-700 break-all">{{ grp.name }}</span>
                                    </label>
                                </div>
                                <div class="mt-6 flex justify-end">
                                    <button @click="mirrorStep = 2" :disabled="selectedGroupsCount === 0"
                                        class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-8 rounded-lg shadow-md disabled:opacity-50">
                                        Próxima Etapa: Selecionar Destinos →
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ETAPA 2: DESTINOS -->
                        <div v-if="mirrorStep === 2" class="space-y-6 animate-fade-in">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-medium text-gray-900">Etapa 2: Selecionar Usuários Destino
                                    </h2>
                                    <button @click="mirrorStep = 1" class="text-sm text-blue-600 hover:underline">←
                                        Voltar para grupos</button>
                                </div>
                                <p class="text-sm text-gray-500 mb-6">Busque e selecione os colaboradores que receberão
                                    os acessos.</p>

                                <div class="flex gap-4">
                                    <div class="flex-1 relative">
                                        <input type="text" v-model="mirrorSearchQuery"
                                            @keyup.enter="performMirrorSearch"
                                            placeholder="Busca Coringa: Nome, ID, Usuário ou E-mail..."
                                            class="block w-full pl-3 pr-10 py-2.5 border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg border bg-white">
                                    </div>
                                    <button @click="performMirrorSearch" :disabled="mirrorSearchLoading"
                                        class="bg-gray-800 hover:bg-black text-white px-6 py-2.5 rounded-lg text-sm font-medium">
                                        {{ mirrorSearchLoading ? 'Buscando...' : 'Buscar' }}
                                    </button>
                                </div>

                                <!-- RESULTADOS BUSCA DESTINO (v1.1.2 Coringa) -->
                                <div v-if="mirrorSearchResults.length > 0"
                                    class="mt-6 border rounded-lg overflow-hidden bg-white shadow-sm">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase w-10">
                                                    <input type="checkbox"
                                                        @change="e => selectAllMirrorTargets(e.target.checked)"
                                                        :checked="allMirrorSelected"
                                                        class="rounded border-gray-300 text-blue-600 h-4 w-4"
                                                        title="Selecionar visíveis">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    ID</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    Nome / Cargo</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    Usuário Rede</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    E-mail</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    Centro de Custo</th>
                                            </tr>
                                            <!-- FILTROS DE COLUNA (ESPELHO) -->
                                            <tr class="bg-gray-50">
                                                <th class="px-2 py-1"></th>
                                                <th class="px-2 py-1"><input type="text" v-model="mirrorFilters.id"
                                                        placeholder="Filtrar ID"
                                                        class="w-11/12 text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text" v-model="mirrorFilters.nome"
                                                        placeholder="Filtrar Nome"
                                                        class="w-11/12 text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text"
                                                        v-model="mirrorFilters.user_name" placeholder="Filtrar User"
                                                        class="w-11/12 text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text" v-model="mirrorFilters.email"
                                                        placeholder="Filtrar Email"
                                                        class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text"
                                                        v-model="mirrorFilters.centro_custo" placeholder="Filtrar CC"
                                                        class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <tr v-for="u in filteredMirrorResults" :key="u.user_name"
                                                class="hover:bg-blue-50 transition-colors">
                                                <td class="px-4 py-3"><input type="checkbox" v-model="u.selected"
                                                        class="rounded border-gray-300 text-blue-600 h-4 w-4"></td>
                                                <td class="px-4 py-3 text-xs font-mono bg-gray-50">{{ u.id || '-' }}
                                                </td>
                                                <td class="px-4 py-3 text-xs">
                                                    <div class="font-bold text-gray-900">{{ toTitleCase(u.nome) }} - {{
                                                        toTitleCase(u.cargo) }}</div>
                                                </td>
                                                <td class="px-4 py-3 text-xs font-mono text-blue-700">{{ u.user_name }}
                                                </td>
                                                <td class="px-4 py-3 text-xs text-gray-600">{{ u.email ?
                                                    u.email.toLowerCase() : '-' }}</td>
                                                <td class="px-4 py-3 text-xs text-gray-500">{{ u.centro_custo }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- FINALIZAÇÃO -->
                            <div
                                class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col md:flex-row items-center justify-between gap-6">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Analista
                                        Responsável pelo Atendimento:</label>
                                    <select v-model="selectedAnalyst"
                                        class="w-full md:w-64 border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:ring-blue-500">
                                        <option value="" disabled>Selecione o analista...</option>
                                        <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                                    </select>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-500 mb-2">
                                        <b>{{ selectedTargetsCount }}</b> destino(s) selecionado(s)
                                    </div>
                                    <button @click="submitMirrorFinal"
                                        :disabled="selectedTargetsCount === 0 || !selectedAnalyst || submitting"
                                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-xl shadow-lg transition-transform hover:scale-105 disabled:opacity-50">
                                        FINALIZAR E SOLICITAR ESPELHO
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DESBLOQUEIO DE USUÁRIO TAB -->
                    <div v-if="currentTab === 'unlock' || currentTab === 'new'" class="space-y-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
                            <div class="flex flex-col gap-4">
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                        {{ searchLabel }}
                                    </label>
                                    <div class="flex flex-col sm:flex-row gap-2">
                                        <div class="relative flex-1">
                                            <div
                                                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                </svg>
                                            </div>
                                            <input type="text" v-model="searchQuery" @keyup.enter="performSearch"
                                                placeholder="Busca Coringa: Nome, ID, Usuário ou Email..."
                                                class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-9 text-sm border-gray-300 rounded-lg p-2.5 border bg-white shadow-sm">
                                        </div>
                                        <button @click="performSearch" :disabled="loading"
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold transition-all disabled:opacity-50 shadow-md flex items-center justify-center whitespace-nowrap">
                                            <svg v-if="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                                fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                    stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor"
                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                </path>
                                            </svg>
                                            {{ loading ? 'Buscando...' : 'PESQUISAR' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="hasResults" class="flex flex-wrap items-center justify-between gap-4 pb-2">
                            <div class="text-xs text-gray-400">Encontrados: {{ filteredResults.length }}</div>
                        </div>


                        <div
                            class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[400px] flex flex-col">
                            <div v-if="!hasResults && !loading"
                                class="flex-1 flex flex-col items-center justify-center p-10 text-center text-gray-400">
                                <svg class="h-16 w-16 mb-4 text-gray-200" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                                <p v-if="hasSearched">Nenhum colaborador encontrado.</p>
                                <p v-else>Use os filtros acima para encontrar colaboradores.</p>
                            </div>

                            <div v-if="hasResults" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                                <input type="checkbox" @change="toggleAll" :checked="allSelected"
                                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                                            </th>
                                            <th scope="col" @click="sortResults('id')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                ID
                                                <span v-if="resultSortColumn === 'id'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('nome')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Nome / Cargo
                                                <span v-if="resultSortColumn === 'nome'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('user_name')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Usuário Rede
                                                <span v-if="resultSortColumn === 'user_name'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('email')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Email
                                                <span v-if="resultSortColumn === 'email'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('centro_custo')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Centro de Custo
                                                <span v-if="resultSortColumn === 'centro_custo'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                        </tr>
                                        <!-- FILTROS DE COLUNA (Adjusted Width) -->
                                        <tr class="bg-gray-100">
                                            <th class="px-2 py-1"></th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.id"
                                                    placeholder="Filtrar ID"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.nome"
                                                    placeholder="Filtrar Nome"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.user_name"
                                                    placeholder="Filtrar User"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.email"
                                                    placeholder="Filtrar Email"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text"
                                                    v-model="searchFilters.centro_custo" placeholder="Filtrar CC"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr v-for="user in filteredResults" :key="user.user_name"
                                            :class="{'bg-blue-50': user.selected, 'hover:bg-gray-50': !user.selected}"
                                            class="transition-colors text-xs">
                                            <td class="px-4 py-3 whitespace-nowrap"><input type="checkbox"
                                                    v-model="user.selected"
                                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <span class="text-xs font-mono bg-gray-100 px-2 py-0.5 rounded">{{
                                                    user.id || '-' }}</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div>
                                                        <div class="font-medium text-gray-900">{{ toTitleCase(user.nome)
                                                            }}</div>
                                                        <div class="text-[10px] text-gray-500">{{
                                                            toTitleCase(user.cargo) }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div
                                                    class="text-xs text-gray-900 font-mono bg-gray-100 px-2 py-0.5 rounded inline-block">
                                                    {{ user.user_name }}</div>
                                                <span v-if="user.ja_resetado"
                                                    class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-yellow-100 text-yellow-800">Já
                                                    Resetado</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">{{ user.email
                                                ? user.email.toLowerCase() : '-' }}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">{{
                                                user.centro_custo }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentTab === 'queue'"
                        class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <h2 class="text-lg font-medium text-gray-900">Últimas Solicitações</h2>
                            <button @click="loadQueue"
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                                <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Atualizar
                            </button>
                        </div>

                        <!-- Filtros da Fila -->
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Filial</label>
                                    <select v-model="queueFilters.filial"
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                        <option value="">Todas as Filiais</option>
                                        <option v-for="filial in uniqueQueueFilials" :key="filial" :value="filial">{{
                                            filial }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Status</label>
                                    <select v-model="queueFilters.status"
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                        <option value="">Todos os Status</option>
                                        <option value="PENDENTE">PENDENTE</option>
                                        <option value="SUCESSO">SUCESSO</option>
                                        <option value="ERRO">ERRO</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Analista</label>
                                    <select v-model="queueFilters.analista"
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                        <option value="">Todos os Analistas</option>
                                        <option v-for="analista in uniqueQueueAnalysts" :key="analista"
                                            :value="analista">{{ analista }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Buscar</label>
                                    <input type="text" v-model="queueFilters.search" placeholder="Nome ou usuário..."
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                </div>
                            </div>
                        </div>

                        <div v-if="queueLoading" class="p-10 text-center text-gray-400">Carregando fila...</div>
                        <div v-else class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th @click="sortQueue('id')"
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-16">
                                            ID
                                            <span v-if="sortColumn === 'id'" class="ml-1">{{ sortDirection === 'asc' ?
                                                '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('data')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Data
                                            <span v-if="sortColumn === 'data'" class="ml-1">{{ sortDirection === 'asc' ?
                                                '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('filial')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Filial
                                            <span v-if="sortColumn === 'filial'" class="ml-1">{{ sortDirection === 'asc'
                                                ? '↑' : '↓' }}</span>
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Usuário</th>
                                        <th @click="sortQueue('analista')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Analista
                                            <span v-if="sortColumn === 'analista'" class="ml-1">{{ sortDirection ===
                                                'asc' ? '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('tipo')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Tipo
                                            <span v-if="sortColumn === 'tipo'" class="ml-1">{{ sortDirection ===
                                                'asc' ? '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('status')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Status
                                            <span v-if="sortColumn === 'status'" class="ml-1">{{ sortDirection === 'asc'
                                                ? '↑' : '↓' }}</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr v-for="item in paginatedQueue" :key="item.id || (item.data + item.user)"
                                        class="hover:bg-gray-50">
                                        <td
                                            class="px-4 py-4 whitespace-nowrap text-sm font-mono text-gray-600 bg-gray-50">
                                            #{{ item.id || '-' }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{
                                            formatDate(item.data) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.filial }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">{{ toTitleCase(item.nome) }}
                                            </div>
                                            <div class="text-xs text-gray-500">{{ item.user }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.analista
                                            }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="{
                                                    'bg-blue-100 text-blue-800': item.tipo === 'RESET' || item.tipo === 'RESET_SENHA',
                                                    'bg-green-100 text-green-800': item.tipo === 'UNLOCK' || item.tipo === 'DESBLOQUEIO_CONTA' || item.tipo === 'DESBLOQUEIO',
                                                    'bg-purple-100 text-purple-800': item.tipo === 'MIRROR' || item.tipo === 'ESPELHO_USUARIO'
                                                }"
                                                class="px-2 inline-flex text-[10px] leading-5 font-bold rounded-full border border-current opacity-80 uppercase tracking-tighter">
                                                {{ item.tipo || 'RESET' }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span
                                                :class="{'bg-yellow-100 text-yellow-800': item.status === 'PENDENTE', 'bg-green-100 text-green-800': item.status === 'SUCESSO', 'bg-red-100 text-red-800': item.status === 'ERRO'}"
                                                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">{{
                                                item.status }}</span>
                                        </td>


                                    </tr>
                                    <tr v-if="paginatedQueue.length === 0">
                                        <td colspan="6" class="px-6 py-10 text-center text-gray-400">Nenhum registro
                                            encontrado com os filtros selecionados.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginação -->
                        <div v-if="!queueLoading && filteredQueue.length > 0"
                            class="p-4 bg-gray-50 border-t border-gray-200 flex justify-center items-center">
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-widest">
                                Total Geral na Fila: {{ filteredQueue.length }} Colaboradores
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BITLOCKER TAB -->
                <div v-if="currentTab === 'bitlocker'" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            Recuperação de Chaves BitLocker
                        </h2>
                        <p class="text-sm text-gray-500 mb-6">Consulte a chave de recuperação (Recovery Key) de estações
                            de trabalho
                            consultando o Active Directory em tempo real. <!-- v1.5.3 Fix --> </p>

                        <div class="space-y-4">
                            <!-- Step 1: Requester Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Solicitante
                                        (ID, Nome, Usuário ou Email)</label>
                                    <div class="flex gap-2">
                                        <input type="text" v-model="bitlockerUserId"
                                            @keyup.enter="fetchBitlockerUserInfo" placeholder="Busca inteligente..."
                                            class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                                        <button @click="fetchBitlockerUserInfo" :disabled="bitlockerSearchingUser"
                                            class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all flex items-center">
                                            <svg v-if="bitlockerSearchingUser" class="animate-spin h-4 w-4" fill="none"
                                                viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                    stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor"
                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                </path>
                                            </svg>
                                            <svg v-else class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div v-if="bitlockerUserFound"
                                        class="mt-2 p-2 bg-green-50 rounded border border-green-100 animate-fade-in">
                                        <p class="text-[10px] text-green-700 font-bold uppercase tracking-tight">
                                            ✅ {{ bitlockerUserFound.nome }}
                                        </p>
                                        <p class="text-[9px] text-green-600">
                                            {{ bitlockerUserFound.filial }} | {{ bitlockerUserFound.user_name }}
                                        </p>
                                    </div>
                                </div>
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Hostname
                                        ou ID de Recuperação (8 dígitos)</label>
                                    <input type="text" v-model="bitlockerHostname"
                                        placeholder="Ex: W123ANX123RU ou 89107B05"
                                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 uppercase">
                                    <p class="mt-1 text-[9px] text-gray-400">Insira o Hostname OU os 8 primeiros dígitos
                                        do ID da Senha.</p>
                                </div>
                            </div>

                            <!-- Step 2: Analyst Selection -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Analista
                                        que receberá a chave</label>
                                    <select v-model="bitlockerAnalyst"
                                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                                        <option value="" disabled>Selecione o Analista...</option>
                                        <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button @click="requestBitlocker"
                                    :disabled="bitlockerLoading || !bitlockerHostname || !bitlockerAnalyst || !bitlockerUserId"
                                    class="w-full sm:w-auto bg-gray-800 hover:bg-black text-white px-10 py-3 rounded-xl text-sm font-bold transition-all disabled:opacity-50 shadow-lg flex items-center justify-center gap-2 transform hover:scale-105 active:scale-95">
                                    <svg v-if="bitlockerLoading" class="animate-spin h-5 w-5 text-white" fill="none"
                                        viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                    SOLICITAR RECUPERAÇÃO
                                </button>
                            </div>
                        </div>

                        <!-- Status Message -->
                        <div v-if="bitlockerLoading"
                            class="mt-6 flex items-center justify-center p-8 bg-gray-50 rounded-lg border border-gray-100 flex-col gap-3">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <p class="text-sm text-gray-600">{{ bitlockerStatusMsg }}</p>
                            <p class="text-xs text-gray-400">Isso pode levar até 60 segundos.</p>
                        </div>

                        <!-- Result -->
                        <div v-if="bitlockerRes" class="mt-8 animate-fade-in">
                            <div class="border-l-4 border-green-500 bg-green-50 p-6 rounded-r-lg shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-bold text-green-800 mb-1">Chave Encontrada!</h3>
                                        <p class="text-sm text-green-700 mb-4">Hostname Identificado: <b>{{
                                                bitlockerRes.hostname
                                                }}</b></p>
                                    </div>
                                    <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded font-mono">{{
                                        bitlockerRes.passwordId ? 'ID: ' + bitlockerRes.passwordId.substring(0,8)
                                        + '...' : ''
                                        }}</span>
                                </div>

                                <div
                                    class="bg-white border border-green-100 rounded-lg p-4 mt-2 relative overflow-hidden group">
                                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-1">Recovery
                                        Key</label>
                                    <div
                                        class="font-mono text-2xl tracking-wider text-gray-800 break-all selection:bg-green-200">
                                        <span v-if="bitlockerShowKey">{{ bitlockerRes.recoveryKey }}</span>
                                        <span v-else
                                            class="text-gray-300 select-none">••••••-••••••-••••••-••••••-••••••-••••••-••••••-••••••</span>
                                    </div>

                                    <button @click="bitlockerShowKey = !bitlockerShowKey"
                                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-all"
                                        title="Mostrar/Ocultar">
                                        <svg v-if="!bitlockerShowKey" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                        <svg v-else class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.059 10.059 0 013.999-5.325m2.597-1.626a9.006 9.006 0 014.288-1.049c4.478 0 8.268 2.943 9.542 7a10.06 10.06 0 01-1.093 3.03M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 3l18 18" />
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-xs text-green-600 mt-2 text-right">⚠️ Confirme a identidade do
                                    solicitante antes de
                                    informar a chave.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WMS TAB (v1.7.0) -->
                <div v-if="currentTab === 'wms'" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                            </svg>
                            Cancelamento de Filas de Impressão WMS
                        </h2>
                        <p class="text-sm text-gray-500 mb-6">
                            Solicite o cancelamento de trabalhos de impressão pendentes no cluster WMS.
                        </p>

                        <div class="space-y-6">
                            <!-- Solicitante -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                        Solicitante (ID, Nome, Usuário ou Email)
                                    </label>
                                    <div class="flex gap-2">
                                        <input type="text" v-model="wmsUserId" @keyup.enter="fetchWmsUserInfo"
                                            placeholder="Busca inteligente..."
                                            class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                                        <button @click="fetchWmsUserInfo" :disabled="wmsSearchingUser"
                                            class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all flex items-center">
                                            <svg v-if="wmsSearchingUser" class="animate-spin h-4 w-4" fill="none"
                                                viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                    stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor"
                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                            </svg>
                                            <svg v-else class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div v-if="wmsUserFound"
                                        class="mt-2 p-2 bg-green-50 rounded border border-green-100 animate-fade-in">
                                        <p class="text-xs text-green-700 font-bold uppercase tracking-tight">✅ {{
                                            wmsUserFound.nome }}</p>
                                        <p class="text-xs text-green-600">{{ wmsUserFound.filial }} | {{
                                            wmsUserFound.user_name }}</p>
                                    </div>
                                </div>
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                        Filtro de Impressora (Filial)
                                    </label>
                                    <input type="text" v-model="wmsPrinterFilter"
                                        placeholder="Digite para filtrar impressoras..."
                                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 uppercase">
                                </div>
                            </div>

                            <!-- Seleção Fila -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                        Fila de Impressão
                                    </label>
                                    <select v-model="wmsQueueName"
                                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                                        <option value="" disabled>Selecione a Fila...</option>
                                        <option v-for="printer in filteredWmsPrinters" :key="printer" :value="printer">
                                            {{ printer }}</option>
                                    </select>
                                    <p class="mt-1 text-xs text-gray-400">{{ wmsPrinterCache.length }} impressoras
                                        disponíveis</p>
                                </div>
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                        Analista Responsável
                                    </label>
                                    <select v-model="wmsAnalyst"
                                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                                        <option value="" disabled>Selecione o Analista...</option>
                                        <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Justificativa -->
                            <div class="border-b pb-6">
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                    Justificativa (Obrigatório)
                                </label>
                                <textarea v-model="wmsJustification" rows="3"
                                    placeholder="Descreva o motivo da solicitação de limpeza da fila..."
                                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 resize-none"></textarea>
                            </div>

                            <!-- Botão -->
                            <div class="flex justify-end">
                                <button @click="submitWmsRequest"
                                    :disabled="wmsLoading || !wmsUserFound || !wmsQueueName || !wmsAnalyst || !wmsJustification"
                                    class="w-full sm:w-auto bg-orange-600 hover:bg-orange-700 text-white px-10 py-3 rounded-xl text-sm font-bold transition-all disabled:opacity-50 shadow-lg flex items-center justify-center gap-2">
                                    <svg v-if="wmsLoading" class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                    </svg>
                                    SOLICITAR LIMPEZA DE FILA
                                </button>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div v-if="wmsLoading"
                            class="mt-6 flex items-center justify-center p-8 bg-orange-50 rounded-lg border border-orange-100 flex-col gap-3">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                            <p class="text-sm text-orange-700">{{ wmsStatusMsg || 'Processando...' }}</p>
                        </div>

                        <!-- Success -->
                        <div v-if="wmsSuccess"
                            class="mt-6 border-l-4 border-green-500 bg-green-50 p-6 rounded-r-lg shadow-sm animate-fade-in">
                            <h3 class="text-lg font-bold text-green-800 mb-1">Solicitação Registrada!</h3>
                            <p class="text-sm text-green-700">A solicitação de limpeza foi enviada para aprovação.</p>
                            <p class="text-xs text-green-600 mt-2">ID: <span class="font-mono">{{ wmsRequestId }}</span>
                            </p>
                        </div>
                    </div>
                </div>

            </main>

            <footer v-if="currentTab === 'new' || currentTab === 'unlock'"
                class="bg-white border-t border-gray-200 p-3 sm:p-4 shadow-lg-up z-20">
                <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-gray-500 order-2 sm:order-1">
                        <span v-if="selectedCount > 0" class="font-bold text-blue-600">{{ selectedCount }}</span>
                        selecionado(s).
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto order-1 sm:order-2">
                        <div class="w-full sm:w-auto">
                            <label
                                class="hidden sm:inline text-xs font-semibold text-gray-500 mr-2 uppercase">Analista:</label>
                            <select v-model="selectedAnalyst"
                                class="w-full sm:w-auto text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 bg-gray-50">
                                <option value="" disabled>Selecione o Analista...</option>
                                <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                            </select>
                        </div>
                        <button @click="openConfirmModal"
                            :disabled="selectedCount === 0 || submitting || !selectedAnalyst"
                            class="w-full sm:w-auto bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white font-bold py-2.5 px-8 rounded-lg shadow-md transition-all">
                            {{ submitActionLabel }}
                        </button>
                    </div>
                </div>
            </footer>

            <div class="bg-gray-100 text-center py-2 text-xs text-gray-400 border-t border-gray-200">
                Leandro Araújo - Suporte Infra CDs
            </div>

            <div v-show="isConfirmModalVisible" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                    <div
                        class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmação</h3>
                        <div class="mt-4 text-left bg-gray-50 p-4 rounded-md border border-gray-200">
                            <p class="text-sm text-gray-600 mb-2">Solicitando reset para:</p>
                            <p class="text-2xl font-bold text-gray-900">{{ selectedCount }} colaboradores</p>
                            <p class="mt-2 text-sm text-gray-600">Analista: <b>{{ selectedAnalyst }}</b></p>
                        </div>
                        <div class="mt-5 sm:mt-6 flex flex-col-reverse sm:flex-row sm:gap-3">
                            <button @click="isConfirmModalVisible = false"
                                class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:text-sm">Cancelar</button>
                            <button @click="confirmAndSend"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:text-sm">Confirmar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="isSuccessModalVisible" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                    <div
                        class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full sm:p-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Solicitação Enviada!</h3>
                            <button @click="downloadReceipt"
                                class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-blue-700 bg-blue-100 hover:bg-blue-200">Baixar
                                Comprovante</button>
                        </div>
                        <div class="mt-5 sm:mt-6">
                            <button @click="resetForm"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-700 sm:text-sm">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>



    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ==========================================
                // CONFIGURAÇÃO DA LOGO
                // ==========================================
                // Cole o código Base64 da sua imagem (sem fundo) entre as aspas abaixo:
                const appLogo = "<?= LOGO_BASE64 ?>";
                // Exemplo: "data:image/png;base64,iVBORw0K..."

                // Auth State
                const currentView = ref('login');
                const isLoading = ref(false);
                const authForm = ref({ errorMessage: '' });


                // App State
                const currentTab = ref('new');
                const filiais = ref([]);
                const analystList = ref([]);
                const userEmail = ref('');
                const userInitials = ref('');
                const userName = ref('');
                const userFilial = ref('');
                const userCostCenter = ref('');
                const bitlockerHostname = ref('');
                const selectedFilial = ref('');
                const selectedAnalyst = ref('');
                const bitlockerAnalyst = ref('');
                const searchQuery = ref('');
                const searchResults = ref([]);
                const loading = ref(false);
                const submitting = ref(false);
                const isSuccessModalVisible = ref(false);
                const isConfirmModalVisible = ref(false);
                const lastRequestData = ref(null);
                const queueData = ref([]);
                const queueLoading = ref(false);
                const selectedCostCenter = ref('');

                // BitLocker v1.5.1 State
                const bitlockerUserId = ref('');
                const bitlockerPasswordId = ref('');
                const bitlockerUserFound = ref(null);
                const bitlockerSearchingUser = ref(false);

                // Mirror State
                const mirrorForm = ref({ modelUser: '' });
                const mirrorGroups = ref([]);
                const mirrorLoading = ref(false);
                const mirrorStatusMsg = ref('');
                const mirrorPollInterval = ref(null);

                // Estados para filtros e paginação da fila
                const queueFilters = ref({ filial: '', status: '', analista: '', search: '' });
                const currentPage = ref(1);
                const itemsPerPage = ref(25);
                const sortColumn = ref('data');
                const sortDirection = ref('desc');

                // Estados para ordenação dos resultados de busca
                const resultSortColumn = ref('nome');
                const resultSortDirection = ref('asc');

                // DATA FILTERS (v1.4.0)
                // DATA FILTERS (v1.4.0)
                console.log("Version 1.6.6 (Daemon v5.9 Multi-Env) Loaded");
                const searchFilters = ref({ id: '', nome: '', user_name: '', email: '', centro_custo: '' });
                const mirrorFilters = ref({ id: '', nome: '', user_name: '', email: '', centro_custo: '' });

                const bitlockerLoading = ref(false);
                const bitlockerRes = ref(null);
                const bitlockerStatusMsg = ref('');
                const bitlockerShowKey = ref(false);
                const bitlockerPollInterval = ref(null);

                const rememberMe = ref(false);

                // WMS Print Clean State (v1.7.0)
                const wmsUserId = ref('');
                const wmsUserFound = ref(null);
                const wmsSearchingUser = ref(false);
                const wmsQueueName = ref('');
                const wmsPrinterFilter = ref('');
                const wmsAnalyst = ref('');
                const wmsJustification = ref('');
                const wmsPrinterCache = ref([]);
                const wmsLoading = ref(false);
                const wmsStatusMsg = ref('');
                const wmsSuccess = ref(false);
                const wmsRequestId = ref('');

                // --- AUTH METHODS ---
                const handleLogin = () => {
                    isLoading.value = true;
                    authForm.value.errorMessage = '';

                    google.script.run.withSuccessHandler(res => {
                        isLoading.value = false;
                        if (res.success) {
                            userEmail.value = res.token;
                            userInitials.value = res.name ? res.name.substring(0, 2).toUpperCase() : 'EU';
                            userName.value = res.name || '';
                            userFilial.value = res.filial || '';
                            userCostCenter.value = res.centro_custo || '';
                            initApp();
                        }
                    }).withFailureHandler(err => {
                        isLoading.value = false;
                        authForm.value.errorMessage = err.message;
                    }).loginWithGoogle();
                };

                // Auto-login if session persists (Optional optimization)
                onMounted(() => {
                    // We could trigger handleLogin() automatically if we wanted SSO-like experience
                    // handleLogin();
                    // But user explicitly asked for "Entrar com Google" button, so we wait for click.
                });

                const initApp = () => {
                    currentView.value = 'app';
                    google.script.run.withSuccessHandler(l => filiais.value = l).getFiliaisList();

                    // v1.5.0: Use Optimized API for Analysts
                    const handleAnalysts = (l) => {
                        if (l && l.length > 0 && typeof l[0] === 'object') {
                            analystObjects.value = l;
                            analystList.value = l.map(a => a.name).sort();
                        } else {
                            analystList.value = Array.isArray(l) ? l.sort() : [];
                        }
                    };

                    if (google.script.run.getAnalystsListAPI) {
                        google.script.run.withSuccessHandler(handleAnalysts).getAnalystsListAPI();
                    } else {
                        google.script.run.withSuccessHandler(handleAnalysts).getAnalystsList();
                    }

                    // v1.7.0: Carrega cache de impressoras WMS
                    loadWmsPrinterCache();
                };

                const logout = () => {
                    userEmail.value = '';
                    currentView.value = 'login';
                    authForm.value = { errorMessage: '' };
                };

                // --- APP METHODS ---
                const performSearch = () => {
                    if (!searchQuery.value) {
                        alert("Por favor, informe um termo de busca.");
                        return;
                    }
                    loading.value = true;
                    searchResults.value = [];
                    google.script.run.withSuccessHandler(res => {
                        searchResults.value = res.map(u => ({ ...u, selected: false }));
                        loading.value = false;
                    }).withFailureHandler(e => {
                        alert(e.message);
                        loading.value = false;
                    }).searchUserBQ(searchQuery.value);
                };

                // Função para ordenar resultados de busca
                const sortResults = (column) => {
                    if (resultSortColumn.value === column) {
                        resultSortDirection.value = resultSortDirection.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        resultSortColumn.value = column;
                        resultSortDirection.value = 'asc';
                    }
                };

                const confirmAndSend = () => {
                    isConfirmModalVisible.value = false;
                    const selected = filteredResults.value.filter(u => u.selected); // Changed to filteredResults
                    submitting.value = true;
                    const taskType = currentTab.value === 'unlock' ? 'DESBLOQUEIO_CONTA' : 'RESET';
                    const data = {
                        users: selected,
                        analyst: selectedAnalyst.value,
                        requester: userEmail.value,
                        task_type: taskType
                    };
                    lastRequestData.value = data;
                    google.script.run.withSuccessHandler(() => {
                        submitting.value = false;
                        isSuccessModalVisible.value = true;
                        // O modal de sucesso já tem mensagem genérica, vamos manter, mas talvez atualizar o texto do modal no HTML se necessário. 
                        // Vou assumir que o alerta abaixo ou o modal é suficiente. O código original usava isSuccessModalVisible = true.
                        // Vamos adicionar um alert explicativo antes ou confiar no modal.
                        // O modal HTML deve ser ajustado. Como não vi o HTML do modal, vou manter apenas isSuccessModalVisible = true
                        // e adicionar um alert extra para garantir a comunicação clara se o modal não for explicativo o bastante.
                        alert("Solicitação enviada com sucesso! \n\nAssim que um analista aprovar via e-mail, o sistema processará seu pedido automaticamente.");

                        searchResults.value = [];
                        selectedFilial.value = '';
                        searchQuery.value = '';
                        selectedAnalyst.value = '';
                    }).withFailureHandler(e => {
                        submitting.value = false;
                        alert("Erro: " + e.message);
                    }).submitResetQueue(data);
                };

                // --- MIRROR METHODS ---
                const mirrorStep = ref(1);
                const mirrorSearchQuery = ref('');
                const mirrorSearchResults = ref([]);
                const mirrorSearchLoading = ref(false);

                const fetchMirrorGroups = () => {
                    if (!mirrorForm.value.modelUser) return;

                    const inputValue = mirrorForm.value.modelUser.trim();

                    // Detecta se é matrícula (apenas números)
                    if (/^\d+$/.test(inputValue)) {
                        mirrorLoading.value = true;
                        mirrorStatusMsg.value = 'Convertendo matrícula em username...';

                        // Busca o username no BigQuery usando a matrícula
                        google.script.run.withSuccessHandler(results => {
                            if (results && results.length > 0) {
                                const user = results[0];
                                mirrorForm.value.modelUser = user.user_name;
                                mirrorStatusMsg.value = `Username encontrado: ${user.user_name}`;

                                // Aguarda 1 segundo para o usuário ver a conversão
                                setTimeout(() => {
                                    proceedWithMirrorRequest();
                                }, 1000);
                            } else {
                                mirrorLoading.value = false;
                                mirrorStatusMsg.value = '';
                                alert('Matrícula não encontrada no sistema. Verifique o ID e tente novamente.');
                            }
                        }).withFailureHandler(e => {
                            mirrorLoading.value = false;
                            mirrorStatusMsg.value = '';
                            alert('Erro ao buscar matrícula: ' + e.message);
                        }).searchUserBQ(inputValue);
                    } else {
                        // Se não for matrícula, procede normalmente
                        proceedWithMirrorRequest();
                    }
                };

                const proceedWithMirrorRequest = () => {
                    mirrorLoading.value = true;
                    mirrorGroups.value = [];
                    mirrorStatusMsg.value = 'Iniciando solicitação ao agente...';

                    google.script.run.withSuccessHandler(res => {
                        if (res.success) {
                            pollMirrorStatus(res.requestId);
                        } else {
                            mirrorLoading.value = false;
                            alert('Erro ao iniciar: ' + res.message);
                        }
                    }).withFailureHandler(e => {
                        mirrorLoading.value = false;
                        alert('Falha: ' + e.message);
                    }).submitMirrorRequest(mirrorForm.value.modelUser, userEmail.value);
                };

                const pollMirrorStatus = (reqId) => {
                    let attempts = 0;
                    // 60 tentativas de 1s = 60 segundos
                    const maxAttempts = 60;
                    if (mirrorPollInterval.value) clearInterval(mirrorPollInterval.value);

                    mirrorPollInterval.value = setInterval(() => {
                        attempts++;
                        mirrorStatusMsg.value = `Aguardando grupos do AD... (${attempts}s / ${maxAttempts}s)`;

                        google.script.run.withSuccessHandler(res => {
                            if (res.status === 'CONCLUIDO') {
                                clearInterval(mirrorPollInterval.value);
                                mirrorLoading.value = false;
                                mirrorStatusMsg.value = '';
                                mirrorGroups.value = res.groups.map(g => ({ name: g, selected: true }));
                            } else if (res.status === 'ERRO') {
                                clearInterval(mirrorPollInterval.value);
                                mirrorLoading.value = false;
                                mirrorStatusMsg.value = '';
                                alert('Erro no AD: ' + res.message);
                            }
                        }).withFailureHandler(e => {
                            console.error("Poll Error:", e);
                            // Não para o polling por erro de rede pontual
                        }).checkMirrorStatus(reqId);

                        if (attempts >= maxAttempts) {
                            clearInterval(mirrorPollInterval.value);
                            mirrorLoading.value = false;
                            mirrorStatusMsg.value = '';
                            if (confirm('O tempo limite foi atingido. O agente local pode estar offline. Deseja tentar novamente?')) {
                                fetchMirrorGroups();
                            }
                        }
                    }, 1000);
                };

                const cancelMirrorPoll = () => {
                    if (mirrorPollInterval.value) clearInterval(mirrorPollInterval.value);
                    mirrorLoading.value = false;
                    mirrorStatusMsg.value = '';
                };

                const performMirrorSearch = () => {
                    if (!mirrorSearchQuery.value) return;
                    mirrorSearchLoading.value = true;
                    google.script.run.withSuccessHandler(res => {
                        mirrorSearchResults.value = res.map(u => ({ ...u, selected: false }));
                        mirrorSearchLoading.value = false;
                    }).withFailureHandler(e => {
                        mirrorSearchLoading.value = false;
                        alert(e.message);
                    }).searchUserBQ(mirrorSearchQuery.value);
                };

                const selectAllGroups = (val) => {
                    mirrorGroups.value.forEach(g => g.selected = val);
                };

                // NEW: Select All Visible Targets (Mirror)
                const selectAllMirrorTargets = (val) => {
                    filteredMirrorResults.value.forEach(u => u.selected = val);
                };

                const selectedGroupsCount = computed(() => mirrorGroups.value.filter(g => g.selected).length);
                const selectedTargetsCount = computed(() => filteredMirrorResults.value.filter(u => u.selected).length); // Use Filtered

                const submitMirrorFinal = () => {
                    // FIX v1.3.6: Envia objetos completos para popular colunas nas Solicitações
                    // CHANGE v1.4.0: Use filteredMirrorResults instead of full list to respect user filters? Or just check selected?
                    // Usually we only send SELECTED users. The filter is just for VIEW/SELECTION.
                    // But 'selectAllMirrorTargets' only selects VISIBLE ones.
                    // So we iterate over mirrorSearchResults (the full list) and pick selected ones.
                    const targets = mirrorSearchResults.value.filter(u => u.selected).map(u => ({
                        user_name: u.user_name,
                        nome: u.nome,
                        email: u.email,
                        centro_custo: u.centro_custo,
                        filial: u.filial // CORREÇÃO v1.4.1: Enviar Filial real
                    }));
                    const groups = mirrorGroups.value.filter(g => g.selected).map(g => g.name);

                    if (targets.length === 0) return alert("Selecione ao menos um usuário de destino.");
                    if (!selectedAnalyst.value) return alert("Selecione um analista responsável.");

                    submitting.value = true;
                    google.script.run.withSuccessHandler(res => {
                        submitting.value = false;
                        alert("Solicitação de espelhamento enviada para APROVAÇÃO TÉCNICA! \n\nO analista selecionado foi notificado para validar a requisição. O processamento ocorrerá automaticamente após a aprovação.");
                        resetMirror();
                    }).withFailureHandler(e => {
                        submitting.value = false;
                        alert("Erro ao enviar: " + e.message);
                    }).submitMirrorExecution({
                        modelUser: mirrorForm.value.modelUser,
                        groups: groups,
                        targets: targets,
                        analyst: selectedAnalyst.value,
                        requester: userEmail.value
                    });
                };

                const resetMirror = () => {
                    mirrorStep.value = 1;
                    mirrorForm.value.modelUser = '';
                    mirrorGroups.value = [];
                    mirrorSearchResults.value = [];
                    mirrorSearchQuery.value = '';
                    mirrorFilters.value = { id: '', nome: '', user_name: '', email: '', centro_custo: '' }; // Reset filters
                    currentTab.value = 'queue';
                    loadQueue();
                };

                // --- BITLOCKER METHODS ---
                // --- BITLOCKER METHODS ---
                const analystObjects = ref([]); // Store {name, email}

                const fetchBitlockerUserInfo = () => {
                    if (!bitlockerUserId.value) return;
                    bitlockerSearchingUser.value = true;
                    bitlockerUserFound.value = null;
                    google.script.run.withSuccessHandler(res => {
                        bitlockerSearchingUser.value = false;
                        if (res && res.length > 0) {
                            bitlockerUserFound.value = res[0];
                        } else {
                            alert("Colaborador não encontrado com o termo informado.");
                        }
                    }).withFailureHandler(e => {
                        bitlockerSearchingUser.value = false;
                        alert("Erro ao buscar colaborador: " + e.message);
                    }).searchUserBQ(bitlockerUserId.value);
                };

                const requestBitlocker = () => {
                    if (!bitlockerHostname.value || !bitlockerAnalyst.value || !bitlockerUserFound.value) {
                        return alert('Preencha o solicitante, o hostname/ID e o analista.');
                    }

                    // Se o valor tiver 8 caracteres e for alfanumérico sem caracteres especiais, 
                    // tratamos como PasswordID. Se não, como Hostname vindo do AD.
                    // O Daemon fará a inteligência final.
                    let finalHostname = bitlockerHostname.value.trim().toUpperCase();
                    let finalPasswordId = "";

                    if (finalHostname.length === 8 && /^[A-Z0-9]+$/.test(finalHostname)) {
                        finalPasswordId = finalHostname; // Provável ID de Senha
                    }

                    // Find Analyst Email
                    const selectedObj = analystObjects.value.find(a => a.name === bitlockerAnalyst.value);
                    const analystEmail = selectedObj ? selectedObj.email : bitlockerAnalyst.value;

                    bitlockerLoading.value = true;
                    bitlockerRes.value = null;
                    bitlockerStatusMsg.value = "Enviando solicitação para o Agente AD...";

                    google.script.run
                        .withSuccessHandler((response) => {
                            bitlockerLoading.value = false;
                            if (response.success) {
                                bitlockerStatusMsg.value = "";
                                alert(`Solicitação #${response.requestId} registrada! \n\nA chave será enviada por e-mail para ${bitlockerAnalyst.value}.`);
                                // Reset fields
                                bitlockerHostname.value = "";
                                bitlockerUserId.value = "";
                                bitlockerUserFound.value = null;
                            } else {
                                alert("Erro: " + response.message);
                            }
                        })
                        .withFailureHandler((err) => {
                            bitlockerLoading.value = false;
                            alert("Erro de comunicação: " + err.message);
                        })
                        .submitBitlockerRequest({
                            hostname: finalHostname,
                            passwordId: finalPasswordId,
                            analyst: bitlockerAnalyst.value,
                            analystEmail: analystEmail,
                            requester: userEmail.value,
                            userData: bitlockerUserFound.value
                        });
                };

                // Removed pollBitlocker as Key is not returned to Frontend anymore.


                const switchTab = (tabName) => {
                    console.log("Switching tab to:", tabName);
                    currentTab.value = tabName;
                };

                const loadQueue = () => {
                    switchTab('queue');
                    queueLoading.value = true;
                    google.script.run.withSuccessHandler(res => {
                        queueData.value = res;
                        queueLoading.value = false;
                    }).withFailureHandler(e => queueLoading.value = false).getQueueWeb();
                };

                // --- DOWNLOAD CSV (Lógica Real) ---
                const downloadReceipt = () => {
                    // 1. Validar se tem dados
                    if (!lastRequestData.value || !lastRequestData.value.users) {
                        alert("Nenhum dado para exportar.");
                        return;
                    }

                    const request = lastRequestData.value;
                    const timestamp = new Date().toLocaleString('pt-BR');

                    // 2. Cabeçalho do CSV
                    let csvContent = "Data;Filial;Nome Colaborador;Usuario Rede;Email;Centro Custo;Analista Responsavel;Solicitante\n";

                    // 3. Iterar sobre os usuários e montar as linhas
                    request.users.forEach(user => {
                        const row = [
                            timestamp,
                            request.filial,
                            user.nome,
                            user.user_name,
                            user.email || "-",
                            user.centro_custo,
                            request.analyst,
                            request.requester
                        ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(";"); // Escape de aspas e uso de ; para Excel BR

                        csvContent += row + "\n";
                    });

                    // 4. Criar o Blob com BOM para acentuação funcionar no Excel
                    const bom = "\uFEFF";
                    const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8;" });

                    // 5. Criar link invisível e clicar
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `Comprovante_Reset_${Date.now()}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                // Helpers
                const toTitleCase = (str) => String(str).replace(/_/g, ' ').toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

                const formatDate = (d) => {
                    if (!d) return '-';
                    const dateObj = new Date(d);
                    if (isNaN(dateObj.getTime())) return String(d);
                    return dateObj.toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                };

                const toggleAll = () => { const s = !allSelected.value; filteredResults.value.forEach(u => u.selected = s); };
                const openConfirmModal = () => isConfirmModalVisible.value = true;
                const resetForm = () => { isSuccessModalVisible.value = false; searchResults.value = []; currentTab.value = 'queue'; loadQueue(); };

                // Métodos de ordenação e paginação
                const sortQueue = (column) => {
                    if (sortColumn.value === column) {
                        sortDirection.value = sortDirection.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn.value = column;
                        sortDirection.value = 'desc';
                    }
                };

                const changePage = (page) => {
                    // Sem limites! Mas mantemos a lógica de página se quiserem usar, 
                    // porém por padrão exibimos todos.
                    if (page >= 1 && page <= totalPages.value) {
                        currentPage.value = page;
                    }
                };

                // Removemos o limite da fila para v1.1.3
                onMounted(() => {
                    itemsPerPage.value = 5000;
                });

                // Computed
                const uniqueCostCenters = computed(() => [...new Set(searchResults.value.map(u => u.centro_custo))].sort());

                // FILTER LOGIC (v1.4.0)
                const filterList = (list, filters, sortCol, sortDir) => {
                    let res = list;
                    // Column Filters
                    if (filters.id) res = res.filter(u => String(u.id || '').toLowerCase().includes(filters.id.toLowerCase()));
                    if (filters.nome) res = res.filter(u => (String(u.nome || '') + ' ' + String(u.cargo || '')).toLowerCase().includes(filters.nome.toLowerCase()));
                    if (filters.user_name) res = res.filter(u => String(u.user_name || '').toLowerCase().includes(filters.user_name.toLowerCase()));
                    if (filters.email) res = res.filter(u => String(u.email || '').toLowerCase().includes(filters.email.toLowerCase()));
                    if (filters.centro_custo) res = res.filter(u => String(u.centro_custo || '').toLowerCase().includes(filters.centro_custo.toLowerCase()));

                    // Sort
                    return [...res].sort((a, b) => {
                        let aVal = a[sortCol];
                        let bVal = b[sortCol];
                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                        const direction = sortDir === 'asc' ? 1 : -1;
                        if (aVal > bVal) return direction;
                        if (aVal < bVal) return -direction;
                        return 0;
                    });
                };

                const filteredResults = computed(() => {
                    // Apply column filters
                    // REMOVED: selectedCostCenter (Quick Filter)
                    let results = searchResults.value;
                    return filterList(results, searchFilters.value, resultSortColumn.value, resultSortDirection.value);
                });

                const filteredMirrorResults = computed(() => {
                    return filterList(mirrorSearchResults.value, mirrorFilters.value, 'nome', 'asc');
                });

                const hasResults = computed(() => searchResults.value.length > 0);
                const selectedCount = computed(() => filteredResults.value.filter(u => u.selected).length); // Use filtered
                const allSelected = computed(() => filteredResults.value.length > 0 && filteredResults.value.every(u => u.selected));
                const allMirrorSelected = computed(() => filteredMirrorResults.value.length > 0 && filteredMirrorResults.value.every(u => u.selected));

                // Computed properties para filtros da fila
                const uniqueQueueFilials = computed(() => [...new Set(queueData.value.map(item => item.filial))].sort());
                const uniqueQueueAnalysts = computed(() => [...new Set(queueData.value.map(item => item.analista))].filter(a => a).sort());

                const filteredQueue = computed(() => {
                    let filtered = queueData.value;

                    // Filtro por filial
                    if (queueFilters.value.filial) {
                        filtered = filtered.filter(item => item.filial === queueFilters.value.filial);
                    }

                    // Filtro por status
                    if (queueFilters.value.status) {
                        filtered = filtered.filter(item => item.status === queueFilters.value.status);
                    }

                    // Filtro por analista
                    if (queueFilters.value.analista) {
                        filtered = filtered.filter(item => item.analista === queueFilters.value.analista);
                    }

                    // Busca por nome/usuário
                    if (queueFilters.value.search) {
                        const search = queueFilters.value.search.toLowerCase();
                        filtered = filtered.filter(item =>
                            (item.nome && item.nome.toLowerCase().includes(search)) ||
                            (item.user && item.user.toLowerCase().includes(search))
                        );
                    }

                    // Ordenação
                    filtered = [...filtered].sort((a, b) => {
                        let aVal = a[sortColumn.value];
                        let bVal = b[sortColumn.value];

                        // Tratamento especial para datas
                        if (sortColumn.value === 'data') {
                            aVal = new Date(aVal).getTime() || 0;
                            bVal = new Date(bVal).getTime() || 0;
                        }

                        const direction = sortDirection.value === 'asc' ? 1 : -1;
                        if (aVal > bVal) return direction;
                        if (aVal < bVal) return -direction;
                        return 0;
                    });

                    return filtered;
                });

                const paginatedQueue = computed(() => {
                    const start = (currentPage.value - 1) * itemsPerPage.value;
                    const end = start + itemsPerPage.value;
                    return filteredQueue.value.slice(start, end);
                });

                const totalPages = computed(() => Math.ceil(filteredQueue.value.length / itemsPerPage.value) || 1);

                const searchLabel = computed(() => currentTab.value === 'new' ? 'Busca para Reset de Senha' : 'Busca para Desbloqueio de Conta');
                const submitActionLabel = computed(() => {
                    if (submitting.value) return 'Enviando...';
                    return currentTab.value === 'new' ? 'SOLICITAR RESET' : 'SOLICITAR DESBLOQUEIO';
                });

                // WMS Functions (v1.7.0)
                const filteredWmsPrinters = computed(() => {
                    if (!wmsPrinterFilter.value) return wmsPrinterCache.value;
                    const filter = wmsPrinterFilter.value.toUpperCase();
                    return wmsPrinterCache.value.filter(p => p.toUpperCase().includes(filter));
                });

                const loadWmsPrinterCache = () => {
                    google.script.run.withSuccessHandler(res => {
                        wmsPrinterCache.value = res || [];
                    }).withFailureHandler(e => {
                        console.error('Erro ao carregar impressoras WMS:', e.message);
                    }).getWmsPrinterCache();
                };

                const fetchWmsUserInfo = () => {
                    if (!wmsUserId.value) return;
                    wmsSearchingUser.value = true;
                    wmsUserFound.value = null;
                    google.script.run.withSuccessHandler(res => {
                        wmsSearchingUser.value = false;
                        if (res && res.length > 0) {
                            wmsUserFound.value = res[0];
                        } else {
                            alert('Usuário não encontrado.');
                        }
                    }).withFailureHandler(e => {
                        wmsSearchingUser.value = false;
                        alert(e.message);
                    }).searchUserBQ(wmsUserId.value);
                };

                const submitWmsRequest = () => {
                    if (!wmsUserFound.value || !wmsQueueName.value || !wmsAnalyst.value || !wmsJustification.value) {
                        alert('Preencha todos os campos obrigatórios.');
                        return;
                    }

                    wmsLoading.value = true;
                    wmsSuccess.value = false;
                    wmsStatusMsg.value = 'Registrando solicitação...';

                    const payload = {
                        tipo: 'WMS_PRINT_CLEAN',
                        queue_name: wmsQueueName.value,
                        id: wmsUserFound.value.id,
                        nome: wmsUserFound.value.nome,
                        user_name: wmsUserFound.value.user_name,
                        email: wmsUserFound.value.email,
                        filial: wmsUserFound.value.filial,
                        centro_custo: wmsUserFound.value.centro_custo,
                        analista: wmsAnalyst.value,
                        justificativa: wmsJustification.value
                    };

                    google.script.run.withSuccessHandler(res => {
                        wmsLoading.value = false;
                        if (res.success) {
                            wmsSuccess.value = true;
                            wmsRequestId.value = res.id || 'N/A';
                            // Reset form
                            wmsUserId.value = '';
                            wmsUserFound.value = null;
                            wmsQueueName.value = '';
                            wmsPrinterFilter.value = '';
                            wmsJustification.value = '';
                        } else {
                            alert('Erro: ' + (res.message || 'Falha ao registrar solicitação.'));
                        }
                    }).withFailureHandler(e => {
                        wmsLoading.value = false;
                        alert('Erro: ' + e.message);
                    }).submitRequest(payload);
                };

                return {
                    appLogo,
                    currentView, authForm, isLoading, userEmail, userInitials, rememberMe,
                    handleLogin, logout,
                    currentTab, filiais, analystList, selectedFilial, selectedAnalyst, searchQuery,
                    searchResults, loading, submitting, isConfirmModalVisible, isSuccessModalVisible,
                    queueData, queueLoading, performSearch, confirmAndSend, loadQueue,

                    // Utils & Filters
                    selectedCostCenter, uniqueCostCenters, filteredResults, hasResults, selectedCount, allSelected,
                    toggleAll, openConfirmModal, resetForm, downloadReceipt, toTitleCase, formatDate,
                    searchFilters, mirrorFilters, filterList,

                    // Bitlocker
                    bitlockerHostname, bitlockerUserId, bitlockerUserFound, bitlockerSearchingUser, bitlockerAnalyst,
                    bitlockerLoading, bitlockerRes, bitlockerStatusMsg, bitlockerShowKey, fetchBitlockerUserInfo, requestBitlocker,

                    // Mirror
                    mirrorStep, mirrorForm, mirrorGroups, mirrorLoading, mirrorStatusMsg, fetchMirrorGroups,
                    cancelMirrorPoll, mirrorSearchQuery, mirrorSearchResults, mirrorSearchLoading, performMirrorSearch,
                    selectedGroupsCount, selectAllGroups, selectAllMirrorTargets, selectedTargetsCount, submitMirrorFinal, resetMirror,
                    filteredMirrorResults, allMirrorSelected, switchTab,

                    // Ordenação e Paginação
                    sortQueue, sortColumn, sortDirection, queueFilters, uniqueQueueFilials, uniqueQueueAnalysts, itemsPerPage, currentPage, totalPages, paginatedQueue, changePage,
                    resultSortColumn, resultSortDirection, sortResults, filteredQueue,

                    // Labels
                    searchLabel, submitActionLabel,

                    // WMS (v1.7.0)
                    wmsUserId, wmsUserFound, wmsSearchingUser, wmsQueueName, wmsPrinterFilter,
                    wmsAnalyst, wmsJustification, wmsPrinterCache, wmsLoading, wmsStatusMsg,
                    wmsSuccess, wmsRequestId, filteredWmsPrinters, fetchWmsUserInfo, submitWmsRequest, loadWmsPrinterCache
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
```

### Arquivos App Script\ZendeskService.js
```
/**
 * MÓDULO ZENDESK - TRÊS IDENTIDADES
 * Integrador: chatbot_helpdesk@magazineluiza.com.br
 * 
 * Este módulo gerencia a comunicação com a API do Zendesk para criar tickets
 * em nome do solicitante (Identidade 1), atribuídos ao analista (Identidade 2),
 * e fechados pelo robô/integrador (Identidade 3).
 */

const ZD_CONFIG = {
  subdomain: 'opsmagalu',
  // Recomendo salvar no Script Properties: PropertiesService.getScriptProperties().getProperty('ZD_TOKEN')
  token: 'fQJk3eVT4S1PwaE3LvI1QhuO0wbPbZ1V40YNf6wC',
  email: 'chatbot_helpdesk@magazineluiza.com.br',
  form_id: 11340158223639,
  group_id: 1500003152142
};

/**
 * Abre um ticket no Zendesk.
 * @param {Object} dados - Objeto com os dados da solicitação.
 * @returns {number|null} ID do ticket criado ou null em caso de erro.
 */
function abrirTicketZendesk(dados) {
  const url = `https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/tickets.json`;
  const auth = Utilities.base64Encode(`${ZD_CONFIG.email}/token:${ZD_CONFIG.token}`);

  // Mapeamento automático de campos baseado no tipo de tarefa
  let principal = "acessos";
  let sub = dados.subcategoria || "acessos_desbloquei_usuario"; // Mantendo typo conforme chamado modelo
  let filialTag = dados.filial ? `tkf_filial_${String(dados.filial).replace(/\D/g, '')}` : ""; // Remove não-dígitos e formata com segurança

  // Ajuste fino de subcategoria
  if (!dados.subcategoria) {
    if (dados.tipo_tarefa === 'RESET') sub = "acessos_reset_de_senha";
    if (dados.tipo_tarefa === 'BITLOCKER') {
      principal = "suporte_infra_cds_tarefas_extras";
      sub = "acessos_bitlocker";
    }
    if (dados.tipo_tarefa === 'WMS_PRINT_CLEAN') {
      principal = "suporte_infra_cds_tarefas_extras";
      sub = "acessos_limpeza_de_fila_de_impressão";
    }
    // Fallback explícito para Desbloqueio
    if (dados.tipo_tarefa === 'DESBLOQUEIO_CONTA' || dados.tipo_tarefa === 'UNLOCK') {
      sub = "acessos_desbloquei_usuario";
    }
  }

  const payload = {
    "ticket": {
      "subject": `[PORTAL] ${dados.tipo_tarefa}: ${dados.valor}`,
      "comment": {
        "body": `Solicitação automatizada via Portal Automatos.\nTarefa: ${dados.tipo_tarefa}\nAlvo: ${dados.valor}`,
        "public": true
      },
      "requester": { "email": dados.email_solicitante }, // Identidade 1
      "assignee_email": dados.email_analista,           // Identidade 2
      "ticket_form_id": ZD_CONFIG.form_id,
      "group_id": ZD_CONFIG.group_id,
      "custom_fields": [
        { "id": 360045805373, "value": principal },
        { "id": 33294091278999, "value": sub },
        { "id": 1500005841581, "value": "out_squad_suporte_infra_cds" },
        { "id": 11340191255575, "value": dados.valor },
        { "id": 12297116742551, "value": "pendente_aprovacao" },
        { "id": 360046728773, "value": "status_done_nao" },
        // Novos campos mapeados do chamado modelo (Desbloqueio)
        { "id": 360049713894, "value": "infracd_solicitação_de_serviço" },
        { "id": 360046194913, "value": filialTag }
      ]
    }
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Basic ' + auth },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const resObj = JSON.parse(response.getContentText());

    if (response.getResponseCode() === 201) {
      console.log(`[ZENDESK] Ticket criado: #${resObj.ticket.id}`);
      return resObj.ticket.id;
    }

    console.error("Erro Zendesk API (POST):", response.getContentText());
    let ticketId = `FALHA_ZD: ${response.getResponseCode()} - ${response.getContentText().substring(0, 100)}`; // Retorna erro visível

    // Se o retorno da função for uma string de erro (começa com FALHA_ZD), usa ela
    if (ticketId && String(ticketId).startsWith("FALHA_ZD")) {
      // Mantém o erro
    } else if (!ticketId) {
      ticketId = "FALHA_ZD: Retorno Nulo";
    }
    return ticketId; // Ensure the error is returned
  } catch (e) {
    console.error("Falha ao abrir ticket:", e.message);
    return `FALHA_ZD: EXCEPTION - ${e.message}`;
  }
}

/**
 * Fecha um ticket no Zendesk e envia mensagem de encerramento.
 * @param {number|string} ticketId - ID do ticket a ser fechado.
 * @param {string} nomeSolicitante - Nome do solicitante para personalização da mensagem.
 */
function fecharTicketZendesk(ticketId, nomeSolicitante) {
  if (!ticketId) return;

  const url = `https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/tickets/${ticketId}.json`;
  const auth = Utilities.base64Encode(`${ZD_CONFIG.email}/token:${ZD_CONFIG.token}`);

  const mensagem = `Olá ${nomeSolicitante}, solicitação resolvida pelo nosso Agente Virtual. Esperamos ter ajudado!\n\n` +
    `Sua avaliação sobre nosso atendimento nos ajuda a melhorar, por isso agradecemos se puder deixar a sua opinião na avaliação do CSAT que irá receber em seu e-mail.\n\n` +
    `Agradeço desde já sua colaboração!\nAtenciosamente,\nIntegrador Help Desk`;

  const payload = {
    "ticket": {
      "status": "solved",
      "comment": { "body": mensagem, "public": true }
    }
  };

  const options = {
    method: 'put',
    contentType: 'application/json',
    headers: { 'Authorization': 'Basic ' + auth },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    UrlFetchApp.fetch(url, options);
    console.log(`[ZENDESK] Ticket #${ticketId} resolvido pelo Integrador.`);
  } catch (e) {
    console.error(`[ZENDESK] Erro ao fechar ticket #${ticketId}: ${e.message}`);
  }
}

```

### Arquivos App Script\Database.js
```
/**
 * O Módulo de Conexão do Antigravity
 * Responsável por entregar a planilha certa dependendo do ambiente.
 */

// Chave da propriedade que vamos buscar nas configurações do Script
// Módulo de Conexão Resiliente (v1.6.3)

/**
 * Obtém a instância da Planilha (Database) ativa para este ambiente.
 * @returns {GoogleAppsScript.Spreadsheet.Spreadsheet} A planilha conectada.
 */
function getDatabaseConnection() {
  const props = PropertiesService.getScriptProperties().getProperties();
  const scriptId = ScriptApp.getScriptId();

  // IDs dos Projetos (Source of Truth)
  const ID_PROD = '1r3yVjaZ9-XzlPhZl9t0zd2pvH-PtN55KHKQTW_Nh0w00cbh-47q7yXOd';
  const isProd = (scriptId === ID_PROD) || (props['ENV'] === 'PROD');

  // v1.6.5: Segregação Automática Inteligente
  let dbUrl = isProd ? props['DB_URL_PROD'] : props['DB_URL_STAGING'];

  // Fail-safe: Se a URL específica não existir, tenta alternar
  if (!dbUrl) {
    dbUrl = props['DB_URL_PROD'] || props['DB_URL_STAGING'];
  }

  if (!dbUrl) {
    throw new Error("⛔ ERRO CRÍTICO: Configuração de DB_URL não encontrada para " + (isProd ? "PRODUÇÃO" : "STAGING"));
  }

  try {
    const ss = SpreadsheetApp.openByUrl(dbUrl);
    console.log("📡 Ambiente Identificado: " + (isProd ? "PRODUÇÃO" : "STAGING"));
    console.log("✅ Conectado ao DB: " + ss.getName());
    return ss;
  } catch (e) {
    throw new Error("⛔ ERRO DE CONEXÃO: " + e.message);
  }
}

/**
 * Retorna true se estiver rodando no script de Produção.
 */
function isProduction() {
  const scriptId = ScriptApp.getScriptId();
  const ID_PROD = '1r3yVjaZ9-XzlPhZl9t0zd2pvH-PtN55KHKQTW_Nh0w00cbh-47q7yXOd';
  return (scriptId === ID_PROD) || (PropertiesService.getScriptProperties().getProperty('ENV') === 'PROD');
}

// =========================================================================
// WMS CLUSTER & SERVERS CONFIG (v1.7.0)
// =========================================================================

// ID da Planilha de Servidores (Independente de ambiente, é a fonte da verdade da Infra)
const ID_PLANILHA_SERVIDORES = '1Towa_GmwdzyO8-P11h3fHQKsdIdWod5QNGXdgrQqVJI';

/**
 * Conecta na Planilha de Servidores/Infra.
 */
function getServersConnection() {
  return SpreadsheetApp.openById(ID_PLANILHA_SERVIDORES);
}

/**
 * Lê a lista de nós do Cluster WMS da Coluna C.
 * Retorna array de strings: ['SRV-WMS-01', 'SRV-WMS-02', ...]
 */
function getWmsClusterNodes() {
  // Cache de 1h para não estourar cota de leitura, já que infra muda pouco
  const cache = CacheService.getScriptCache();
  const cached = cache.get("WMS_CLUSTER_NODES");
  if (cached) return JSON.parse(cached);

  const ss = getServersConnection();
  // Assume a primeira aba ou uma específica. O usuário disse "a coluna C da planilha nova tem o nome de WMS Windows"
  let sheet = ss.getSheetByName("WMS Windows");
  if (!sheet) sheet = ss.getSheets()[0]; // Fallback para a primeira aba se o nome não for exato

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];

  // Lê Coluna C (Índice 3) da linha 2 até o fim
  const data = sheet.getRange(2, 3, lastRow - 1, 1).getValues();

  // Filtra vazios e normaliza
  const nodes = data
    .flat()
    .filter(h => h && String(h).trim() !== "")
    .map(h => String(h).trim().toUpperCase());

  if (nodes.length > 0) {
    cache.put("WMS_CLUSTER_NODES", JSON.stringify(nodes), 3600); // Cache 1h
  }

  return nodes;
}

/**
 * v1.7.0: Retorna a lista de impressoras WMS do cache.
 * O cache é populado pelo Daemon via endpoint POST update_printer_cache.
 */
function getWmsPrinterCache() {
  const ss = getDatabaseConnection();
  const sheet = ss.getSheetByName('Cache_Impressoras');
  if (!sheet) return [];

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];

  // Coluna B contém os nomes das impressoras
  const data = sheet.getRange(2, 2, lastRow - 1, 1).getValues();
  return data.flat().filter(p => p && String(p).trim() !== '');
}

```

### Arquivos App Script\Frontend.js
```
/**
 * --- VERSÃO FRONTEND: 7.0 (Sincronização de Abas + Menus) ---
 * Configurações do Projeto do BigQuery
 * Substitua 'maga-bigdata' pelo ID do projeto no Google Cloud
 */
const PROJECT_ID = 'maga-bigdata';

// Lista de abas que NUNCA devem ser apagadas
const ABAS_PROTEGIDAS = ['BASE_FILIAIS', 'INFORMAÇÕES BASES'];

// Lista de Analistas para Validação
const LISTA_ANALISTAS = [
  "Adriano Machado", "Andson Santos", "Bruna Mueller", "Bruno Montilha", "Carlos Boaventura",
  "Caroline Lima", "Cassiano Teles", "Cleriston Rodrigues", "Didimo Silva", "Douglas Souza",
  "EdsonJunior", "Eduardo Silva", "Estermah Santos", "Fabiano  Rosa", "Francisco Regis",
  "Gabriel Namura", "Gabriel Lima", "Gabriel Villar", "Genison Santos", "Gladson Ferreira",
  "Glauber Vieira", "Helder Ito", "Iugner Santos", "Jacob Lima", "Jair Dias", "Jeronimo Moraes",
  "Kaio Vargas", "Karine Oliveira", "Leandro Araujo", "Leo Rezende", "Levi Dantas",
  "Lucas Silva", "Marcos Freiberger", "Matheus Sinflorio", "Max Weber", "MichelleRodrigues",
  "Naldimar Barros", "Paulo Bizzi", "Pedro Figur", "Rafaela Camecran", "Raiane  Aguiar",
  "Rodrigo Lima", "Rodrigo Costa", "Silas Ferreira", "Thiago Miranda", "Thiago Honorio",
  "Victor Pedroza", "Vinicius Silva", "Wesley Faria", "William Fernandes"
];

/**
 * Cria o menu personalizado ao abrir a planilha.
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('Relatórios BigQuery')
    .addItem('Sincronizar Filiais (BigQuery)', 'gerarRelatoriosPorFilial')
    .addSeparator()
    .addItem('🗑️ Excluir Abas Geradas', 'excluirAbasGeradas')
    .addToUi();
}

/**
 * NOVA FUNÇÃO: Exclui todas as abas que não são protegidas (reset da planilha)
 */
function excluirAbasGeradas() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const todasAbas = ss.getSheets();

  const abasParaExcluir = todasAbas.filter(aba => !ABAS_PROTEGIDAS.includes(aba.getName()));

  if (abasParaExcluir.length === 0) {
    ui.alert("Não há abas geradas para excluir.");
    return;
  }

  const resposta = ui.alert(
    'Confirmação de Exclusão em Massa',
    `Atenção! Você está prestes a EXCLUIR PERMANENTEMENTE ${abasParaExcluir.length} abas geradas automaticamente.\n\nAs abas base (Base Filiais, Informações, Auditoria) NÃO serão afetadas.\n\nDeseja continuar?`,
    ui.ButtonSet.YES_NO
  );

  if (resposta !== ui.Button.YES) {
    return;
  }

  let contador = 0;
  abasParaExcluir.forEach(aba => {
    try {
      ss.deleteSheet(aba);
      contador++;
    } catch (e) {
      Logger.log(`Erro ao excluir ${aba.getName()}: ${e.message}`);
    }
  });

  ui.alert(`Limpeza concluída! ${contador} abas foram excluídas.`);
}

function gerarRelatoriosPorFilial() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let abaControle = ss.getSheetByName('INFORMAÇÕES BASES');
  if (!abaControle) {
    abaControle = ss.getSheetByName('BASE_FILIAIS');
  }
  if (!abaControle) {
    abaControle = ss.getActiveSheet();
  }

  Logger.log(`Lendo dados da aba: ${abaControle.getName()}`);

  const ultimaLinha = abaControle.getLastRow();
  if (ultimaLinha < 2) {
    SpreadsheetApp.getUi().alert(`A aba '${abaControle.getName()}' não tem dados suficientes.`);
    return;
  }

  const dados = abaControle.getRange(2, 1, ultimaLinha - 1, 3).getValues();

  // 1. IDENTIFICAR FILIAIS VÁLIDAS
  const filiaisValidas = new Map();

  dados.forEach(linha => {
    let idFilial = linha[0];
    let parteB = linha[1];
    let parteC = linha[2];

    if (idFilial) {
      let idString = String(idFilial).trim();
      let b = parteB ? String(parteB).trim() : "";
      let c = parteC ? String(parteC).trim() : "";

      let nomeAba = "";
      if (b && c) {
        nomeAba = `${b} - ${c}`;
      } else {
        nomeAba = b || c || idString;
      }

      filiaisValidas.set(nomeAba, idString);
    }
  });

  if (filiaisValidas.size === 0) {
    SpreadsheetApp.getUi().alert("Nenhuma filial válida encontrada.");
    return;
  }

  // 2. LIMPEZA
  const todasAbas = ss.getSheets();
  todasAbas.forEach(aba => {
    const nomeAba = aba.getName();
    if (!ABAS_PROTEGIDAS.includes(nomeAba) && !filiaisValidas.has(nomeAba)) {
      try {
        ss.deleteSheet(aba);
      } catch (e) {
        Logger.log(`Erro ao excluir aba ${nomeAba}: ${e.message}`);
      }
    }
  });

  // 3. CRIAÇÃO / ATUALIZAÇÃO
  filiaisValidas.forEach((idFilial, nomeAba) => {
    try {
      Logger.log(`Processando Filial(is): ${idFilial} | Aba: ${nomeAba}`);
      const resultado = executarQuery(idFilial);
      salvarDadosNaAba(ss, nomeAba, resultado);
    } catch (e) {
      Logger.log(`Erro ao processar filial ${idFilial}: ${e.message}`);
    }
  });

  SpreadsheetApp.getUi().alert(`Sincronização concluída! ${filiaisValidas.size} abas processadas.`);
}

/**
 * Monta e executa a query no BigQuery
 */
function executarQuery(filialId) {
  const sql = `
    SELECT
      t2.FILIAL,
      t2.ID,
      t2.NOME,
      t2.CARGO,
      t2.CENTRO_CUSTO,
      FORMAT_DATE('%d/%m/%Y', DATE(t2.DATA_ADMISSAO)) AS DATA_ADMISSAO,
      t2.SITUACAO,
      t1.email,
      t1.user_name
    FROM
      \`maga-bigdata.kirk.assignee\` AS t1
    INNER JOIN
      \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2
      ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
    WHERE 
      t2.FILIAL IN (${filialId})
    QUALIFY ROW_NUMBER() OVER (PARTITION BY t2.ID ORDER BY LENGTH(t1.user_name) ASC) = 1
    ORDER BY
      t2.NOME asc
  `;

  const request = {
    query: sql,
    useLegacySql: false
  };

  let queryResults = BigQuery.Jobs.query(request, PROJECT_ID);
  const jobId = queryResults.jobReference.jobId;

  let sleepTimeMs = 500;
  while (!queryResults.jobComplete) {
    Utilities.sleep(sleepTimeMs);
    sleepTimeMs *= 2;
    queryResults = BigQuery.Jobs.getQueryResults(PROJECT_ID, jobId);
  }

  let rows = queryResults.rows;
  while (queryResults.pageToken) {
    queryResults = BigQuery.Jobs.getQueryResults(PROJECT_ID, jobId, {
      pageToken: queryResults.pageToken
    });
    if (queryResults.rows) {
      rows = rows.concat(queryResults.rows);
    }
  }

  if (!rows) {
    return { headers: [], data: [] };
  }

  const headers = queryResults.schema.fields.map(field => field.name);
  const data = rows.map(row => {
    return row.f.map(cell => cell.v);
  });

  return { headers: headers, data: data };
}

/**
 * Salva os dados na aba e formata (COM COLUNA VALIDADA DE ANALISTA)
 */
function salvarDadosNaAba(spreadsheet, nomeAba, resultado) {
  let sheet = spreadsheet.getSheetByName(nomeAba);

  if (!sheet) {
    sheet = spreadsheet.insertSheet(nomeAba);
  } else {
    sheet.clear();
  }

  if (resultado.data.length === 0) {
    sheet.getRange(1, 1).setValue("Nenhum dado encontrado para esta seleção.");
    return;
  }

  const totalLinhas = resultado.data.length;
  // AUMENTAMOS O NÚMERO DE COLUNAS EM +2 (Resetar Senha? + Analista)
  const totalColunas = resultado.headers.length + 2;
  const rangeTotal = sheet.getRange(1, 1, totalLinhas + 1, totalColunas);

  // 1. Escreve Cabeçalhos 
  const toTitleCase = (str) => {
    if (!str) return "";
    return String(str).replace(/_/g, ' ').toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  };

  let headersFormatados = resultado.headers.map(h => toTitleCase(h));
  let headers = [...headersFormatados, "Resetar Senha?", "Analista Responsável"];
  sheet.getRange(1, 1, 1, totalColunas).setValues([headers]);

  // 1.1 Transformar Dados (Caixa Alta -> Title Case para colunas específicas)
  const COLUNAS_TITLE_CASE = ['FILIAL', 'NOME', 'CARGO', 'CENTRO_CUSTO', 'SITUACAO'];
  const indicesParaConverter = [];
  resultado.headers.forEach((h, index) => {
    if (COLUNAS_TITLE_CASE.includes(h)) {
      indicesParaConverter.push(index);
    }
  });

  const dadosFormatados = resultado.data.map(linha => {
    return linha.map((celula, index) => {
      if (indicesParaConverter.includes(index) && celula) {
        return toTitleCase(celula);
      }
      return celula;
    });
  });

  // 2. Escreve Dados (Os dados originais vão até a antepenúltima coluna)
  sheet.getRange(2, 1, totalLinhas, resultado.headers.length).setValues(dadosFormatados);

  // 3. Validação de Dados: RESETAR SENHA? (Penúltima Coluna)
  const colIndexReset = totalColunas - 1;
  const rangeValidacaoReset = sheet.getRange(2, colIndexReset, totalLinhas, 1);
  const regraReset = SpreadsheetApp.newDataValidation()
    .requireValueInList(['SIM', 'NÃO'], true)
    .setAllowInvalid(false)
    .build();
  rangeValidacaoReset.setDataValidation(regraReset).setValue("NÃO");

  // 4. Validação de Dados: ANALISTA RESPONSÁVEL (Última Coluna)
  const colIndexAnalista = totalColunas;
  const rangeValidacaoAnalista = sheet.getRange(2, colIndexAnalista, totalLinhas, 1);
  const regraAnalista = SpreadsheetApp.newDataValidation()
    .requireValueInList(LISTA_ANALISTAS, true)
    .setAllowInvalid(false) // Bloqueia edição manual fora da lista
    .build();
  rangeValidacaoAnalista.setDataValidation(regraAnalista);

  // 5. Formatação Visual
  rangeTotal.setHorizontalAlignment("left");
  rangeTotal.applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY, true, false);
  sheet.getRange(1, 1, 1, totalColunas).setFontWeight("bold");
  sheet.autoResizeColumns(1, totalColunas);

  // 6. Garantia Extra: Formata Coluna F como Texto/Data (Data Admissão)
  if (totalLinhas > 0) {
    sheet.getRange(2, 6, totalLinhas, 1).setNumberFormat("@");
  }
}

```

### Arquivos App Script\Diagnosis.js
```

function handleDiagnostic() {
    try {
        const props = PropertiesService.getScriptProperties().getProperties();
        const dbUrlProd = props['DB_URL_PROD'] || "N/A";
        const dbUrlStaging = props['DB_URL_STAGING'] || "N/A";
        const envVar = props['ENV'] || "N/A";

        const ss = getDatabaseConnection();
        const sheet = ss.getSheetByName("Solicitações");

        let lastRow = 0;
        let lastId = "N/A";
        let headers = [];

        if (sheet) {
            lastRow = sheet.getLastRow();
            if (lastRow > 0) {
                headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
                if (lastRow > 1) {
                    lastId = sheet.getRange(lastRow, 1).getValue();
                }
            }
        }

        return {
            status: "OK",
            environment: {
                detected_prod: isProduction(),
                env_var: envVar
            },
            config: {
                db_url_prod_set: dbUrlProd !== "N/A",
                db_url_staging_set: dbUrlStaging !== "N/A"
            },
            connected_sheet: {
                name: ss.getName(),
                id: ss.getId(),
                has_queue_sheet: !!sheet,
                total_rows: lastRow,
                last_request_id: lastId,
                headers_sample: headers.slice(0, 3)
            }
        };
    } catch (e) {
        return {
            status: "ERROR",
            message: e.message,
            stack: e.stack
        };
    }
}

```

### Arquivos App Script\appsscript.json
```
{
  "timeZone": "America/Sao_Paulo",
  "dependencies": {
    "enabledAdvancedServices": [
      {
        "userSymbol": "BigQuery",
        "version": "v2",
        "serviceId": "bigquery"
      }
    ]
  },
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/userinfo.email",
    "https://www.googleapis.com/auth/bigquery",
    "https://www.googleapis.com/auth/script.send_mail"
  ],
  "webapp": {
    "executeAs": "USER_DEPLOYING",
    "access": "ANYONE_ANONYMOUS"
  }
}
```

### Arquivos App Script\Partial_Header.html
```
<!-- Partial_Header.html - Cabeçalho com Navegação -->
<!-- v1.7.0: Componente modular extraído do AppsScript_Web_Index.html -->

<header class="header-gradient text-white shadow-lg z-20 py-1 sm:py-0">
    <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-[4rem] sm:h-20 flex flex-col sm:flex-row items-center justify-between py-2 sm:py-0 gap-2">
        <div class="flex items-center justify-between w-full sm:w-auto">
            <div class="flex items-center space-x-2 sm:space-x-3 cursor-pointer hover:opacity-80 transition-opacity"
                @click="switchTab('new')">
                <img :src="appLogo" alt="LuizaLabs" class="h-6 sm:h-8 w-auto filter brightness-0 invert">
                <div class="leading-tight">
                    <div class="font-bold text-sm sm:text-xl tracking-tight">Portal de Serviços</div>
                    <div class="text-[10px] text-blue-200/80">Suporte Infra CDs</div>
                </div>
            </div>
            <div class="flex sm:hidden items-center space-x-2">
                <div class="h-8 w-8 rounded-full bg-white/20 flex items-center justify-center text-[10px] font-bold"
                    @click="logout">
                    {{ userInitials }}
                </div>
            </div>
        </div>

        <div class="w-full sm:w-auto overflow-x-auto no-scrollbar pb-1 sm:pb-0">
            <div class="flex space-x-1 bg-white/10 rounded-lg p-1 min-w-max">
                <button @click="switchTab('new')"
                    :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'new', 'text-white/80 hover:text-white': currentTab !== 'new'}"
                    class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                    Resets
                </button>
                <button @click="switchTab('mirror')"
                    :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'mirror', 'text-white/80 hover:text-white': currentTab !== 'mirror'}"
                    class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                    Espelhos
                </button>
                <button @click="switchTab('unlock')"
                    :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'unlock', 'text-white/80 hover:text-white': currentTab !== 'unlock'}"
                    class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                    Desbloqueios
                </button>
                <button @click="loadQueue"
                    :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'queue', 'text-white/80 hover:text-white': currentTab !== 'queue'}"
                    class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                    Fila
                </button>
                <button @click="switchTab('bitlocker')"
                    :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'bitlocker', 'text-white/80 hover:text-white': currentTab !== 'bitlocker'}"
                    class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 001-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z"
                            clip-rule="evenodd" />
                    </svg>
                    BitLocker
                </button>
                <button @click="switchTab('wms')"
                    :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'wms', 'text-white/80 hover:text-white': currentTab !== 'wms'}"
                    class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" />
                    </svg>
                    WMS
                </button>
            </div>
        </div>

        <div class="hidden sm:flex items-center space-x-4">
            <div class="text-right">
                <div class="text-[11px] font-medium opacity-90 leading-none mb-1">{{ userEmail }}</div>
                <div class="text-[9px] text-white/60">Sessão Corporativa</div>
            </div>
            <div class="h-10 w-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center text-sm font-bold avatar-glow cursor-pointer hover:bg-white/30 transition-all"
                @click="logout" title="Sair">
                {{ userInitials }}
            </div>
        </div>
    </div>
</header>
```

### Arquivos App Script\Partial_Login.html
```
<!-- Partial_Login.html - Tela de Login -->
<!-- v1.7.0: Componente modular extraído do AppsScript_Web_Index.html -->

<div class="flex min-h-full items-center justify-center py-12 px-4 sm:px-6 lg:px-8 h-full"
    style="background: linear-gradient(135deg, #004499 0%, #0066CC 50%, #0086FF 100%);">

    <!-- Rainbow Strip no topo -->
    <div class="rainbow-strip fixed top-0 left-0 right-0"></div>

    <div
        class="w-full max-w-md space-y-8 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-white/20">
        <div class="text-center flex flex-col items-center">
            <div class="p-2 mb-2">
                <img :src="appLogo" alt="LuizaLabs" class="h-16 w-auto mx-auto drop-shadow-md">
            </div>
            <h2 class="mt-2 text-3xl font-bold tracking-tight text-gray-900">Portal de Serviços</h2>
            <p class="text-sm font-medium text-blue-600">Suporte Infra CDs</p>
            <p class="mt-4 text-sm text-gray-500">
                Acesso exclusivo com conta Google corporativa
            </p>
        </div>

        <div class="mt-8">
            <button @click="handleLogin" :disabled="isLoading"
                class="group relative flex w-full justify-center items-center gap-3 rounded-lg border border-gray-300 bg-white py-3 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 transition-all shadow-sm">

                <svg class="h-5 w-5" aria-hidden="true" viewBox="0 0 24 24">
                    <path
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                        fill="#4285F4" />
                    <path
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                        fill="#34A853" />
                    <path
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                        fill="#FBBC05" />
                    <path
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                        fill="#EA4335" />
                </svg>

                {{ isLoading ? 'Autenticando...' : 'Entrar com Google' }}
            </button>

            <p v-if="authForm.errorMessage"
                class="mt-4 text-center text-sm text-red-600 bg-red-50 p-2 rounded border border-red-100">
                {{ authForm.errorMessage }}
            </p>
        </div>

        <!-- Versão no canto inferior -->
        <div class="text-center text-xs text-gray-400 pt-4 border-t border-gray-100">
            v1.9.2 • Leandro Araújo
        </div>
    </div>
</div>
```

### Arquivos App Script\Tab_BitLocker.html
```
<!-- Tab_BitLocker.html - Aba de Recuperação de Chaves BitLocker -->
<!-- v1.7.0: Componente modular extraído do AppsScript_Web_Index.html -->

<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Recuperação de Chaves BitLocker
    </h2>
    <p class="text-sm text-gray-500 mb-6">Consulte a chave de recuperação (Recovery Key) de estações de trabalho
        consultando o Active Directory em tempo real.</p>

    <div class="space-y-4">
        <!-- Step 1: Requester Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Solicitante
                    (ID, Nome, Usuário ou Email)</label>
                <div class="flex gap-2">
                    <input type="text" v-model="bitlockerUserId" @keyup.enter="fetchBitlockerUserInfo"
                        placeholder="Busca inteligente..."
                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <button @click="fetchBitlockerUserInfo" :disabled="bitlockerSearchingUser"
                        class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all flex items-center">
                        <svg v-if="bitlockerSearchingUser" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <svg v-else class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
                <div v-if="bitlockerUserFound"
                    class="mt-2 p-2 bg-green-50 rounded border border-green-100 animate-fade-in">
                    <p class="text-[10px] text-green-700 font-bold uppercase tracking-tight">
                        ✅ {{ bitlockerUserFound.nome }}
                    </p>
                    <p class="text-[9px] text-green-600">
                        {{ bitlockerUserFound.filial }} | {{ bitlockerUserFound.user_name }}
                    </p>
                </div>
            </div>
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Hostname
                    ou ID de Recuperação (8 dígitos)</label>
                <input type="text" v-model="bitlockerHostname" placeholder="Ex: W123ANX123RU ou 89107B05"
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 uppercase">
                <p class="mt-1 text-[9px] text-gray-400">Insira o Hostname OU os 8 primeiros dígitos do ID da Senha.</p>
            </div>
        </div>

        <!-- Step 2: Analyst Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Analista
                    que receberá a chave</label>
                <select v-model="bitlockerAnalyst"
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <option value="" disabled>Selecione o Analista...</option>
                    <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                </select>
            </div>
        </div>

        <div class="flex justify-end">
            <button @click="requestBitlocker"
                :disabled="bitlockerLoading || !bitlockerHostname || !bitlockerAnalyst || !bitlockerUserId"
                class="w-full sm:w-auto bg-gray-800 hover:bg-black text-white px-10 py-3 rounded-xl text-sm font-bold transition-all disabled:opacity-50 shadow-lg flex items-center justify-center gap-2 transform hover:scale-105 active:scale-95">
                <svg v-if="bitlockerLoading" class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                SOLICITAR RECUPERAÇÃO
            </button>
        </div>
    </div>

    <!-- Status Message -->
    <div v-if="bitlockerLoading"
        class="mt-6 flex items-center justify-center p-8 bg-gray-50 rounded-lg border border-gray-100 flex-col gap-3">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="text-sm text-gray-600">{{ bitlockerStatusMsg }}</p>
        <p class="text-xs text-gray-400">Isso pode levar até 60 segundos.</p>
    </div>

    <!-- Result -->
    <div v-if="bitlockerRes" class="mt-8 animate-fade-in">
        <div class="border-l-4 border-green-500 bg-green-50 p-6 rounded-r-lg shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-bold text-green-800 mb-1">Chave Encontrada!</h3>
                    <p class="text-sm text-green-700 mb-4">Hostname Identificado: <b>{{ bitlockerRes.hostname }}</b></p>
                </div>
                <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded font-mono">
                    {{ bitlockerRes.passwordId ? 'ID: ' + bitlockerRes.passwordId.substring(0,8) + '...' : '' }}
                </span>
            </div>

            <div class="bg-white border border-green-100 rounded-lg p-4 mt-2 relative overflow-hidden group">
                <label class="block text-xs text-gray-400 uppercase tracking-widest mb-1">Recovery Key</label>
                <div class="font-mono text-2xl tracking-wider text-gray-800 break-all selection:bg-green-200">
                    <span v-if="bitlockerShowKey">{{ bitlockerRes.recoveryKey }}</span>
                    <span v-else
                        class="text-gray-300 select-none">••••••-••••••-••••••-••••••-••••••-••••••-••••••-••••••</span>
                </div>

                <button @click="bitlockerShowKey = !bitlockerShowKey"
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-all"
                    title="Mostrar/Ocultar">
                    <svg v-if="!bitlockerShowKey" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    <svg v-else class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.059 10.059 0 013.999-5.325m2.597-1.626a9.006 9.006 0 014.288-1.049c4.478 0 8.268 2.943 9.542 7a10.06 10.06 0 01-1.093 3.03M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>
```

### Arquivos App Script\Tab_Espelhos.html
```
<!-- Tab_Espelhos.html - Aba de Espelhamento de Acesso -->
<!-- v1.7.0: Componente modular extraído do AppsScript_Web_Index.html -->

<!-- PROGRESS BAR -->
<div class="flex items-center justify-center space-x-4 mb-8">
    <div class="flex items-center">
        <span :class="mirrorStep >= 1 ? 'bg-blue-600' : 'bg-gray-300'"
            class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm">1</span>
        <span class="ml-2 text-sm font-medium" :class="mirrorStep >= 1 ? 'text-blue-600' : 'text-gray-500'">Modelo e
            Grupos</span>
    </div>
    <div class="w-16 h-0.5 bg-gray-200"></div>
    <div class="flex items-center">
        <span :class="mirrorStep >= 2 ? 'bg-blue-600' : 'bg-gray-300'"
            class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm">2</span>
        <span class="ml-2 text-sm font-medium" :class="mirrorStep >= 2 ? 'text-blue-600' : 'text-gray-500'">Usuários
            Destino</span>
    </div>
</div>

<!-- ETAPA 1: MODELO -->
<div v-if="mirrorStep === 1" class="space-y-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Etapa 1: Definir Usuário Modelo</h2>
        <p class="text-sm text-gray-500 mb-6">Digite o <b>Usuário de Rede</b> ou <b>Matrícula (ID)</b> de quem já possui
            os acessos.</p>

        <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
            <div class="flex-1">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Usuário
                    Modelo</label>
                <input type="text" v-model="mirrorForm.modelUser" @keyup.enter="fetchMirrorGroups"
                    placeholder="Ex: usuario_ad ou 123456"
                    class="block w-full px-3 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg border bg-white">
            </div>
            <button @click="fetchMirrorGroups" :disabled="mirrorLoading || !mirrorForm.modelUser"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center justify-center">
                {{ mirrorLoading ? 'Buscando...' : 'Listar Grupos' }}
            </button>
        </div>
        <div v-if="mirrorStatusMsg"
            class="mt-4 flex items-center justify-between bg-orange-50 border border-orange-100 rounded-lg p-3">
            <div class="text-sm text-orange-600 font-medium flex items-center gap-2">
                <svg class="animate-spin h-4 w-4 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                {{ mirrorStatusMsg }}
            </div>
            <button @click="cancelMirrorPoll"
                class="text-xs text-red-600 hover:text-red-800 font-bold underline">CANCELAR</button>
        </div>
    </div>

    <div v-if="mirrorGroups.length > 0"
        class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 animate-fade-in">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-md font-bold text-gray-800">Selecione os Grupos a Espelhar ({{ mirrorGroups.length }})</h3>
            <div class="text-sm text-gray-500 space-x-2">
                <button @click="selectAllGroups(true)" class="text-blue-600 hover:underline">Marcar Todos</button>
                <span>|</span>
                <button @click="selectAllGroups(false)" class="text-blue-600 hover:underline">Desmarcar Todos</button>
            </div>
        </div>
        <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[300px] overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50">
            <label v-for="grp in mirrorGroups" :key="grp.name"
                class="flex items-start space-x-3 p-2 hover:bg-white rounded border border-transparent hover:border-gray-200 transition-all cursor-pointer">
                <input type="checkbox" v-model="grp.selected"
                    class="mt-1 rounded border-gray-300 text-blue-600 h-4 w-4">
                <span class="text-xs text-gray-700 break-all">{{ grp.name }}</span>
            </label>
        </div>
        <div class="mt-6 flex justify-end">
            <button @click="mirrorStep = 2" :disabled="selectedGroupsCount === 0"
                class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-8 rounded-lg shadow-md disabled:opacity-50">
                Próxima Etapa: Selecionar Destinos →
            </button>
        </div>
    </div>
</div>

<!-- ETAPA 2: DESTINOS -->
<div v-if="mirrorStep === 2" class="space-y-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-medium text-gray-900">Etapa 2: Selecionar Usuários Destino</h2>
            <button @click="mirrorStep = 1" class="text-blue-600 hover:underline text-sm">← Voltar</button>
        </div>
        <p class="text-sm text-gray-500 mb-4">Busque e selecione os usuários que receberão os grupos.</p>

        <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
            <div class="flex-1">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Buscar
                    Destino</label>
                <input type="text" v-model="mirrorTargetSearch" @keyup.enter="searchMirrorTargets"
                    placeholder="Nome, ID ou Usuário"
                    class="block w-full px-3 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg border bg-white">
            </div>
            <button @click="searchMirrorTargets" :disabled="mirrorLoading || !mirrorTargetSearch"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors disabled:opacity-50">
                {{ mirrorLoading ? 'Buscando...' : 'Buscar' }}
            </button>
        </div>
    </div>

    <!-- Resultados da Busca de Destinos -->
    <div v-if="mirrorTargetResults.length > 0" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-md font-bold text-gray-800 mb-4">Resultados ({{ mirrorTargetResults.length }})</h3>
        <div class="overflow-x-auto max-h-[250px] overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-10"></th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Usuário</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Filial</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    <tr v-for="u in mirrorTargetResults" :key="u.id" class="hover:bg-blue-50 cursor-pointer"
                        @click="toggleMirrorTarget(u)">
                        <td class="px-4 py-2">
                            <input type="checkbox" :checked="isMirrorTargetSelected(u)"
                                class="rounded border-gray-300 text-blue-600 h-4 w-4">
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-600">{{ u.id }}</td>
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">{{ toTitleCase(u.nome) }}</td>
                        <td class="px-4 py-2 text-sm text-gray-600">{{ u.user_name }}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">{{ u.filial }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Destinos Selecionados -->
    <div v-if="mirrorSelectedTargets.length > 0" class="bg-green-50 rounded-xl shadow-sm border border-green-200 p-6">
        <h3 class="text-md font-bold text-green-800 mb-4">Destinos Selecionados ({{ mirrorSelectedTargets.length }})
        </h3>
        <div class="overflow-x-auto max-h-[200px] overflow-y-auto">
            <table class="min-w-full divide-y divide-green-200">
                <thead class="bg-green-100 sticky top-0">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-green-700 uppercase">ID</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-green-700 uppercase">Nome</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-green-700 uppercase">Usuário</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-green-700 uppercase">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-green-100">
                    <tr v-for="u in mirrorSelectedTargets" :key="u.id">
                        <td class="px-4 py-2 text-sm text-gray-600">{{ u.id }}</td>
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">{{ toTitleCase(u.nome) }}</td>
                        <td class="px-4 py-2 text-sm text-gray-600">{{ u.user_name }}</td>
                        <td class="px-4 py-2">
                            <button @click="removeMirrorTarget(u)"
                                class="text-red-500 hover:text-red-700 text-xs font-bold">REMOVER</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- FINALIZAÇÃO -->
    <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col md:flex-row items-center justify-between gap-6">
        <div class="flex-1">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Analista Responsável pelo
                Atendimento:</label>
            <select v-model="selectedAnalyst"
                class="w-full md:w-64 border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:ring-blue-500">
                <option value="" disabled>Selecione o analista...</option>
                <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
            </select>
        </div>
        <div class="text-right">
            <div class="text-sm text-gray-500 mb-2">
                <b>{{ selectedTargetsCount }}</b> destino(s) selecionado(s)
            </div>
            <button @click="submitMirrorFinal" :disabled="selectedTargetsCount === 0 || !selectedAnalyst || submitting"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-xl shadow-lg transition-transform hover:scale-105 disabled:opacity-50">
                FINALIZAR E SOLICITAR ESPELHO
            </button>
        </div>
    </div>
</div>
```

### Arquivos App Script\Tab_Fila.html
```
<!-- Tab_Fila.html - Aba de Fila de Atendimento -->
<!-- v1.7.0: Componente modular extraído do AppsScript_Web_Index.html -->

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
        <h2 class="text-lg font-medium text-gray-900">Últimas Solicitações</h2>
        <button @click="loadQueue" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Atualizar
        </button>
    </div>

    <!-- Filtros da Fila -->
    <div class="p-4 bg-gray-50 border-b border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Filial</label>
                <select v-model="queueFilters.filial"
                    class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">Todas as Filiais</option>
                    <option v-for="filial in uniqueQueueFilials" :key="filial" :value="filial">{{ filial }}</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Status</label>
                <select v-model="queueFilters.status"
                    class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">Todos os Status</option>
                    <option value="PENDENTE">PENDENTE</option>
                    <option value="SUCESSO">SUCESSO</option>
                    <option value="ERRO">ERRO</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Analista</label>
                <select v-model="queueFilters.analista"
                    class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">Todos os Analistas</option>
                    <option v-for="analista in uniqueQueueAnalysts" :key="analista" :value="analista">{{ analista }}
                    </option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Buscar</label>
                <input type="text" v-model="queueFilters.search" placeholder="Nome ou usuário..."
                    class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div v-if="queueLoading" class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    </div>

    <!-- Tabela da Fila -->
    <div v-if="!queueLoading" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-600 uppercase">ID</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Data</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Filial</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Colaborador</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Analista</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Tipo</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Status</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Ticket ZD</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
                <tr v-for="item in paginatedQueue" :key="item.id || (item.data + item.user)" class="hover:bg-gray-50">
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-mono text-gray-600 bg-gray-50">
                        #{{ item.id || '-' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(item.data) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.filial }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ toTitleCase(item.nome) }}</div>
                        <div class="text-xs text-gray-500">{{ item.user }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.analista }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span :class="{
                                'bg-blue-100 text-blue-800': item.tipo === 'RESET' || item.tipo === 'RESET_SENHA',
                                'bg-green-100 text-green-800': item.tipo === 'UNLOCK' || item.tipo === 'DESBLOQUEIO_CONTA' || item.tipo === 'DESBLOQUEIO',
                                'bg-purple-100 text-purple-800': item.tipo === 'MIRROR' || item.tipo === 'ESPELHO_USUARIO',
                                'bg-orange-100 text-orange-800': item.tipo === 'WMS_PRINT_CLEAN'
                            }"
                            class="px-2 inline-flex text-[10px] leading-5 font-bold rounded-full border border-current opacity-80 uppercase tracking-tighter">
                            {{ item.tipo || 'RESET' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span
                            :class="{'bg-yellow-100 text-yellow-800': item.status === 'PENDENTE', 'bg-green-100 text-green-800': item.status === 'SUCESSO', 'bg-red-100 text-red-800': item.status === 'ERRO'}"
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">{{ item.status
                            }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <template v-if="item.ticket_zendesk && item.ticket_zendesk !== 'FALHA_ZD'">
                            <a :href="'https://helpdesk.magalu.com.br/hc/pt-br/requests/' + item.ticket_zendesk"
                                target="_blank"
                                class="flex items-center gap-1 text-blue-600 hover:text-blue-800 font-bold transition-colors">
                                #{{ item.ticket_zendesk }}
                                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path
                                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </a>
                        </template>
                        <template v-else>
                            <span class="text-gray-400 italic">N/A</span>
                        </template>
                    </td>
                </tr>
                <tr v-if="paginatedQueue.length === 0">
                    <td colspan="8" class="px-6 py-10 text-center text-gray-400">Nenhum registro encontrado com os
                        filtros selecionados.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Paginação -->
    <div v-if="!queueLoading && filteredQueue.length > 0"
        class="p-4 bg-gray-50 border-t border-gray-200 flex justify-center items-center">
        <div class="text-xs font-bold text-blue-600 uppercase tracking-widest">
            Total Geral na Fila: {{ filteredQueue.length }} Colaboradores
        </div>
    </div>
</div>
```

### Arquivos App Script\Tab_Resets.html
```
<!-- Tab_Resets.html - Aba de Reset/Desbloqueio de Senha -->
<!-- v1.7.0: Componente modular extraído do AppsScript_Web_Index.html -->

<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
    <div class="flex flex-col gap-4">
        <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                {{ searchLabel }}
            </label>
            <div class="flex flex-col sm:flex-row gap-2">
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" v-model="searchQuery" @keyup.enter="performSearch"
                        placeholder="Busca Coringa: Nome, ID, Usuário ou Email..."
                        class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-9 text-sm border-gray-300 rounded-lg p-2.5 border bg-white shadow-sm">
                </div>
                <button @click="performSearch" :disabled="loading"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold transition-all disabled:opacity-50 shadow-md flex items-center justify-center whitespace-nowrap">
                    <svg v-if="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    {{ loading ? 'Buscando...' : 'PESQUISAR' }}
                </button>
            </div>
        </div>
    </div>
</div>

<div v-if="hasResults" class="flex flex-wrap items-center justify-between gap-4 pb-2">
    <div class="text-xs text-gray-400">Encontrados: {{ filteredResults.length }}</div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[400px] flex flex-col">
    <div v-if="!hasResults && !loading"
        class="flex-1 flex flex-col items-center justify-center p-10 text-center text-gray-400">
        <svg class="h-16 w-16 mb-4 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <p v-if="hasSearched">Nenhum colaborador encontrado.</p>
        <p v-else>Use os filtros acima para encontrar colaboradores.</p>
    </div>

    <div v-if="hasResults" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                        <input type="checkbox" @change="toggleAll" :checked="allSelected"
                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                    </th>
                    <th scope="col" @click="sortResults('id')"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                        ID
                        <span v-if="resultSortColumn === 'id'" class="ml-1">{{ resultSortDirection === 'asc' ? '↑' : '↓'
                            }}</span>
                    </th>
                    <th scope="col" @click="sortResults('nome')"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                        Nome / Cargo
                        <span v-if="resultSortColumn === 'nome'" class="ml-1">{{ resultSortDirection === 'asc' ? '↑' :
                            '↓' }}</span>
                    </th>
                    <th scope="col" @click="sortResults('user_name')"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                        Usuário Rede
                        <span v-if="resultSortColumn === 'user_name'" class="ml-1">{{ resultSortDirection === 'asc' ?
                            '↑' : '↓' }}</span>
                    </th>
                    <th scope="col" @click="sortResults('email')"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                        Email
                        <span v-if="resultSortColumn === 'email'" class="ml-1">{{ resultSortDirection === 'asc' ? '↑' :
                            '↓' }}</span>
                    </th>
                    <th scope="col" @click="sortResults('centro_custo')"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                        Centro de Custo
                        <span v-if="resultSortColumn === 'centro_custo'" class="ml-1">{{ resultSortDirection === 'asc' ?
                            '↑' : '↓' }}</span>
                    </th>
                </tr>
                <!-- FILTROS DE COLUNA -->
                <tr class="bg-gray-100">
                    <th class="px-2 py-1"></th>
                    <th class="px-2 py-1">
                        <input type="text" v-model="searchFilters.id" placeholder="Filtrar ID"
                            class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                    </th>
                    <th class="px-2 py-1">
                        <input type="text" v-model="searchFilters.nome" placeholder="Filtrar Nome"
                            class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                    </th>
                    <th class="px-2 py-1">
                        <input type="text" v-model="searchFilters.user_name" placeholder="Filtrar User"
                            class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                    </th>
                    <th class="px-2 py-1">
                        <input type="text" v-model="searchFilters.email" placeholder="Filtrar Email"
                            class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                    </th>
                    <th class="px-2 py-1">
                        <input type="text" v-model="searchFilters.centro_custo" placeholder="Filtrar CC"
                            class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="user in filteredResults" :key="user.user_name"
                    :class="{'bg-blue-50': user.selected, 'hover:bg-gray-50': !user.selected}"
                    class="transition-colors text-xs">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <input type="checkbox" v-model="user.selected"
                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="text-xs font-mono bg-gray-100 px-2 py-0.5 rounded">{{ user.id || '-' }}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="font-medium text-gray-900">{{ toTitleCase(user.nome) }}</div>
                                <div class="text-[10px] text-gray-500">{{ toTitleCase(user.cargo) }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-xs text-gray-900 font-mono bg-gray-100 px-2 py-0.5 rounded inline-block">{{
                            user.user_name }}</div>
                        <span v-if="user.ja_resetado"
                            class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-yellow-100 text-yellow-800">Já
                            Resetado</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">{{ user.email ?
                        user.email.toLowerCase() : '-' }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">{{ user.centro_custo }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
```

### Arquivos App Script\Tab_WMS.html
```
<!-- Tab_WMS.html - Aba de Cancelamento de Impressões WMS -->
<!-- v1.7.0: Nova funcionalidade de gerenciamento de filas de impressão do cluster WMS -->

<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
        Cancelamento de Filas de Impressão WMS
    </h2>
    <p class="text-sm text-gray-500 mb-6">
        Solicite o cancelamento de trabalhos de impressão pendentes em todo o cluster WMS.
        A limpeza será executada automaticamente após aprovação.
    </p>

    <div class="space-y-6">
        <!-- Step 1: Solicitante (Dados completos BQ) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Solicitante (ID, Nome, Usuário ou Email)
                </label>
                <div class="flex gap-2">
                    <input type="text" v-model="wmsUserId" @keyup.enter="fetchWmsUserInfo"
                        placeholder="Busca inteligente..."
                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <button @click="fetchWmsUserInfo" :disabled="wmsSearchingUser"
                        class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all flex items-center">
                        <svg v-if="wmsSearchingUser" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <svg v-else class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
                <div v-if="wmsUserFound" class="mt-2 p-2 bg-green-50 rounded border border-green-100 animate-fade-in">
                    <p class="text-[10px] text-green-700 font-bold uppercase tracking-tight">
                        ✅ {{ wmsUserFound.nome }}
                    </p>
                    <p class="text-[9px] text-green-600">
                        {{ wmsUserFound.filial }} | {{ wmsUserFound.user_name }} | {{ wmsUserFound.email }}
                    </p>
                </div>
            </div>
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Filial (Filtro de Impressoras)
                </label>
                <input type="text" v-model="wmsPrinterFilter"
                    placeholder="Digite para filtrar impressoras pela filial..."
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 uppercase">
                <p class="mt-1 text-[9px] text-gray-400">Ex: 4811, 0034, LUBM</p>
            </div>
        </div>

        <!-- Step 2: Seleção da Fila de Impressão -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Fila de Impressão
                </label>
                <select v-model="wmsQueueName"
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <option value="" disabled>Selecione a Fila...</option>
                    <option v-for="printer in filteredWmsPrinters" :key="printer" :value="printer">{{ printer }}
                    </option>
                </select>
                <p class="mt-1 text-[9px] text-gray-400">
                    {{ wmsPrinterCache.length }} impressoras disponíveis no cluster WMS.
                </p>
            </div>
            <div class="w-full">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                    Analista Responsável
                </label>
                <select v-model="wmsAnalyst"
                    class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                    <option value="" disabled>Selecione o Analista...</option>
                    <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                </select>
            </div>
        </div>

        <!-- Step 3: Justificativa -->
        <div class="border-b pb-6">
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                Justificativa (Obrigatório)
            </label>
            <textarea v-model="wmsJustification" rows="3"
                placeholder="Descreva o motivo da solicitação de limpeza da fila..."
                class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 resize-none"></textarea>
        </div>

        <!-- Resumo e Botão -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div v-if="wmsUserFound && wmsQueueName"
                class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-200 w-full md:w-auto">
                <span class="font-bold">Resumo:</span>
                Limpar a fila <span class="font-mono bg-orange-100 px-1 rounded">{{ wmsQueueName }}</span>
                para <span class="font-medium">{{ wmsUserFound.nome }}</span>
            </div>
            <button @click="submitWmsRequest"
                :disabled="wmsLoading || !wmsUserFound || !wmsQueueName || !wmsAnalyst || !wmsJustification"
                class="w-full md:w-auto bg-orange-600 hover:bg-orange-700 text-white px-10 py-3 rounded-xl text-sm font-bold transition-all disabled:opacity-50 shadow-lg flex items-center justify-center gap-2 transform hover:scale-105 active:scale-95">
                <svg v-if="wmsLoading" class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <svg v-else class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" />
                </svg>
                SOLICITAR LIMPEZA DE FILA
            </button>
        </div>
    </div>

    <!-- Status Message -->
    <div v-if="wmsLoading"
        class="mt-6 flex items-center justify-center p-8 bg-orange-50 rounded-lg border border-orange-100 flex-col gap-3">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
        <p class="text-sm text-orange-700">{{ wmsStatusMsg || 'Processando solicitação...' }}</p>
    </div>

    <!-- Success Message -->
    <div v-if="wmsSuccess"
        class="mt-6 border-l-4 border-green-500 bg-green-50 p-6 rounded-r-lg shadow-sm animate-fade-in">
        <h3 class="text-lg font-bold text-green-800 mb-1">Solicitação Registrada com Sucesso!</h3>
        <p class="text-sm text-green-700">
            A solicitação de limpeza da fila <b>{{ wmsQueueName }}</b> foi enviada para aprovação.
            Após aprovação, o Daemon executará a limpeza automaticamente em todos os servidores do cluster.
        </p>
        <p class="text-xs text-green-600 mt-2">ID da Solicitação: <span class="font-mono">{{ wmsRequestId }}</span></p>
    </div>
</div>
```

### Arquivos App Script\AppsScript_SLA_Template.html
```
<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .card {
            background-color: #ffffff;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-top: 6px solid #ff0000;
        }

        .header {
            background: linear-gradient(135deg, #0086ff, #0056b3);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .content {
            padding: 40px;
            color: #333;
            line-height: 1.6;
        }

        .highlight {
            color: #ff0000;
            font-weight: bold;
        }

        .info-grid {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .info-item {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-item strong {
            width: 120px;
            display: inline-block;
            color: #555;
        }

        .footer {
            background-color: #f8f9fa;
            padding: 20px;
            text-align: center;
            font-size: 12px;
            color: #777;
            border-top: 1px solid #eee;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: #0086ff;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="header">
            <h1>⚠️ Alerta de SLA</h1>
        </div>
        <div class="content">
            <p>Olá, <strong>
                    <?= analistaNome ?>
                </strong>,</p>
            <p>A solicitação abaixo está aguardando sua ação há mais de <span class="highlight">2 horas</span>. Este é
                um lembrete automático para garantir o cumprimento dos prazos de atendimento.</p>

            <div class="info-grid">
                <div class="info-item"><strong>ID:</strong> #
                    <?= idSolicitacao ?>
                </div>
                <div class="info-item"><strong>Tipo:</strong>
                    <?= tipoTarefa ?>
                </div>
                <div class="info-item"><strong>Criada em:</strong>
                    <?= dataCriacao ?>
                </div>
                <div class="info-item"><strong>Usuário:</strong>
                    <?= usuarioNome ?>
                </div>
            </div>

            <p>Por favor, acesse o painel de gestão para aprovar ou reprovar esta solicitação o mais breve possível.</p>

            <div style="text-align: center;">
                <a href="https://script.google.com/a/macros/luizalabs.com/s/AKfycbwcwKziwn37TfZgEJcHA_37l9aG6prf73CL-8JZ9pMgO9igU6mEC9iTrdNI1FbtI4Kr/exec"
                    class="btn">Acessar Painel de Gestão</a>
            </div>
        </div>
        <div class="footer">
            <p>Este é um e-mail automático enviado pelo Sistema de Reset de Usuários.</p>
            <p>&copy; 2026 - Suporte Infra CDs Magalog</p>
        </div>
    </div>
</body>

</html>
```

### Scripts\Unified_AD_Daemon.ps1
```
# ==============================================================================
# IDENTITY MANAGER - SUPORTE INFRA CDS - v6.0 (WMS PRINT QUEUES SUPPORT)
# ==============================================================================

# --- CONFIGURAÇÃO ---
# --- CONFIGURAÇÃO MULTI-AMBIENTE ---
$Environments = @(
    @{
        Name   = "PROD"
        Prefix = "[PROD] "
        Url    = "https://script.google.com/macros/s/AKfycbwcwKziwn37TfZgEJcHA_37l9aG6prf73CL-8JZ9pMgO9igU6mEC9iTrdNI1FbtI4Kr/exec".Trim()
    },
    @{
        Name   = "STAGING"
        Prefix = "[STAGING] "
        Url    = "https://script.google.com/a/macros/luizalabs.com/s/AKfycbziGqnkYDXS4oI2nDqPlrk2epJjN8boCVcjSdZ-kgZWqIPgBfprE9vCTIRCDggllC_aKg/exec".Trim()
    }
)

$LoopIntervalSeconds = 5 

$global:smtpServer = "smtpml.magazineluiza.intranet"

# --- PREPARAÇÃO ---
$TargetLogDir = "C:\ProgramData\ADResetTool\Logs"
$FallbackLogDir = Join-Path $env:TEMP "ADResetTool_Logs"
$LogFileName = "UnifiedDaemon_$(Get-Date -Format 'yyyy-MM-dd').log"

# Tenta usar o diretório principal, faz fallback se falhar
try {
    if (-not (Test-Path $TargetLogDir)) { New-Item -ItemType Directory -Force -Path $TargetLogDir -ErrorAction Stop | Out-Null }
    
    $TargetLogFile = Join-Path $TargetLogDir $LogFileName
    
    # Teste de escrita específico no arquivo de log do dia
    # Se o arquivo existe, tenta abrir para append. Se não, tenta criar.
    if (Test-Path $TargetLogFile) {
        $stream = [System.IO.File]::Open($TargetLogFile, [System.IO.FileMode]::Append, [System.IO.FileAccess]::Write)
        $stream.Close()
    }
    else {
        "init" | Out-File -FilePath $TargetLogFile -ErrorAction Stop
    }
    
    $LogDir = $TargetLogDir
}
catch {
    # Se falhar no ProgramData (pasta ou arquivo), usa o Temp do usuário
    $LogDir = $FallbackLogDir
    if (-not (Test-Path $LogDir)) { New-Item -ItemType Directory -Force -Path $LogDir | Out-Null }
    Write-Host "AVISO: Sem permissão no log principal ($TargetLogDir). Erro: $($_.Exception.Message). Usando fallback: $LogDir" -ForegroundColor Yellow
}

$LogFile = Join-Path $LogDir $LogFileName

# Garante o módulo de AD
if (-not (Get-Module -Name ActiveDirectory)) {
    Import-Module ActiveDirectory -ErrorAction SilentlyContinue
}

# Configuração UTF-8 para console e saída (silencia erro se não suportado)
try { [Console]::OutputEncoding = [System.Text.Encoding]::UTF8 } catch {}
$OutputEncoding = [System.Text.Encoding]::UTF8

function Write-Log {
    param([string]$Message, [string]$Level = "INFO", [string]$Prefix = "")
    $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    $logEntry = "[$timestamp] [$Level] $Prefix$Message"
    $color = switch ($Level) { "INFO" { "Cyan" } "WARN" { "Yellow" } "ERROR" { "Red" } "SUCCESS" { "Green" } default { "Gray" } }
    Write-Host $logEntry -ForegroundColor $color
    try {
        $logEntry | Out-File -FilePath $LogFile -Append -Encoding UTF8 -ErrorAction Stop
    }
    catch {
        Write-Host "ERRO AO GRAVAR LOG: $($_.Exception.Message)" -ForegroundColor Red
    }
}

# Função para enviar requisições POST com encoding UTF-8
function Send-ApiRequest {
    param([string]$Uri, [hashtable]$Body)
    $json = ConvertTo-Json $Body -Depth 5
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
    return Invoke-RestMethod -Uri $Uri -Method Post -Body $bytes -ContentType "application/json; charset=utf-8"
}

# Função Helper para Retry de Comandos AD
function Invoke-ADCommandWithRetry {
    param (
        [ScriptBlock]$Command,
        [int]$MaxRetries = 3,
        [int]$RetryDelaySeconds = 2
    )
    
    $currentRetry = 0
    $lastError = $null
    
    while ($currentRetry -lt $MaxRetries) {
        try {
            return & $Command
        }
        catch {
            $lastError = $_.Exception.Message
            $currentRetry++
            
            # Verifica se é erro de conexão/autenticação
            if ($lastError -match "authenticated|server|connection|target account name is incorrect") {
                Write-Log "Erro AD detectado ($lastError). Tentativa $currentRetry de $MaxRetries..." "WARN"
                Start-Sleep -Seconds $RetryDelaySeconds
                
                # Tenta 'acordar' a sessão
                try { Get-ADRootDSE -ErrorAction SilentlyContinue | Out-Null } catch {}
            }
            else {
                # Se não for erro de infra, repassa o erro imediatamente
                throw $_
            }
        }
    }
    
    throw "Falha após $MaxRetries tentativas. Último erro: $lastError"
}

# --- FUNÇÕES DE EMAIL (ESTILIZADAS MAGALU) ---

function Send-ResetEmail {
    param($Para, $CC, $Usuario, $NomeColaborador, $NovaSenha, $FromEmail)
    $primeiroNome = ($NomeColaborador -split ' ')[0]
    $remetente = if ($FromEmail -and $FromEmail -match "^[\w\.-]+@([\w-]+\.)+[\w-]{2,4}$") { $FromEmail } else { "suporte-infra-cds@luizalabs.com" }
    
    $corpoHtml = "
    <div style='font-family: Arial; padding: 20px;'>
        <h2 style='color: #0284c7;'>Olá, $primeiroNome!</h2>
        <p>Sua senha de rede foi resetada conforme solicitado.</p>
        <div style='background: #f1f5f9; padding: 15px; border-radius: 8px; font-family: monospace;'>
            <b>Usuário:</b> $Usuario<br>
            <b>Nova Senha:</b> $NovaSenha
        </div>
        <p><i>Nota: Você deverá alterar esta senha no primeiro login.</i></p>
    </div>"
    
    try {
        $msg = New-Object System.Net.Mail.MailMessage -ArgumentList $remetente, $Para, "Senha Resetada - $Usuario", $corpoHtml
        if ($CC) { $CC -split ";" | ForEach-Object { if ($_) { $msg.CC.Add($_.Trim()) } } }
        $msg.IsBodyHtml = $true
        $smtp = New-Object System.Net.Mail.SmtpClient($global:smtpServer, 25)
        $smtp.Send($msg)
        return $true
    }
    catch { Write-Log "Erro SMTP Reset: $($_.Exception.Message)" "ERROR"; return $false }
}

function Send-BitlockerEmail {
    param($Para, $Hostname, $RecoveryKey, $KeyId, $ReqId, $ApiUrl)
    $linkFinalizar = "$ApiUrl`?action=finalizar&id=$ReqId&analista=$Para"
    if ($RecoveryKey -eq "NOT_FOUND") {
        $assunto = "⚠️ Alerta: Chave BitLocker Não Encontrada - $Hostname"
        $corpoHtml = "
        <div style='font-family: Arial; padding: 20px; background-color: #fffbeb;'>
            <h2>Chave não localizada</h2>
            <p>Estação: <b>$Hostname</b></p>
            <p>Nenhuma chave de recuperação foi encontrada no AD para esta máquina.</p><br>
            <a href='$linkFinalizar' style='background: #4b5563; color: white; padding: 10px; text-decoration: none; border-radius: 4px;'>Confirmar Leitura e Fechar Chamado</a>
        </div>"
    }
    else {
        $assunto = "🔐 RECUPERAÇÃO: Chave BitLocker - $Hostname"
        $corpoHtml = "
        <div style='font-family: Arial; padding: 25px; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;'>
            <h2 style='color: #1e40af; margin-top: 0;'>Chave de Recuperação Encontrada</h2>
            <p style='color: #64748b;'>Abaixo estão os detalhes para a estação: <b style='color: #0f172a;'>$Hostname</b></p>
            
            <div style='background: #ffffff; padding: 20px; border: 2px solid #3b82f6; border-radius: 8px; margin: 20px 0;'>
                <label style='display: block; font-size: 10px; color: #3b82f6; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 5px;'>Recovery Key (Numérica)</label>
                <div style='font-family: monospace; font-size: 24px; color: #1e293b; font-weight: bold; letter-spacing: 2px; text-align: center;'>
                    $RecoveryKey
                </div>
            </div>

            <div style='background: #f1f5f9; padding: 12px; border-radius: 6px; font-size: 13px;'>
                <b style='color: #475569;'>ID da Senha:</b> <span style='font-family: monospace;'>$KeyId</span><br>
                <b style='color: #475569;'>Solicitação:</b> #$ReqId
            </div>

            <div style='margin-top: 25px; text-align: center;'>
                <a href='$linkFinalizar' style='display: inline-block; background: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 14px;'>FINALIZAR ATENDIMENTO</a>
                <p style='font-size: 11px; color: #94a3b8; margin-top: 15px;'>Ao clicar acima, você confirma que entregou a chave ao colaborador e registrou o atendimento.</p>
            </div>
        </div>"
    }
    try {
        $msg = New-Object System.Net.Mail.MailMessage -ArgumentList "suporte-infra-cds@luizalabs.com", $Para, $assunto, $corpoHtml
        $msg.IsBodyHtml = $true
        $smtp = New-Object System.Net.Mail.SmtpClient($global:smtpServer, 25)
        $smtp.Send($msg)
        return $true
    }
    catch { Write-Log "Erro SMTP BitLocker: $($_.Exception.Message)" "ERROR"; return $false }
}

function Send-WMSEmail {
    param($Para, $QueueName, $ReqId, $StatusMsg, $Sucesso)
    
    $subjectStatus = if ($Sucesso) { "CONCLUÍDO" } else { "ERRO" }
    $colorStatus = if ($Sucesso) { "#16a34a" } else { "#dc2626" }
    $assunto = "🖨️ WMS: Limpeza de Fila $subjectStatus - $QueueName"
    
    $corpoHtml = "
    <div style='font-family: Arial; padding: 25px; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;'>
        <h2 style='color: #1e40af; margin-top: 0;'>Notificação WMS</h2>
        <p style='color: #334155; font-size: 14px;'>A solicitação de limpeza de fila de impressão foi executada pelo Agente Automático.</p>
        
        <div style='background: white; padding: 15px; border-left: 4px solid $colorStatus; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);'>
            <p style='margin: 5px 0;'><b style='color: #475569;'>ID Solicitação:</b> #$ReqId</p>
            <p style='margin: 5px 0;'><b style='color: #475569;'>Fila:</b> $QueueName</p>
            <p style='margin: 5px 0;'><b style='color: #475569;'>Status:</b> <span style='color: $colorStatus; font-weight: bold;'>$subjectStatus</span></p>
        </div>
        
        <div style='background: #f1f5f9; padding: 12px; border-radius: 6px; font-size: 13px; color: #334155;'>
            <b>Detalhes da Execução:</b><br>
            $StatusMsg
        </div>
        
        <p style='font-size: 11px; color: #94a3b8; margin-top: 20px; text-align: center;'>Este é um e-mail automático. Não responda.</p>
    </div>"

    try {
        $msg = New-Object System.Net.Mail.MailMessage -ArgumentList "suporte-infra-cds@luizalabs.com", $Para, $assunto, $corpoHtml
        $msg.IsBodyHtml = $true
        $smtp = New-Object System.Net.Mail.SmtpClient($global:smtpServer, 25)
        $smtp.Send($msg)
        return $true
    }
    catch { Write-Log "Erro SMTP WMS: $($_.Exception.Message)" "ERROR"; return $false }
}

# --- FUNÇÕES WMS (v1.7.0) ---

function Get-WmsClusterConfig {
    param([string]$ApiUrl)
    
    try {
        $response = Invoke-RestMethod -Uri "$ApiUrl`?mode=get_wms_cluster" -Method Get -ErrorAction Stop
        
        # Valida se o retorno é um array de strings válidas
        if ($response -and $response.Count -gt 0) {
            $validServers = @()
            foreach ($server in $response) {
                if ($server -and $server.ToString().Trim().Length -gt 0) {
                    $validServers += $server.ToString().Trim()
                }
            }
            
            if ($validServers.Count -gt 0) {
                Write-Log "Cluster WMS: $($validServers.Count) servidores obtidos" "INFO"
                return $validServers
            }
        }
        
        Write-Log "Cluster WMS: Lista vazia ou inválida retornada" "WARN"
        return @()
    }
    catch {
        Write-Log "Erro ao obter cluster WMS: $($_.Exception.Message)" "ERROR"
        return @()
    }
}

function Sync-PrintQueues {
    param([string]$ApiUrl)
    
    
    # Obtém lista de servidores WMS da API (Failover Coluna C - Planilha Servidores)
    $wmsServers = Get-WmsClusterConfig -ApiUrl $ApiUrl
    
    if (-not $wmsServers -or $wmsServers.Count -eq 0) {
        Write-Log "Usando fallback local para Cluster WMS" "WARN"
        $wmsServers = @(
            "ml-ibm-wms-01.magazineluiza.intranet",
            "ml-ibm-wms-02.magazineluiza.intranet"
        )
    }
    
    $printers = $null
    $lastError = $null
    
    foreach ($server in $wmsServers) {
        try {
            Write-Log "Tentando conectar ao servidor WMS: $server..." "INFO"
            
            # Testa conexão primeiro
            if (-not (Test-Connection -ComputerName $server -Count 1 -Quiet)) {
                Write-Log "Servidor $server não responde ao ping" "WARN"
                continue
            }
            
            # Lista todas as filas de impressão do servidor
            $printers = Get-Printer -ComputerName $server -ErrorAction Stop | 
            Select-Object -ExpandProperty Name
            
            if ($printers -and $printers.Count -gt 0) {
                Write-Log "Conectado a $server - Encontradas $($printers.Count) filas" "SUCCESS"
                break
            }
        }
        catch {
            $lastError = $_.Exception.Message
            Write-Log "Falha em $server : $lastError" "WARN"
        }
    }
    
    if (-not $printers -or $printers.Count -eq 0) {
        throw "Nao foi possivel obter impressoras de nenhum servidor WMS. Ultimo erro: $lastError"
    }
    
    # Ordena alfabeticamente
    $printers = $printers | Sort-Object
    Write-Log "Impressoras ordenadas alfabeticamente" "INFO"
    
    # Envia para o Backend com encoding UTF-8
    try {
        $payload = @{
            action   = "update_printer_cache"
            printers = $printers
        } | ConvertTo-Json -Depth 3
        
        # Converte para UTF-8
        $payloadBytes = [System.Text.Encoding]::UTF8.GetBytes($payload)
        
        $result = Invoke-RestMethod -Uri $ApiUrl -Method Post -Body $payloadBytes -ContentType "application/json; charset=utf-8" -ErrorAction Stop
        Write-Log "Cache de impressoras atualizado: $result" "SUCCESS"
    }
    catch {
        throw "Erro ao enviar cache para API: $($_.Exception.Message)"
    }
}

# --- PROCESSAMENTO ---

function Invoke-TaskExecution {
    param($Task, $EnvContext)
    
    $ApiUrl = $EnvContext.Url
    $LogPfx = $EnvContext.Prefix

    # Mapeamento Dinâmico v5.2
    $id = ($Task.id_solicitacao, $Task.id, $Task.ID | Where-Object { $_ } | Select-Object -First 1)
    $user = ($Task.user_name, $Task.USER_NAME, $Task.usuario | Where-Object { $_ } | Select-Object -First 1)
    $type = ($Task.task_type, $Task.TIPO_TAREFA, $Task.type | Where-Object { $_ } | Select-Object -First 1)
    $clearPwd = ($Task.nova_senha, $Task.NOVA_SENHA, $Task.senha | Where-Object { $_ } | Select-Object -First 1)
    $nome = ($Task.nome, $Task.NOME_COLABORADOR, $Task.NOME | Where-Object { $_ } | Select-Object -First 1)
    $emailColab = ($Task.email_colaborador, $Task.EMAIL_COLABORADOR, $Task.email_colab | Where-Object { $_ } | Select-Object -First 1)
    $emailGestor = ($Task.email_gestor, $Task.EMAIL_GESTOR | Where-Object { $_ } | Select-Object -First 1)
    $analista = ($Task.analista, $Task.ANALISTA_EMAIL, $Task.solicitante | Where-Object { $_ } | Select-Object -First 1)
    $filial = ($Task.filial, $Task.FILIAL | Where-Object { $_ } | Select-Object -First 1)
    $prefix = $Task.password_id_prefix

    if (-not $id) { return }

    try {
        Write-Log "Executando Tarefa ID #$id ($type) para $user" "INFO" $LogPfx
        $payload = @{ action = "report_status"; id = $id; status = "ERRO"; message = "Iniciado" }

        switch ($type) {
            "FETCH_GROUPS" {
                $userModelo = ($Task.user_modelo, $Task.USER_MODELO | Where-Object { $_ } | Select-Object -First 1)
                if (-not $userModelo) { throw "Usuário Modelo não informado." }

                Write-Log "Buscando grupos para modelo: $userModelo" "INFO" $LogPfx
                
                # Se for matrícula (apenas números), busca o username
                if ($userModelo -match '^\d+$') {
                    Write-Log "Matrícula detectada ($userModelo), buscando username..." "INFO" $LogPfx
                    
                    $adUser = Invoke-ADCommandWithRetry -Command {
                        Get-ADUser -Filter "EmployeeID -eq '$userModelo'" -Properties SamAccountName -ErrorAction Stop
                    }
                    
                    if (-not $adUser) {
                        throw "Usuário com matrícula $userModelo não encontrado no AD"
                    }
                    $userModelo = $adUser.SamAccountName
                    Write-Log "Username encontrado: $userModelo" "INFO" $LogPfx
                }
                
                $groups = Invoke-ADCommandWithRetry -Command {
                    (Get-ADPrincipalGroupMembership -Identity $userModelo -ErrorAction Stop | Select-Object -ExpandProperty Name) -join ";"
                }
                
                # Para FETCH_GROUPS, usa action update_mirror_result
                $payload = @{ 
                    action    = "update_mirror_result"
                    type      = "FETCH_GROUPS"
                    id        = $id
                    requestId = $id
                    status    = "CONCLUIDO"
                    msg_error = ""
                    grupos    = $groups
                }
            }

            "MIRROR" {
                # v6.1: Espelhamento de Grupos
                $gruposParaAdicionar = ($Task.grupos, $Task.GRUPOS | Where-Object { $_ } | Select-Object -First 1)
                
                if (-not $gruposParaAdicionar) {
                    throw "Nenhum grupo especificado para espelhamento."
                }
                
                # Parse JSON se necessário
                if ($gruposParaAdicionar -is [string]) {
                    if ($gruposParaAdicionar.Trim().StartsWith('[')) {
                        $gruposParaAdicionar = $gruposParaAdicionar | ConvertFrom-Json
                    }
                    else {
                        $gruposParaAdicionar = $gruposParaAdicionar -split ';' | Where-Object { $_ }
                    }
                }
                
                Write-Log "Espelhando $($gruposParaAdicionar.Count) grupo(s) para $user" "INFO" $LogPfx
                
                $adicionados = @()
                $jaExistentes = @()
                $erros = @()
                
                foreach ($grupo in $gruposParaAdicionar) {
                    try {
                        # Verifica se o usuário já é membro
                        $isMember = Get-ADPrincipalGroupMembership -Identity $user -ErrorAction Stop | 
                        Where-Object { $_.Name -eq $grupo }
                        
                        if ($isMember) {
                            $jaExistentes += $grupo
                            Write-Log "Usuário já é membro de: $grupo" "WARN" $LogPfx
                        }
                        else {
                            Invoke-ADCommandWithRetry -Command {
                                Add-ADGroupMember -Identity $grupo -Members $user -ErrorAction Stop
                            }
                            $adicionados += $grupo
                            Write-Log "Adicionado ao grupo: $grupo" "SUCCESS" $LogPfx
                        }
                    }
                    catch {
                        $erros += "$grupo : $($_.Exception.Message)"
                        Write-Log "Erro ao adicionar a $grupo : $($_.Exception.Message)" "ERROR" $LogPfx
                    }
                }
                
                # Monta mensagem de resultado
                $msgParts = @()
                if ($adicionados.Count -gt 0) {
                    $msgParts += "Adicionado a $($adicionados.Count) grupo(s)"
                }
                if ($jaExistentes.Count -gt 0) {
                    $msgParts += "$($jaExistentes.Count) já existente(s)"
                }
                if ($erros.Count -gt 0) {
                    $msgParts += "$($erros.Count) erro(s)"
                }
                
                $msgFinal = $msgParts -join ", "
                
                if ($erros.Count -gt 0 -and $adicionados.Count -eq 0) {
                    throw "Falha total no espelhamento: $($erros -join '; ')"
                }
                
                $payload.status = "CONCLUIDO"
                $payload.message = $msgFinal
                $payload.detalhes = @{
                    adicionados   = $adicionados
                    ja_existentes = $jaExistentes
                    erros         = $erros
                } | ConvertTo-Json -Compress
            }

            "RESET" {
                if (-not $clearPwd) { throw "Senha ausente para Reset." }
                $securePwd = ConvertTo-SecureString $clearPwd -AsPlainText -Force
                
                Invoke-ADCommandWithRetry -Command {
                    Set-ADAccountPassword -Identity $user -NewPassword $securePwd -Reset -ErrorAction Stop
                    Unlock-ADAccount -Identity $user -ErrorAction Stop
                    Set-ADUser -Identity $user -ChangePasswordAtLogon $true -ErrorAction Stop
                }
                
                $msgFinal = "Reset executado."
                if ($emailColab) {
                    if (Send-ResetEmail -Para $emailColab -CC $emailGestor -Usuario $user -NomeColaborador $nome -NovaSenha $clearPwd -FromEmail $analista) {
                        $msgFinal += " E-mail enviado para o colaborador."
                    }
                }
                $payload.status = "CONCLUIDO"; $payload.message = $msgFinal
            }

            "BITLOCKER" {
                # v5.7: Busca Inteligente Resiliente via RDN
                $recovery = $null
                $hostnameResolved = $user

                if ($prefix) {
                    Write-Log "Busca GLOBAL BitLocker (v5.7 - RDN Filter) por ID: $prefix" "INFO" $LogPfx
                    # Buscamos todos os objetos da classe e filtramos pelo DN/Name para evitar erro de atributos sintéticos.
                    $recovery = Invoke-ADCommandWithRetry -Command {
                        Get-ADObject -Filter "objectClass -eq 'msFVE-RecoveryInformation'" -Properties msFVE-RecoveryPassword | 
                        Where-Object { $_.DistinguishedName -like "*$prefix*" -or $_.Name -like "*$prefix*" } | Select-Object -First 1
                    }
                    
                    if ($recovery) {
                        if ($recovery.DistinguishedName -match "CN=([^,]+),CN=([^,]+),") {
                            $hostnameResolved = $matches[2]
                        }
                        else {
                            $parentDN = $recovery.DistinguishedName -replace '^CN=[^,]+,', ''
                            $compParent = Invoke-ADCommandWithRetry -Command { Get-ADComputer -Identity $parentDN -ErrorAction SilentlyContinue }
                            if ($compParent) { $hostnameResolved = $compParent.Name }
                        }
                        Write-Log "Chave localizada no DN (ID: $prefix). Hostname: $hostnameResolved" "SUCCESS" $LogPfx
                    }
                }

                if (-not $recovery) {
                    Write-Log "Fallback: Buscando computador por Hostname: $user" "INFO" $LogPfx
                    $comp = Invoke-ADCommandWithRetry -Command { Get-ADComputer -Filter "Name -eq '$user'" -ErrorAction SilentlyContinue }
                    if ($comp) {
                        $allRecoveries = Invoke-ADCommandWithRetry -Command { Get-ADObject -Filter "objectClass -eq 'msFVE-RecoveryInformation'" -SearchBase $comp.DistinguishedName -Properties msFVE-RecoveryPassword }
                        $recovery = $allRecoveries | Sort-Object whenCreated -Descending | Select-Object -First 1
                        $hostnameResolved = $comp.Name
                    }
                }

                if ($recovery) {
                    $realKey = $recovery."msFVE-RecoveryPassword"
                    $fullId = if ($recovery.Name -match "{([A-F0-9-]+)}") { $matches[1] } else { $recovery.Name }
                    
                    Send-BitlockerEmail -Para $analista -Hostname $hostnameResolved -RecoveryKey $realKey -KeyId $fullId -ReqId $id -ApiUrl $ApiUrl
                    
                    $payload = @{ 
                        action        = "update_bitlocker_result"
                        id            = $id
                        status        = "SUCESSO"
                        recoveryKey   = $realKey
                        recoveryKeyId = $fullId
                        hostname      = $hostnameResolved
                        filial        = $filial
                    }
                }
                else {
                    if ($analista) { Send-BitlockerEmail -Para $analista -Hostname $hostnameResolved -RecoveryKey "NOT_FOUND" -ReqId $id -ApiUrl $ApiUrl }
                    throw "Chave não localizada no AD para $hostnameResolved."
                }
            }

            "DESBLOQUEIO_CONTA" {
                Invoke-ADCommandWithRetry -Command { Unlock-ADAccount -Identity $user -ErrorAction Stop }
                $payload.status = "CONCLUIDO"; $payload.message = "Conta desbloqueada com sucesso."
            }

            "WMS_PRINT_CLEAN" {
                # v6.0: Limpeza de Fila de Impressão WMS em Cluster
                $queueName = ($Task.queue_name, $Task.QUEUE_NAME, $Task.fila | Where-Object { $_ } | Select-Object -First 1)
                
                if (-not $queueName) {
                    throw "Nome da fila de impressao nao especificado."
                }

                Write-Log "Iniciando limpeza da fila: $queueName" "INFO" $LogPfx
                
                # Obtém lista de servidores do cluster
                $clusterServers = Get-WmsClusterConfig -ApiUrl $ApiUrl
                
                if ($clusterServers.Count -eq 0) {
                    throw "Cluster WMS vazio ou inacessivel."
                }

                $successCount = 0
                $errorCount = 0
                $errors = @()

                foreach ($server in $clusterServers) {
                    try {
                        Write-Log "Limpando fila '$queueName' no servidor $server..." "INFO" $LogPfx
                        
                        # Remove todos os trabalhos da fila
                        Get-PrintJob -ComputerName $server -PrinterName $queueName -ErrorAction Stop | 
                        Remove-PrintJob -ErrorAction Stop
                        
                        $successCount++
                        Write-Log "Fila limpa com sucesso em $server" "SUCCESS" $LogPfx
                    }
                    catch {
                        $errorCount++
                        $errorMsg = "Erro em ${server}: $($_.Exception.Message)"
                        $errors += $errorMsg
                        Write-Log $errorMsg "ERROR" $LogPfx
                    }
                }

                if ($successCount -gt 0) {
                    $msgFinal = "Fila '$queueName' limpa em $successCount/$($clusterServers.Count) servidores."
                    if ($errorCount -gt 0) {
                        $msgFinal += " Erros: $errorCount. Detalhes: $($errors -join '; ')"
                    }
                    $payload.status = "CONCLUIDO"
                    $payload.message = $msgFinal
                    
                    if ($analista) {
                        Send-WMSEmail -Para $analista -QueueName $queueName -ReqId $id -StatusMsg $msgFinal -Sucesso $true
                    }
                }
                else {
                    $msgErro = "Falha ao limpar fila em todos os servidores. Erros: $($errors -join '; ')"
                    if ($analista) {
                        Send-WMSEmail -Para $analista -QueueName $queueName -ReqId $id -StatusMsg $msgErro -Sucesso $false
                    }
                    throw $msgErro
                }
            }
            
            default {
                throw "Tipo de tarefa não suportado: $type"
            }
        }

        # Update Final
        Send-ApiRequest -Uri $ApiUrl -Body $payload
        Write-Log "ID #$id OK!" "SUCCESS" $LogPfx

    }
    catch {
        Write-Log "FALHA ID #$id : $($_.Exception.Message)" "ERROR" $LogPfx
        $errPayload = @{ action = "report_status"; id = $id; status = "ERRO"; message = $_.Exception.Message }
        Send-ApiRequest -Uri $ApiUrl -Body $errPayload
    }
}

# --- LOOP PRINCIPAL ---
Write-Log "Daemon v6.0 ATIVO - MULTI-AMBIENTE (PROD + STAGING) + WMS SUPPORT" "SUCCESS"

# Controle de sync de impressoras WMS (a cada 2 horas)
$lastPrinterSync = [DateTime]::MinValue
$printerSyncIntervalMinutes = 120

while ($true) {
    # Sync de impressoras WMS periodicamente
    $timeSinceSync = (Get-Date) - $lastPrinterSync
    if ($timeSinceSync.TotalMinutes -ge $printerSyncIntervalMinutes) {
        Write-Log "Iniciando sincronização de impressoras WMS..." "INFO"
        foreach ($env in $Environments) {
            try {
                Sync-PrintQueues -ApiUrl $env.Url
                Write-Log "Sync WMS concluído para $($env.Name)" "SUCCESS" $env.Prefix
            }
            catch {
                Write-Log "Erro no sync WMS para $($env.Name): $($_.Exception.Message)" "WARN" $env.Prefix
            }
        }
        $lastPrinterSync = Get-Date
    }

    foreach ($env in $Environments) {
        try {
            # Ocasionalmente loga heartbeat
            # Write-Log "Consultando..." "INFO" $env.Prefix
            
            $response = Invoke-RestMethod -Uri "$($env.Url)?mode=get_daemon_queue" -Method Get -ErrorAction Stop
            $tasks = @($response) | Where-Object { $_.ID -or $_.id_solicitacao }
            
            foreach ($t in $tasks) { 
                if ($t.status_aprovacao -eq "REPROVADO") {
                    $rid = ($t.id_solicitacao, $t.id, $t.ID | Where-Object { $_ } | Select-Object -First 1)
                    Write-Log "Limpando ID #$rid (Status: REPROVADO)" "WARN" $env.Prefix
                    $p = @{ action = "report_status"; id = $rid; status = "REPROVADO" }
                    Send-ApiRequest -Uri $env.Url -Body $p
                    continue
                }
                Invoke-TaskExecution -Task $t -EnvContext $env
                Start-Sleep -Milliseconds 200 
            }
        }
        catch { 
            # Erros de conexão silenciosos ou log de erro simples para não spammar
            # Write-Log "Erro API ($($env.Name)): $($_.Exception.Message)" "ERROR" $env.Prefix
        }
    }
    Start-Sleep -Seconds $LoopIntervalSeconds
}

```

### Scripts\Sync_Espelho_AD.ps1
```
# ==============================================================================
# AGENTE DE SINCRONIZAÇÃO - ESPELHO DE USUÁRIOS (AD BRIDGE) - V4 (DAEMON)
# ==============================================================================
# Este script agora roda continuamente (Modo Daemon).
# Ele consulta a API a cada 10 segundos em busca de novas solicitações de grupos.

$API_URL = "https://script.google.com/macros/s/AKfycbwcwKziwn37TfZgEJcHA_37l9aG6prf73CL-8JZ9pMgO9igU6mEC9iTrdNI1FbtI4Kr/exec".Trim()
$LogDir = "$PSScriptRoot\..\Logs"
if (-not (Test-Path $LogDir)) { New-Item -ItemType Directory -Path $LogDir -Force | Out-Null }
$LOG_FILE = "$LogDir\Log_Espelho_AD_Sync_$(Get-Date -Format 'yyyy-MM-dd').txt"
$POLLING_INTERVAL = 10 # Segundos entre verificações

function Write-Log {
    param($Message)
    $TimeStamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Add-Content -Path $LOG_FILE -Value "[$TimeStamp] $Message"
}

if (-not (Get-Module -ListAvailable -Name ActiveDirectory)) {
    Write-Log "ERRO: Módulo ActiveDirectory não encontrado."
    exit
}
Import-Module ActiveDirectory

Write-Host "================================================================" -ForegroundColor Cyan
Write-Host "AGENTE DE SINCRONIZAÇÃO INICIADO (MODO CONTÍNUO)" -ForegroundColor White
Write-Host "Pressione CTRL+C para encerrar." -ForegroundColor Yellow
Write-Host "================================================================" -ForegroundColor Cyan
Write-Log "Agente iniciado em modo Daemon."

# --- LOOP INFINITO ---
while ($true) {
    try {
        $dataHora = Get-Date -Format "HH:mm:ss"
        Write-Host "[$dataHora] Verificando fila..." -NoNewline -ForegroundColor Gray
        
        $FullUriString = $API_URL + "?mode=check_mirror_queue"
        $UriObj = [System.Uri]$FullUriString
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        
        $response = Invoke-RestMethod -Uri $UriObj -Method Get -ErrorAction Stop
        
        if (-not $response -or $response.Count -eq 0) {
            Write-Host " [Vazio]" -ForegroundColor DarkGray
        }
        else {
            Write-Host " [$($response.Count) pendência(s)!]" -ForegroundColor Green
            
            if ($response -isnot [Array]) { $response = @($response) }

            foreach ($item in $response) {
                $idSolicitacao = $item.id
                $tipo = $item.type 
                
                # O script de sync só processa FETCH_GROUPS (Etapa 1)
                if ($tipo -ne "FETCH_GROUPS") { continue }
                
                Write-Host "  -> Processando ID #$idSolicitacao..." -ForegroundColor Cyan
                
                try {
                    $usuarioModelo = $item.user_modelo
                    Write-Host "     Buscando grupos para: $usuarioModelo" -ForegroundColor White
                    
                    $grupos = Get-ADPrincipalGroupMembership -Identity $usuarioModelo | Select-Object -ExpandProperty Name | Sort-Object
                    
                    $payload = @{
                        action = "update_mirror_result"
                        id     = $idSolicitacao
                        type   = "FETCH_GROUPS"
                        status = "SUCESSO"
                        grupos = ($grupos -join ";")
                    }

                    $jsonPayload = $payload | ConvertTo-Json -Depth 5
                    $upResp = Invoke-RestMethod -Uri $API_URL -Method Post -Body $jsonPayload -ContentType "application/json"
                    
                    Write-Host "     Status API: $upResp" -ForegroundColor Green
                    Write-Log "Sucesso na captura de grupos para usuário: $usuarioModelo (ID #${idSolicitacao})"

                }
                catch {
                    $erroMsg = $_.Exception.Message
                    Write-Host "     ERRO: $erroMsg" -ForegroundColor Red
                    Write-Log "ERRO no ID #${idSolicitacao}: $erroMsg"
                    
                    $payload = @{
                        action    = "update_mirror_result"
                        id        = $idSolicitacao
                        type      = "FETCH_GROUPS"
                        status    = "ERRO"
                        msg_error = $erroMsg
                    }
                    $jsonPayload = $payload | ConvertTo-Json
                    Invoke-RestMethod -Uri $API_URL -Method Post -Body $jsonPayload -ContentType "application/json"
                }
            }
        }

    }
    catch {
        $err = $_.Exception.Message
        Write-Host " [FALHA NA CONEXÃO]" -ForegroundColor Red
        Write-Host "   Detalhe: $err" -ForegroundColor Yellow
        Write-Log "Falha de conexão ou erro no ciclo: $err"
    }

    # Aguarda o intervalo definido antes de tentar novamente
    Start-Sleep -Seconds $POLLING_INTERVAL
}

```

### Scripts\Setup_Daemon_Task.ps1
```
# ==============================================================================
# MAGALU - SETUP DAEMON TASK v1.0
# ==============================================================================
# Este script configura o Unified_AD_Daemon para rodar como Tarefa Agendada
# garantindo execução 24/7 independente de usuário logado.
# ==============================================================================

$TaskName = "Magalu_AD_Daemon"
$ScriptPath = "c:\Projetos\Reset Users - Suporte Infra CDs\Scripts\Unified_AD_Daemon.ps1"
$Description = "Serviço de Processamento de Resets, Desbloqueios e Espelhos de AD - Suporte Infra CDs"

# 1. Preparar Ação (Executar PowerShell oculto)
$Action = New-ScheduledTaskAction -Execute "powershell.exe" `
    -Argument "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"$ScriptPath`""

# 2. Preparar Trigger (Ao Iniciar o Sistema)
$Trigger = New-ScheduledTaskTrigger -AtStartup

# 3. Preparar Configurações (Resiliência)
$Settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries `
    -StartWhenAvailable -RestartCount 999 -RestartInterval (New-TimeSpan -Minutes 5)

# 4. Registrar a Tarefa (Rodar como Usuário Local para garantir permissões AD se necessário, ou SYSTEM)
# Nota: Para interagir com AD, o usuário da tarefa deve ter permissão no domínio.
Write-Host "Configurando tarefa agendada '$TaskName'..." -ForegroundColor Cyan

try {
    # Remove tarefa antiga se existir
    Unregister-ScheduledTask -TaskName $TaskName -Confirm:$false -ErrorAction SilentlyContinue
    
    # Registra a nova tarefa como SYSTEM para rodar Full Time
    Register-ScheduledTask -TaskName $TaskName `
        -Action $Action `
        -Trigger $Trigger `
        -Settings $Settings `
        -User "SYSTEM" `
        -RunLevel Highest `
        -Description $Description

    Write-Host "Sucesso! A tarefa '$TaskName' foi criada e iniciará com o Windows." -ForegroundColor Green
    Write-Host "Para iniciar agora manualmente: Start-ScheduledTask -TaskName '$TaskName'" -ForegroundColor Yellow
}
catch {
    Write-Host "Erro ao configurar tarefa: $_" -ForegroundColor Red
}

```

### Scripts\Template_Reset_Email.html
```
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 600px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border-left: 5px solid #16a34a;
        }

        .header {
            background-color: #ffffff;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .title {
            color: #16a34a;
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .content {
            padding: 30px;
            color: #374151;
            line-height: 1.6;
        }

        .footer {
            background-color: #f9fafb;
            padding: 15px;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
        }

        .info-box {
            background-color: #dcfce7;
            border: 1px solid #86efac;
            color: #15803d;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .code {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            background-color: #f3f4f6;
            padding: 2px 5px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Senha Definida com Sucesso</h1>
        </div>
        <div class="content">
            <p>Olá, <strong>{PRIMEIRO_NOME}</strong>.</p>
            <p>Sua senha de rede foi redefinida com sucesso.</p>

            <div class="info-box">
                <p style="margin: 5px 0;"><strong>Usuário:</strong> {USUARIO}</p>
                <p style="margin: 5px 0;"><strong>Nova Senha:</strong> <span class="code">{NOVA_SENHA}</span></p>
            </div>

            <p>⚠️ <strong>Atenção:</strong> Por favor, altere sua senha no primeiro login para garantir a segurança da
                sua conta.</p>
        </div>
        <div class="footer">
            Sistema de Gerenciamento de Identidades &bull; Suporte Infra CDs
        </div>
    </div>
</body>

</html>
```

### Scripts\cleanup_deployments.ps1
```
# Script para limpar implementações antigas do Clasp Apps Script
# Mantém apenas a versão HEAD e a versão de Produção especificada

$ProductionID = "AKfycbw3RwP4dr5bx8N_yhFT4dDO0bHT10veT7UKa5RizCdLGRmp1ogEYqtIiqpE7ABbx-Ri"
$LogFile = "cleanup_log.txt"

# Ler arquivo de deployments gerado anteriormente
$deployments = Get-Content "deployments.txt"

foreach ($line in $deployments) {
    # Ignora linhas que não começam com "- "
    if ($line -match "^- ([^\s]+)") {
        $id = $matches[1]
        
        # Ignorar HEAD e a Produção
        if ($line -match "@HEAD") {
            Write-Host "Ignorando HEAD: $id" -ForegroundColor Cyan
            continue
        }
        
        if ($id -eq $ProductionID) {
            Write-Host "Ignorando Produção (KEEP): $id" -ForegroundColor Green
            continue
        }

        # Executar undeploy
        Write-Host "Removendo: $id" -ForegroundColor Yellow
        
        # Adiciona path para garantir funcionamento
        $env:Path += ";C:\Program Files\nodejs\;$env:APPDATA\npm"
        
        # Executa o comando e captura erro
        try {
            cmd /c "clasp undeploy $id"
            "Deleted: $id" | Out-File -Append $LogFile
        }
        catch {
            Write-Host "Erro ao remover $id" -ForegroundColor Red
        }
    }
}
Write-Host "Limpeza concluída." -ForegroundColor Green

```

### Scripts\Reset_users_Infra_cds.ps1
```
# --- VERSÃO 1.0.5 (RELEASE OFICIAL - SISTEMA COMPLETO) ---
Write-Host "--- VERSÃO 1.0.5 CARREGADA ---" -ForegroundColor Cyan

# ==========================================================================
# CONFIGURAÇÃO CENTRAL
# ==========================================================================
# COLE AQUI A SUA URL DA IMPLANTAÇÃO (EXEC):
$API_URL = "https://script.google.com/a/macros/luizalabs.com/s/AKfycbwcwKziwn37TfZgEJcHA_37l9aG6prf73CL-8JZ9pMgO9igU6mEC9iTrdNI1FbtI4Kr/exec"

# --- PRÉ-REQUISITOS DE SEGURANÇA ---
# --- PRÉ-REQUISITOS DE SEGURANÇA ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
[Net.ServicePointManager]::CheckCertificateRevocationList = $false

# Verifica módulo AD (Ignorar se for teste fora do ambiente de domínio, mas ideal ter instalado)
if (-not (Get-Module -ListAvailable -Name ActiveDirectory)) {
    Write-Host "AVISO: Módulo ActiveDirectory não encontrado. O script rodará apenas em modo de visualização." -ForegroundColor Yellow
    # Em produção, descomente a linha abaixo para bloquear sem RSAT:
    # [System.Windows.Forms.MessageBox]::Show("Instale o RSAT.", "Erro", "OK", "Error"); exit 
}
else {
    Import-Module ActiveDirectory -ErrorAction SilentlyContinue
}

# Carrega bibliotecas visuais
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# ==========================================================================
# FUNÇÕES UTILITÁRIAS (LOGS E RETRY) - DEFINIDAS NO INÍCIO
# ==========================================================================
# --- CONFIGURAÇÃO DE LOGS ---
$logDir = "C:\ProgramData\ADResetTool\Logs"
if (-not (Test-Path $logDir)) { New-Item -ItemType Directory -Force -Path $logDir | Out-Null }
$logFile = Join-Path $logDir "Log_$(Get-Date -Format 'yyyy-MM-dd').txt"

function global:Write-Console($msg) {
    $timestamp = Get-Date -Format 'HH:mm:ss'
    $logMsg = "[$timestamp] $msg"
    
    # Escreve no Arquivo
    try {
        Add-Content -Path $logFile -Value $logMsg -ErrorAction SilentlyContinue
    }
    catch {}

    # Escreve na GUI (se existir)
    if ($global:txtConsole -and !$global:txtConsole.IsDisposed) {
        $global:txtConsole.AppendText("$logMsg`r`n")
        $global:txtConsole.SelectionStart = $global:txtConsole.Text.Length
        $global:txtConsole.ScrollToCaret()
        [System.Windows.Forms.Application]::DoEvents()
    }
}

Write-Host "Carregando funções utilitárias..." -ForegroundColor Gray

function global:Invoke-Retry {
    param(
        [Parameter(Mandatory = $true)]
        [ScriptBlock]$ScriptBlock,
        [int]$MaxRetries = 2,
        [int]$DelaySeconds = 2,
        [string]$ErrorMessage = "Operação falhou"
    )
    
    $retryCount = 0
    $completed = $false
    $lastError = $null
    
    while (-not $completed) {
        try {
            # Executa o bloco de código
            $result = & $ScriptBlock
            $completed = $true
            return $result
        }
        catch {
            $lastError = $_
            $retryCount++
            
            if ($retryCount -ge $MaxRetries) {
                Write-Console " > ERRO FATAL: $ErrorMessage após $retryCount tentativas. Detalhe: $($lastError.Exception.Message)"
                throw $lastError
            }
            else {
                Write-Console " > AVISO: Tentativa $retryCount de $MaxRetries falhou. Retentando em $DelaySeconds segundos..."
                Start-Sleep -Seconds $DelaySeconds
            }
        }
    }
}

# --- CONFIGURAÇÃO DA INTERFACE (GUI) ---
# --- CONFIGURAÇÃO DA INTERFACE (GUI) - VISUAL MODERNO ---
$MagaluBlue = [System.Drawing.ColorTranslator]::FromHtml("#0086FF")
$MagaluDark = [System.Drawing.ColorTranslator]::FromHtml("#004499")
$MagaluBg = [System.Drawing.ColorTranslator]::FromHtml("#F0F4F8")
$White = [System.Drawing.Color]::White

$mainForm = New-Object System.Windows.Forms.Form
$mainForm.Text = "Reset de Usuários - Suporte Infra CDs v1.0.5"
$mainForm.Size = New-Object System.Drawing.Size(1200, 850)
$mainForm.StartPosition = "CenterScreen"
$mainForm.BackColor = $MagaluBg
$mainForm.WindowState = [System.Windows.Forms.FormWindowState]::Maximized

# --- HEADER GRADIENTE (Adicionado PRIMEIRO para ficar NO TOPO visualmente via ordem de inserção padrão) ---
$pnlHeader = New-Object System.Windows.Forms.Panel
$pnlHeader.Dock = "Top"
$pnlHeader.Height = 100
$pnlHeader.BackColor = $MagaluDark
$pnlHeader.Add_Paint({
        param($evtSender, $e)
        $rect = $evtSender.ClientRectangle
        $brush = New-Object System.Drawing.Drawing2D.LinearGradientBrush($rect, $MagaluDark, $MagaluBlue, [System.Drawing.Drawing2D.LinearGradientMode]::ForwardDiagonal)
        $e.Graphics.FillRectangle($brush, $rect)
    })
$mainForm.Controls.Add($pnlHeader)

$lblTitle = New-Object System.Windows.Forms.Label
$lblTitle.Text = "Reset de Usuários"
$lblTitle.ForeColor = $White
$lblTitle.Font = New-Object System.Drawing.Font("Segoe UI", 24, [System.Drawing.FontStyle]::Bold)
$lblTitle.AutoSize = $true
$lblTitle.Location = New-Object System.Drawing.Point(20, 15)
$lblTitle.BackColor = [System.Drawing.Color]::Transparent
$pnlHeader.Controls.Add($lblTitle)

$lblSub = New-Object System.Windows.Forms.Label
$lblSub.Text = "Suporte Infra CDs"
$lblSub.ForeColor = [System.Drawing.Color]::FromArgb(200, 255, 255, 255)
$lblSub.Font = New-Object System.Drawing.Font("Segoe UI", 10)
$lblSub.AutoSize = $true
$lblSub.Location = New-Object System.Drawing.Point(25, 65)
$lblSub.BackColor = [System.Drawing.Color]::Transparent
$pnlHeader.Controls.Add($lblSub)

# --- RAINBOW STRIP (Adicionado DEPOIS para ficar ABAIXO do Header) ---
$pnlRainbow = New-Object System.Windows.Forms.Panel
$pnlRainbow.Dock = "Top"
$pnlRainbow.Height = 5
$pnlRainbow.Add_Paint({
        param($s, $e)
        $colors = @("#E91E76", "#FF5722", "#FF9800", "#4CAF50", "#2196F3", "#9C27B0")
        $w = $s.Width / $colors.Count
        for ($i = 0; $i -lt $colors.Count; $i++) {
            $c = [System.Drawing.ColorTranslator]::FromHtml($colors[$i])
            $b = New-Object System.Drawing.SolidBrush($c)
            $e.Graphics.FillRectangle($b, ($i * $w), 0, $w, $s.Height)
        }
    })
$mainForm.Controls.Add($pnlRainbow)

# Barra de Status
$statusStrip = New-Object System.Windows.Forms.StatusStrip
$statusLabel = New-Object System.Windows.Forms.ToolStripStatusLabel
$statusLabel.Text = "Iniciando..."
$statusStrip.Items.Add($statusLabel) | Out-Null
$mainForm.Controls.Add($statusStrip)

# --- CONTAINER PRINCIPAL (Padding) ---
$pnlContent = New-Object System.Windows.Forms.Panel
$pnlContent.Dock = "Fill"
$pnlContent.Padding = New-Object System.Windows.Forms.Padding(20)
$mainForm.Controls.Add($pnlContent)
$pnlContent.BringToFront()

# ==========================================================================
# SEÇÃO 1: SELEÇÃO DO ANALISTA (DINÂMICO)
# ==========================================================================
# ==========================================================================
# SEÇÃO 1, 2, 3: CARDS DE INPUT
# ==========================================================================
# Função Helper para criar "Card"
# Função Helper para criar "Card"
function New-CardPanel {
    param(
        [int]$panelX, 
        [int]$panelY, 
        [int]$panelWidth, 
        [int]$panelHeight, 
        [string]$panelTitle
    )
    
    $p = New-Object System.Windows.Forms.Panel
    $p.Location = New-Object System.Drawing.Point($panelX, $panelY)
    $p.Size = New-Object System.Drawing.Size($panelWidth, $panelHeight)
    $p.BackColor = [System.Drawing.Color]::White
    # Borda simples (WinForms não tem shadow nativa fácil)
    $p.BorderStyle = "FixedSingle" 
    
    $l = New-Object System.Windows.Forms.Label
    $l.Text = $panelTitle
    $l.Font = New-Object System.Drawing.Font("Segoe UI", 10, [System.Drawing.FontStyle]::Bold)
    $l.ForeColor = [System.Drawing.Color]::Gray
    
    # Cálculo Explícito de Largura
    $labelWidth = $panelWidth - 20
    $l.Location = New-Object System.Drawing.Point(10, 10)
    $l.Size = New-Object System.Drawing.Size($labelWidth, 20)
    
    $p.Controls.Add($l)
    return $p
}

# CARD 1: ANALISTA
$cardAnalista = New-CardPanel 20 20 300 100 "Identificação do Analista"
$pnlContent.Controls.Add($cardAnalista)

$lblAnalista = New-Object System.Windows.Forms.Label
$lblAnalista.Location = New-Object System.Drawing.Point(10, 35); $lblAnalista.Size = New-Object System.Drawing.Size(280, 20)
$lblAnalista.Text = "Selecione seu nome:"
$cardAnalista.Controls.Add($lblAnalista)

$cbAnalista = New-Object System.Windows.Forms.ComboBox
$cbAnalista.Location = New-Object System.Drawing.Point(10, 60); $cbAnalista.Size = New-Object System.Drawing.Size(280, 25)
$cbAnalista.DropDownStyle = "DropDownList"
$cardAnalista.Controls.Add($cbAnalista)

# API CALL (Analistas)
try {
    $statusLabel.Text = "Buscando lista de analistas na nuvem..."
    $mainForm.Cursor = [System.Windows.Forms.Cursors]::WaitCursor
    [System.Windows.Forms.Application]::DoEvents()
    $urlAnalistas = $API_URL + "?mode=get_analysts"
    $analistasRemotos = Invoke-Retry -ScriptBlock { Invoke-RestMethod -Uri $urlAnalistas -Method Get -ErrorAction Stop } -ErrorMessage "Falha ao buscar analistas"
    if ($analistasRemotos -is [System.Array] -and $analistasRemotos.Count -gt 0) {
        $cbAnalista.Items.Add("TODOS") | Out-Null
        $cbAnalista.Items.AddRange($analistasRemotos)
    }
    else { throw "Vazio" }
}
catch {
    $cbAnalista.Items.Add("TODOS"); $cbAnalista.Items.Add("--- DIGITE SEU NOME ---")
    $cbAnalista.DropDownStyle = "DropDown"
}
finally { $mainForm.Cursor = [System.Windows.Forms.Cursors]::Default }


# CARD 2: BUSCA
$cardBusca = New-CardPanel 340 20 350 100 "Busca de Demandas"
$pnlContent.Controls.Add($cardBusca)

$lblFilial = New-Object System.Windows.Forms.Label
$lblFilial.Location = New-Object System.Drawing.Point(10, 35); $lblFilial.Size = New-Object System.Drawing.Size(100, 20)
$lblFilial.Text = "Filial (Nº) ou *:"
$cardBusca.Controls.Add($lblFilial)

$txtFilial = New-Object System.Windows.Forms.TextBox
$txtFilial.Location = New-Object System.Drawing.Point(10, 60); $txtFilial.Size = New-Object System.Drawing.Size(100, 25)
$txtFilial.Text = "*"
$cardBusca.Controls.Add($txtFilial)

$btnBuscar = New-Object System.Windows.Forms.Button
$btnBuscar.Location = New-Object System.Drawing.Point(120, 58); $btnBuscar.Size = New-Object System.Drawing.Size(200, 28)
$btnBuscar.Text = "Carregar Demandas"
$btnBuscar.BackColor = $MagaluBlue; $btnBuscar.ForeColor = "White"; $btnBuscar.FlatStyle = "Flat"
$btnBuscar.FlatAppearance.BorderSize = 0
$cardBusca.Controls.Add($btnBuscar)

# CARD 3: DIRETA
$cardIndiv = New-CardPanel 710 20 300 100 "Busca Direta (Emergência)"
$pnlContent.Controls.Add($cardIndiv)

$lblUserUnico = New-Object System.Windows.Forms.Label
$lblUserUnico.Location = New-Object System.Drawing.Point(10, 35); $lblUserUnico.Size = New-Object System.Drawing.Size(100, 20)
$lblUserUnico.Text = "Usuário:"
$cardIndiv.Controls.Add($lblUserUnico)

$txtUserUnico = New-Object System.Windows.Forms.TextBox
$txtUserUnico.Location = New-Object System.Drawing.Point(10, 60); $txtUserUnico.Size = New-Object System.Drawing.Size(120, 25)
$cardIndiv.Controls.Add($txtUserUnico)

$btnBuscarUnico = New-Object System.Windows.Forms.Button
$btnBuscarUnico.Location = New-Object System.Drawing.Point(140, 58); $btnBuscarUnico.Size = New-Object System.Drawing.Size(140, 28)
$btnBuscarUnico.Text = "Resetar Avulso"
$btnBuscarUnico.BackColor = "Purple"; $btnBuscarUnico.ForeColor = "White"; $btnBuscarUnico.FlatStyle = "Flat"
$cardIndiv.Controls.Add($btnBuscarUnico)

# CARD 4: OPÇÕES
$cardOpcoes = New-CardPanel 20 140 1140 60 "Configurações de Reset"
$cardOpcoes.Anchor = "Top, Left, Right"
$pnlContent.Controls.Add($cardOpcoes)

$chkEmail = New-Object System.Windows.Forms.CheckBox; $chkEmail.Location = New-Object System.Drawing.Point(20, 35); $chkEmail.Size = New-Object System.Drawing.Size(250, 20); $chkEmail.Text = "Enviar E-mails"; $chkEmail.Checked = $true; $cardOpcoes.Controls.Add($chkEmail)
$chkUnlock = New-Object System.Windows.Forms.CheckBox; $chkUnlock.Location = New-Object System.Drawing.Point(280, 35); $chkUnlock.Size = New-Object System.Drawing.Size(250, 20); $chkUnlock.Text = "Desbloquear Conta"; $chkUnlock.Checked = $true; $cardOpcoes.Controls.Add($chkUnlock)
$chkPwdPolicy = New-Object System.Windows.Forms.CheckBox; $chkPwdPolicy.Location = New-Object System.Drawing.Point(540, 35); $chkPwdPolicy.Size = New-Object System.Drawing.Size(250, 20); $chkPwdPolicy.Text = "Forçar Expiração (GPO)"; $chkPwdPolicy.Checked = $true; $cardOpcoes.Controls.Add($chkPwdPolicy)
$chkAtivar = New-Object System.Windows.Forms.CheckBox; $chkAtivar.Location = New-Object System.Drawing.Point(800, 35); $chkAtivar.Size = New-Object System.Drawing.Size(250, 20); $chkAtivar.Text = "Ativar conta"; $cardOpcoes.Controls.Add($chkAtivar)

# ==========================================================================
# GRID E CONSOLE
# ==========================================================================
# ==========================================================================
# GRID E CONSOLE
# ==========================================================================
$dataGridView = New-Object System.Windows.Forms.DataGridView
$dataGridView.Location = New-Object System.Drawing.Point(20, 220)
$dataGridView.Anchor = [System.Windows.Forms.AnchorStyles]::Top -bor [System.Windows.Forms.AnchorStyles]::Bottom -bor [System.Windows.Forms.AnchorStyles]::Left -bor [System.Windows.Forms.AnchorStyles]::Right
$dataGridView.Size = New-Object System.Drawing.Size(1140, 250)
$dataGridView.AutoSizeColumnsMode = "Fill"
$dataGridView.AllowUserToAddRows = $false
$dataGridView.ReadOnly = $true
$dataGridView.BackgroundColor = [System.Drawing.Color]::White
$dataGridView.BorderStyle = "None"
$dataGridView.EnableHeadersVisualStyles = $false
$dataGridView.ColumnHeadersDefaultCellStyle.BackColor = $MagaluBlue
$dataGridView.ColumnHeadersDefaultCellStyle.ForeColor = [System.Drawing.Color]::White
$dataGridView.ColumnHeadersDefaultCellStyle.Font = New-Object System.Drawing.Font("Segoe UI", 9, [System.Drawing.FontStyle]::Bold)
$dataGridView.GridColor = [System.Drawing.Color]::LightGray

$dataGridView.Columns.Clear()
$dataGridView.Columns.Add("IDSolicitacao", "ID Solicitação") | Out-Null
$dataGridView.Columns.Add("IDColaborador", "ID Colab") | Out-Null
$dataGridView.Columns.Add("Filial", "Filial / Origem") | Out-Null
$dataGridView.Columns.Add("User", "Usuário AD") | Out-Null
$dataGridView.Columns.Add("Nome", "Nome Funcionário") | Out-Null
$dataGridView.Columns.Add("Analista", "Atribuído Para") | Out-Null 
$dataGridView.Columns.Add("Email", "E-mail Colab") | Out-Null
$dataGridView.Columns.Add("EmailGestor", "E-mail Gestor") | Out-Null
$dataGridView.Columns.Add("CC", "Centro de Custo") | Out-Null 
$dataGridView.Columns.Add("SenhaNova", "Nova Senha") | Out-Null
$dataGridView.Columns.Add("Audit", "Já Resetado?") | Out-Null
$dataGridView.Columns.Add("Lideranca", "Liderança") | Out-Null
$dataGridView.Columns.Add("Status", "Status Reset") | Out-Null

$dataGridView.Columns["IDSolicitacao"].Width = 60
$dataGridView.Columns["IDColaborador"].Width = 80
$dataGridView.Columns["Email"].Visible = $false
$dataGridView.Columns["EmailGestor"].Visible = $false
$dataGridView.Columns["Audit"].Visible = $false
# $pnlContent uses mainForm.Controls.Add($dataGridView) relative logic if used inside Panel, 
# but grid is large so let's add to pnlContent
$pnlContent.Controls.Add($dataGridView)

$grpConsole = New-Object System.Windows.Forms.GroupBox
$grpConsole.Text = "Log de Execução"
$grpConsole.Location = New-Object System.Drawing.Point(20, 480)
$grpConsole.Anchor = [System.Windows.Forms.AnchorStyles]::Bottom -bor [System.Windows.Forms.AnchorStyles]::Left -bor [System.Windows.Forms.AnchorStyles]::Right
$grpConsole.Size = New-Object System.Drawing.Size(1140, 100)
$pnlContent.Controls.Add($grpConsole)

$txtConsole = New-Object System.Windows.Forms.TextBox
$txtConsole.Multiline = $true
$txtConsole.ScrollBars = "Vertical"
$txtConsole.ReadOnly = $true
$txtConsole.BackColor = [System.Drawing.Color]::Black
$txtConsole.ForeColor = [System.Drawing.Color]::Lime
$txtConsole.Font = New-Object System.Drawing.Font("Consolas", 9)
$txtConsole.Dock = "Fill"
$grpConsole.Controls.Add($txtConsole)

$txtConsole.Dock = "Fill"
$grpConsole.Controls.Add($txtConsole)
$global:txtConsole = $txtConsole # Expose to function

# ==========================================================================
# FUNÇÃO DE ENVIO DE EMAIL VIA SMTP
# ==========================================================================
function Send-ResetEmail {
    param(
        [string]$Para,
        [string]$CC,
        [string]$Usuario,
        [string]$NomeColaborador,
        [string]$NovaSenha,
        [string]$Executor
    )
    
    $smtpServer = "smtpml.magazineluiza.intranet"
    $smtpPort = 25
    $remetente = "suporte-infra-cds@luizalabs.com"
    $assunto = "Senha Resetada - $Usuario"
    
    $primeiroNome = ($NomeColaborador -split ' ')[0]
    $dataHora = (Get-Date).ToString("dd/MM/yyyy HH:mm")
    
    # Template HTML com identidade visual Magalu
    $corpoHtml = @"
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body style="margin: 0; padding: 0; font-family: Arial, 'Helvetica Neue', sans-serif;">
    <div style="max-width: 600px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
        <!-- Header Magalu -->
        <div style="background: linear-gradient(135deg, #0086FF 0%, #0066CC 100%); padding: 25px; text-align: center;">
            <h1 style="color: #ffffff; margin: 0; font-size: 28px; font-weight: bold; letter-spacing: 1px;">Magalu</h1>
            <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 12px;">Suporte Infra CDs</p>
        </div>
        
        <!-- Rainbow Strip -->
        <div style="height: 6px; background: linear-gradient(90deg, #0086FF 0%, #00C853 20%, #FFEB3B 40%, #FF9800 60%, #E91E63 80%, #9C27B0 100%);"></div>
        
        <!-- Content -->
        <div style="padding: 30px; background-color: #ffffff;">
            <h2 style="color: #0066CC; margin: 0 0 20px 0; font-size: 22px;">Senha Resetada com Sucesso</h2>
            
            <p style="color: #333; font-size: 15px; line-height: 1.6; margin-bottom: 20px;">
                Ola <strong>$primeiroNome</strong>,<br><br>
                A senha de acesso a rede foi resetada conforme solicitacao.
            </p>
            
            <div style="background-color: #f5f7fa; border-left: 4px solid #0086FF; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr>
                        <td style="padding: 8px 0; color: #666; width: 130px;"><strong>Usuario:</strong></td>
                        <td style="padding: 8px 0; color: #333; font-family: 'Courier New', monospace; background: #e8e8e8; padding: 8px 12px; border-radius: 4px;">$Usuario</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #666;"><strong>Nome:</strong></td>
                        <td style="padding: 8px 0; color: #333;">$NomeColaborador</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #666;"><strong>Nova Senha:</strong></td>
                        <td style="padding: 8px 0;">
                            <span style="background: linear-gradient(135deg, #0086FF, #0066CC); color: #fff; padding: 8px 16px; border-radius: 4px; font-family: 'Courier New', monospace; font-weight: bold; letter-spacing: 1px;">$NovaSenha</span>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #666;"><strong>Data/Hora:</strong></td>
                        <td style="padding: 8px 0; color: #333;">$dataHora</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #666;"><strong>Executado por:</strong></td>
                        <td style="padding: 8px 0; color: #333;">$Executor</td>
                    </tr>
                </table>
            </div>
            
            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin: 20px 0;">
                <p style="margin: 0; color: #856404; font-size: 13px;">
                    <strong>Importante:</strong> Voce sera solicitado a trocar a senha no proximo login. Crie uma senha segura e nao compartilhe com ninguem.
                </p>
            </div>
        </div>
        
        <!-- Footer -->
        <div style="background-color: #f5f5f5; padding: 20px; text-align: center; border-top: 1px solid #e0e0e0;">
            <p style="margin: 0; color: #888; font-size: 11px;">
                Este e um email automatico do sistema de Reset de Senhas.<br>
                Suporte Infra CDs - Leandro Araujo
            </p>
        </div>
    </div>
</body>
</html>
"@

    try {
        $msg = New-Object System.Net.Mail.MailMessage
        $msg.From = $remetente
        $msg.To.Add($Para)
        if ($CC -and $CC -ne "") {
            $CC -split ";" | ForEach-Object { 
                if ($_.Trim() -ne "") { $msg.CC.Add($_.Trim()) }
            }
        }
        $msg.Subject = $assunto
        $msg.Body = $corpoHtml
        $msg.IsBodyHtml = $true
        $msg.BodyEncoding = [System.Text.Encoding]::UTF8
        $msg.SubjectEncoding = [System.Text.Encoding]::UTF8
        
        $smtp = New-Object System.Net.Mail.SmtpClient($smtpServer, $smtpPort)
        $smtp.EnableSsl = $false
        $smtp.Timeout = 2000 # 2 segundos de timeout
        
        # Envia com Retry
        Invoke-Retry -ScriptBlock { 
            $smtp.Send($msg) 
        } -ErrorMessage "Falha no envio SMTP"
        
        Write-Console " > Email enviado para: $Para"
        return $true
    }
    catch {
        Write-Console " > ERRO ao enviar email: $_"
        return $false
    }
}

# ==========================================================================
# FUNÇÃO DE EMAIL PARA SOLICITAÇÃO DE CRIAÇÃO DE CONTA NO TURIA
# ==========================================================================
function Send-TuriaRequestEmail {
    param(
        [string]$Para,
        [string]$CC,
        [string]$NomeColaborador,
        [string]$Usuario,
        [string]$CentroCusto
    )
    
    $smtpServer = "smtpml.magazineluiza.intranet"
    $smtpPort = 25
    $remetente = "suporte-infra-cds@luizalabs.com"
    $assunto = "Acao Necessaria - Criar Conta de Rede no Turia para $NomeColaborador"
    
    $primeiroNome = ($NomeColaborador -split ' ')[0]
    
    # Template HTML com passo a passo didático
    $corpoHtml = @"
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body style="margin: 0; padding: 0; font-family: Arial, 'Helvetica Neue', sans-serif;">
    <div style="max-width: 650px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
        <!-- Header Magalu -->
        <div style="background: linear-gradient(135deg, #0086FF 0%, #0066CC 100%); padding: 25px; text-align: center;">
            <h1 style="color: #ffffff; margin: 0; font-size: 28px; font-weight: bold; letter-spacing: 1px;">Magalu</h1>
            <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 12px;">Suporte Infra CDs</p>
        </div>
        
        <!-- Rainbow Strip -->
        <div style="height: 6px; background: linear-gradient(90deg, #0086FF 0%, #00C853 20%, #FFEB3B 40%, #FF9800 60%, #E91E63 80%, #9C27B0 100%);"></div>
        
        <!-- Content -->
        <div style="padding: 30px; background-color: #ffffff;">
            <h2 style="color: #dc3545; margin: 0 0 20px 0; font-size: 22px;">Conta de Rede Nao Encontrada</h2>
            
            <p style="color: #333; font-size: 15px; line-height: 1.6; margin-bottom: 20px;">
                Ola <strong>$primeiroNome</strong>,<br><br>
                Recebemos uma solicitacao de reset de senha para o colaborador abaixo, porem identificamos que <strong>ele ainda nao possui uma conta de rede (login de computador)</strong>.
            </p>
            
            <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr>
                        <td style="padding: 8px 0; color: #721c24; width: 130px;"><strong>Colaborador:</strong></td>
                        <td style="padding: 8px 0; color: #721c24;">$NomeColaborador</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #721c24;"><strong>Usuario Tentado:</strong></td>
                        <td style="padding: 8px 0; color: #721c24; font-family: 'Courier New', monospace;">$Usuario</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #721c24;"><strong>Centro de Custo:</strong></td>
                        <td style="padding: 8px 0; color: #721c24;">$CentroCusto</td>
                    </tr>
                </table>
            </div>
            
            <div style="background-color: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 20px; margin: 25px 0;">
                <h3 style="color: #155724; margin: 0 0 15px 0; font-size: 18px;">Como Solicitar a Criacao da Conta</h3>
                <p style="color: #155724; font-size: 14px; margin-bottom: 15px;">
                    Siga o passo a passo abaixo para criar a conta de rede no sistema <strong>Turia</strong>:
                </p>
                
                <div style="background: #fff; border-radius: 6px; padding: 15px;">
                    <!-- Passo 1 -->
                    <div style="display: flex; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;">
                        <div style="background: #0086FF; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: inline-block; text-align: center; line-height: 30px; font-weight: bold; margin-right: 15px; flex-shrink: 0;">1</div>
                        <div>
                            <strong style="color: #333;">Acesse o sistema Turia</strong><br>
                            <span style="color: #666; font-size: 13px;">Entre no site: <a href="https://iam.corp.luizalabs.com/" style="color: #0086FF;">https://iam.corp.luizalabs.com/</a></span><br>
                            <span style="color: #666; font-size: 13px;">Em "Minhas Requisicoes", clique no botao <strong style="color: #0086FF;">+ Criar</strong></span>
                        </div>
                    </div>
                    
                    <!-- Passo 2 -->
                    <div style="display: flex; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;">
                        <div style="background: #0086FF; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: inline-block; text-align: center; line-height: 30px; font-weight: bold; margin-right: 15px; flex-shrink: 0;">2</div>
                        <div>
                            <strong style="color: #333;">Selecione "Acesso as aplicacoes"</strong><br>
                            <span style="color: #666; font-size: 13px;">Na tela "Voce deseja...", clique em <strong style="color: #0086FF;">Solicitar acessos</strong></span>
                        </div>
                    </div>
                    
                    <!-- Passo 3 -->
                    <div style="display: flex; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;">
                        <div style="background: #0086FF; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: inline-block; text-align: center; line-height: 30px; font-weight: bold; margin-right: 15px; flex-shrink: 0;">3</div>
                        <div>
                            <strong style="color: #333;">Escolha para quem e o acesso</strong><br>
                            <span style="color: #666; font-size: 13px;">Selecione <strong style="color: #0086FF;">"Para outro colaborador"</strong> e clique em Proximo</span><br>
                            <span style="color: #666; font-size: 13px;">Busque pelo nome: <strong>$NomeColaborador</strong></span>
                        </div>
                    </div>
                    
                    <!-- Passo 4 -->
                    <div style="display: flex; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;">
                        <div style="background: #28a745; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: inline-block; text-align: center; line-height: 30px; font-weight: bold; margin-right: 15px; flex-shrink: 0;">4</div>
                        <div>
                            <strong style="color: #333;">Use um colaborador como referencia (RECOMENDADO)</strong><br>
                            <span style="color: #666; font-size: 13px;">Selecione <strong style="color: #28a745;">"Usar colaborador como referencia"</strong></span><br>
                            <span style="color: #666; font-size: 13px;">Busque um colega que ja tenha os mesmos acessos necessarios</span><br>
                            <span style="color: #999; font-size: 12px; font-style: italic;">Isso copia automaticamente os acessos do colega</span>
                        </div>
                    </div>
                    
                    <!-- Passo 5 -->
                    <div style="display: flex;">
                        <div style="background: #0086FF; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: inline-block; text-align: center; line-height: 30px; font-weight: bold; margin-right: 15px; flex-shrink: 0;">5</div>
                        <div>
                            <strong style="color: #333;">Selecione o sistema "AD Magalu"</strong><br>
                            <span style="color: #666; font-size: 13px;">Na lista de sistemas, marque a opcao <strong style="color: #0086FF;">"AD Magalu"</strong></span><br>
                            <span style="color: #666; font-size: 13px;">Este e o sistema responsavel pelo login no computador</span><br>
                            <span style="color: #666; font-size: 13px;">Finalize a solicitacao e aguarde a aprovacao</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin: 20px 0;">
                <p style="margin: 0; color: #856404; font-size: 13px;">
                    <strong>Importante:</strong> Apos a aprovacao da solicitacao, o colaborador recebera um e-mail com as credenciais de acesso. Esse processo pode levar ate 24 horas.
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <a href="https://iam.corp.luizalabs.com/" style="display: inline-block; background: linear-gradient(135deg, #0086FF, #0066CC); color: #fff; padding: 12px 30px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 14px;">Acessar o Turia Agora</a>
            </div>
        </div>
        
        <!-- Footer -->
        <div style="background-color: #f5f5f5; padding: 20px; text-align: center; border-top: 1px solid #e0e0e0;">
            <p style="margin: 0; color: #888; font-size: 11px;">
                Este e um email automatico do sistema de Reset de Senhas.<br>
                Suporte Infra CDs - Leandro Araujo
            </p>
        </div>
    </div>
</body>
</html>
"@

    try {
        $msg = New-Object System.Net.Mail.MailMessage
        $msg.From = $remetente
        $msg.To.Add($Para)
        if ($CC -and $CC -ne "") {
            $CC -split ";" | ForEach-Object { 
                if ($_.Trim() -ne "") { $msg.CC.Add($_.Trim()) }
            }
        }
        $msg.Subject = $assunto
        $msg.Body = $corpoHtml
        $msg.IsBodyHtml = $true
        $msg.BodyEncoding = [System.Text.Encoding]::UTF8
        $msg.SubjectEncoding = [System.Text.Encoding]::UTF8
        
        $smtp = New-Object System.Net.Mail.SmtpClient($smtpServer, $smtpPort)
        $smtp.EnableSsl = $false
        $smtp.Timeout = 2000 # 2 segundos de timeout
        
        # Envia com Retry
        Invoke-Retry -ScriptBlock { 
            $smtp.Send($msg) 
        } -ErrorMessage "Falha no envio SMTP (Turia)"
        
        Write-Console " > Email de solicitacao Turia enviado para: $Para"
        return $true
    }
    catch {
        Write-Console " > ERRO ao enviar email Turia: $_"
        return $false
    }
}

# ==========================================================================
# RODAPÉ
# ==========================================================================
$btnReset = New-Object System.Windows.Forms.Button
$btnReset.Anchor = [System.Windows.Forms.AnchorStyles]::Bottom -bor [System.Windows.Forms.AnchorStyles]::Left
$btnReset.Location = New-Object System.Drawing.Point(20, 600); $btnReset.Size = New-Object System.Drawing.Size(220, 40)
$btnReset.Text = "EXECUTAR PROCESSO"; $btnReset.BackColor = [System.Drawing.Color]::ForestGreen; $btnReset.ForeColor = "White"; $btnReset.Enabled = $false
$btnReset.Font = New-Object System.Drawing.Font("Segoe UI", 10, [System.Drawing.FontStyle]::Bold)
$btnReset.FlatStyle = "Flat"; $btnReset.FlatAppearance.BorderSize = 0
$pnlContent.Controls.Add($btnReset)

$btnExport = New-Object System.Windows.Forms.Button
$btnExport.Anchor = [System.Windows.Forms.AnchorStyles]::Bottom -bor [System.Windows.Forms.AnchorStyles]::Left
$btnExport.Location = New-Object System.Drawing.Point(260, 600); $btnExport.Size = New-Object System.Drawing.Size(160, 40)
$btnExport.Text = "Exportar Pendentes"; $btnExport.BackColor = "Orange"; $btnExport.Enabled = $false
$btnExport.Font = New-Object System.Drawing.Font("Segoe UI", 9, [System.Drawing.FontStyle]::Bold)
$btnExport.FlatStyle = "Flat"; $btnExport.FlatAppearance.BorderSize = 0
$pnlContent.Controls.Add($btnExport)

$lblAssinatura = New-Object System.Windows.Forms.Label
$lblAssinatura.Text = "Reset de Usuários - Suporte Infra CDs v1.0.5"
$lblAssinatura.AutoSize = $true
$lblAssinatura.ForeColor = [System.Drawing.Color]::Gray
$lblAssinatura.Anchor = [System.Windows.Forms.AnchorStyles]::Bottom -bor [System.Windows.Forms.AnchorStyles]::Right
$lblAssinatura.Location = New-Object System.Drawing.Point(800, 610)
$pnlContent.Controls.Add($lblAssinatura)

# ==========================================================================
# LÓGICA 1: CARGA (GET) + FILTRAGEM
# ==========================================================================
function CarregarDados($urlSufix) {
    if ($cbAnalista.Text.Length -lt 3) {
        [System.Windows.Forms.MessageBox]::Show("Selecione ou digite seu nome corretamente.", "Atenção", "OK", "Warning")
        return
    }
    
    $analistaSelecionado = $cbAnalista.Text
    
    # Parâmetro mode=api garante o retorno de fila de usuários
    $separador = if ($urlSufix -match "\?") { "&" } else { "?" }
    $urlFinal = $API_URL + $urlSufix + $separador + "mode=api"

    $mainForm.Cursor = [System.Windows.Forms.Cursors]::WaitCursor
    $dataGridView.Rows.Clear()
    $statusLabel.Text = "Consultando API..."
    Write-Console "Iniciando consulta à API..."

    try {
        $apiData = Invoke-Retry -ScriptBlock { 
            Invoke-RestMethod -Uri $urlFinal -Method Get 
        } -ErrorMessage "Falha ao consultar API de Demandas"
        
        Write-Console "Resposta recebida com sucesso."
        
        $lista = @($apiData)

        # Checagem de Erro da API
        if ($lista.Count -eq 1 -and $null -ne $lista[0].error) {
            [System.Windows.Forms.MessageBox]::Show("API: $($lista[0].error)", "Informação", "OK", "Information")
            $statusLabel.Text = "API: $($lista[0].error)"
            Write-Console "MSG API: $($lista[0].error)"
            return
        }

        # Filtragem e População
        $contadorOw = 0     # Meus
        $contadorLivre = 0  # Livres
        $ignorados = 0      # Outros
        
        foreach ($user in $lista) {
            if ($null -eq $user.user_name) { continue }
            
            $taskType = if ($user.task_type) { $user.task_type } else { "RESET" }
            $atribuido = if ($user.analista) { $user.analista } else { "N/A" } 
            if ([string]::IsNullOrWhiteSpace($user.analista)) { $atribuido = "N/A" }
            
            # Filtro Lógico: Se busquei por filial e tem dono diferente, ignoro (exceto se selecionou TODOS)
            if ($urlSufix -match "filial=" -and $analistaSelecionado -ne "TODOS") {
                if ($atribuido -ne $analistaSelecionado -and $atribuido -ne "N/A") {
                    $ignorados++
                    continue 
                }
            }
            
            # Dados básicos
            $origem = if ($user.aba) { $user.aba } else { "N/A" }
            $email = if ($user.email_colaborador) { $user.email_colaborador } else { "" }
            $emailGestor = if ($user.email_gestor) { $user.email_gestor } else { "" }
            $jaResetado = if ($user.ja_resetado) { $true } else { $false }
            $cc = if ($user.centro_custo) { $user.centro_custo } else { "" }
            
            # Formata Nome
            $nomeFormatado = $user.nome
            if ($nomeFormatado) { $nomeFormatado = (Get-Culture).TextInfo.ToTitleCase($nomeFormatado.ToLower()) }
            
            # IDs
            $idSolicitacao = if ($user.id_solicitacao) { $user.id_solicitacao } else { "" }
            $idColab = if ($user.id_colaborador) { $user.id_colaborador } else { "" }

            # Lógica por tipo de tarefa
            $senhaOuInfo = ""
            $userGridDisplay = ""
            if ($taskType -eq "MIRROR") {
                $userGridDisplay = "MULT: " + $user.user_modelo
                $senhaOuInfo = "ESPELHO: $($user.grupos.Count) grupos"
                $statusDisplay = "Pendente (Espelho)"
            }
            else {
                $userGridDisplay = $user.user_name
                $rnd = Get-Random -Minimum 1000 -Maximum 9999
                $senhaOuInfo = "##Magazine##${rnd}"
                $statusDisplay = "Pendente"
            }

            $liderancaTexto = if ($emailGestor) { $emailGestor } else { "Sem gestor" }

            $rowId = $dataGridView.Rows.Add($idSolicitacao, $idColab, $origem, $userGridDisplay, $nomeFormatado, $atribuido, $email, $emailGestor, $cc, $senhaOuInfo, $jaResetado, $liderancaTexto, $statusDisplay)
            
            # Armazena dados extras na Tag da linha (para execução)
            $rowRef = $dataGridView.Rows[$rowId]
            $rowRef.Tag = $user # Salva o objeto original completo (que tem TaskType, Grupos, Targets, etc)

            if ($atribuido -eq "N/A") {
                $rowRef.Cells["Analista"].Value = "LIVRE (N/A)"
                $rowRef.Cells["Analista"].Style.ForeColor = "Blue"
                $contadorLivre++
            }
            else {
                $rowRef.Cells["Analista"].Style.ForeColor = "Green"
                $contadorOw++
            }
            
            if ($jaResetado) {
                $rowRef.DefaultCellStyle.BackColor = [System.Drawing.Color]::FromArgb(255, 250, 205) 
                $rowRef.Cells["Status"].Value = "JÁ AUDITADO"
            }
        }

        $totalVisivel = $contadorOw + $contadorLivre

        if ($totalVisivel -gt 0) {
            $btnReset.Enabled = $true; $btnExport.Enabled = $true
            $statusLabel.Text = "$totalVisivel registros (Meus: $contadorOw | Livres: $contadorLivre)."
            Write-Console "Sucesso. Encontrados: Meus=$contadorOw, Livres=$contadorLivre."
            
            if ($analistaSelecionado -eq "TODOS") {
                [System.Windows.Forms.MessageBox]::Show("Busca Concluída!`n`nTotal de registros: $totalVisivel`n(Atribuídos: $contadorOw | Livres: $contadorLivre)", "Sucesso", "OK", "Information")
            }
            else {
                [System.Windows.Forms.MessageBox]::Show("Busca Concluída!`n`nAtribuídos a VOCÊ: $contadorOw`nDisponíveis: $contadorLivre", "Sucesso", "OK", "Information")
            }
        }
        else {
            if ($ignorados -gt 0) {
                [System.Windows.Forms.MessageBox]::Show("Nenhum registro para VOCÊ ou LIVRE.`nMas existem $ignorados registros de OUTROS analistas.", "Aviso", "OK", "Warning")
                Write-Console "Aviso: Pendências de outros analistas ($ignorados)."
            }
            else {
                [System.Windows.Forms.MessageBox]::Show("Nenhum registro encontrado.", "Vazio", "OK", "Information")
                Write-Console "Nenhum resultado retornado."
            }
            $statusLabel.Text = "Nenhum resultado."
        }
    }
    catch { 
        [System.Windows.Forms.MessageBox]::Show("Erro Consultar API: $_", "Erro", "OK", "Error")
        $statusLabel.Text = "Erro conexão."
        Write-Console "ERRO FATAL: $_"
    }
    finally { $mainForm.Cursor = [System.Windows.Forms.Cursors]::Default }
}

$btnBuscar.Add_Click({
        if ([string]::IsNullOrEmpty($txtFilial.Text)) { return }
        $filialEnc = if ($txtFilial.Text -eq "*") { "*" } else { [Uri]::EscapeDataString($txtFilial.Text) }
        CarregarDados "?filial=$filialEnc"
    })

$btnBuscarUnico.Add_Click({
        if ([string]::IsNullOrEmpty($txtUserUnico.Text)) { return }
        CarregarDados "?usuario=$($txtUserUnico.Text)"
    })

# ==========================================================================
# LÓGICA 2: RESET (POST)
# ==========================================================================
$btnReset.Add_Click({
        if ([System.Windows.Forms.MessageBox]::Show("Confirma a execução dos resets listados?", "Confirmação", "YesNo", "Warning") -eq 'No') { return }
    
        $urlBase = $API_URL
        $executor = $env:USERNAME
    
        $enviarEmail = $chkEmail.Checked
        $ativarConta = $chkAtivar.Checked
        $desbloquearConta = $chkUnlock.Checked
        $forcarExpiracao = $chkPwdPolicy.Checked
    
        Write-Console "Iniciando processamento em lote..."

        foreach ($row in $dataGridView.Rows) {
            $userObject = $row.Tag
            $taskType = if ($userObject.task_type) { $userObject.task_type } else { "RESET" }
            $idSolicitacao = $row.Cells["IDSolicitacao"].Value

            if ($row.Cells["Audit"].Value -eq $true) {
                $row.Cells["Status"].Value = "IGNORADO (Já feito)"; continue
            }
            if ($row.Cells["Status"].Value -match "SUCESSO") { continue } 

            $statusLabel.Text = "Processando ID #$idSolicitacao ($taskType)..."
            [System.Windows.Forms.Application]::DoEvents()

            try {
                if ($taskType -eq "MIRROR") {
                    # --- EXECUÇÃO DE ESPELHAMENTO ---
                    $userModelo = $userObject.user_modelo
                    $destinos = $userObject.targets
                    $grupos = $userObject.grupos

                    Write-Console "Espelhando $userModelo -> $($destinos.Count) destinos..."

                    foreach ($dest in $destinos) {
                        Write-Console " > Destino: $dest"
                        foreach ($grp in $grupos) {
                            try {
                                Add-ADGroupMember -Identity $grp -Members $dest -ErrorAction Stop
                                Write-Console "   [+] $grp"
                            }
                            catch {
                                if ($_.Exception.Message -like "*already a member*") {
                                    Write-Console "   [~] $grp (Já possui)"
                                }
                                else { throw $_ }
                            }
                        }
                    }

                    $row.Cells["Status"].Value = "SUCESSO"
                    $row.DefaultCellStyle.BackColor = [System.Drawing.Color]::LightGreen
                    Write-Console " > SUCESSO! Espelhamento concluído."

                    # LOG PARA API (MIRROR)
                    $pMirror = @{
                        id_solicitacao = $idSolicitacao
                        status         = "SUCESSO"
                        type           = "EXECUTE_MIRROR"
                        executor       = $executor
                        data_hora      = (Get-Date).ToString("dd/MM/yyyy HH:mm")
                    } | ConvertTo-Json

                    Invoke-Retry -ScriptBlock {
                        Invoke-RestMethod -Uri $urlBase -Method Post -Body $pMirror -ContentType "application/json" 
                    } -ErrorMessage "Falha ao enviar log Mirror API"

                } 
                else {
                    # --- EXECUÇÃO DE RESET (Lógica Original) ---
                    $userAD = $row.Cells["User"].Value
                    $senha = $row.Cells["SenhaNova"].Value; $origem = $row.Cells["Filial"].Value
                    $nome = $row.Cells["Nome"].Value; $emailColab = $row.Cells["Email"].Value; $cc = $row.Cells["CC"].Value
                    $emailGestor = $row.Cells["EmailGestor"].Value

                    Write-Console "Resetando senha: $userAD..."

                    $adUser = Get-ADUser -Identity $userAD -ErrorAction Stop
                    $sec = ConvertTo-SecureString $senha -AsPlainText -Force
                    
                    Set-ADAccountPassword -Identity $userAD -NewPassword $sec -Reset -ErrorAction Stop
                    Set-ADUser -Identity $userAD -ChangePasswordAtLogon $true -ErrorAction Stop
                
                    if ($ativarConta) { Enable-ADAccount -Identity $userAD -ErrorAction SilentlyContinue; Write-Console " > Conta ativada." }
                    if ($desbloquearConta) { Unlock-ADAccount -Identity $userAD -ErrorAction SilentlyContinue; Write-Console " > Conta desbloqueada." }
                    if ($forcarExpiracao) { Set-ADUser -Identity $userAD -PasswordNeverExpires $false -ErrorAction SilentlyContinue }

                    $row.Cells["Status"].Value = "SUCESSO"
                    $row.DefaultCellStyle.BackColor = [System.Drawing.Color]::LightGreen
                    Write-Console " > SUCESSO! Senha resetada."
                
                    # Envio de Email
                    $emailStatusLog = "Desabilitado"
                    if ($enviarEmail -and $emailColab) {
                        $emailEnviado = Send-ResetEmail -Para $emailColab -CC $emailGestor -Usuario $userAD -NomeColaborador $nome -NovaSenha $senha -Executor $executor
                        $emailStatusLog = if ($emailEnviado) { "Enviado" } else { "Erro" }
                    }

                    # LOG PARA API (RESET)
                    $pReset = @{
                        id_solicitacao = $idSolicitacao;
                        user_name      = $userAD;
                        status         = "SUCESSO";
                        executor       = $executor;
                        nova_senha     = $senha;
                        email_status   = $emailStatusLog;
                        data_hora      = (Get-Date).ToString("dd/MM/yyyy HH:mm")
                    } | ConvertTo-Json
                
                    Invoke-Retry -ScriptBlock {
                        Invoke-RestMethod -Uri $urlBase -Method Post -Body $pReset -ContentType "application/json" 
                    } -ErrorMessage "Falha ao enviar log Reset API"
                }

            }
            catch {
                $err = $_.Exception.Message
                Write-Console " > ERRO: $err"
                $row.Cells["Status"].Value = "ERRO"
                $row.DefaultCellStyle.BackColor = [System.Drawing.Color]::MistyRose
                
                # Tratamento específico para Reset de usuário não encontrado (Turia flow)
                if ($taskType -eq "RESET" -and ($err -match "não é possível localizar|cannot find|not found")) {
                    Write-Console " > Iniciando fluxo Turia..."
                    # ... (Omiti o resto por brevidade, mas a lógica de erro do Turia pode ser mantida aqui se necessário)
                }
            }
        }
        [System.Windows.Forms.MessageBox]::Show("Processo Concluído.", "Fim", "OK", "Information")
        $statusLabel.Text = "Pronto."
        Write-Console "Processo finalizado."
    })

$btnExport.Add_Click({
        $sfd = New-Object System.Windows.Forms.SaveFileDialog; $sfd.Filter = "CSV|*.csv"; $sfd.FileName = "Reset_Log_Atribuicao.csv"
        if ($sfd.ShowDialog() -eq "OK") {
            $data = foreach ($r in $dataGridView.Rows) { 
                [PSCustomObject]@{
                    Filial   = $r.Cells["Filial"].Value; 
                    User     = $r.Cells["User"].Value; 
                    Analista = $r.Cells["Analista"].Value;
                    Status   = $r.Cells["Status"].Value 
                } 
            }
            $data | Export-Csv -Path $sfd.FileName -NoTypeInformation -Encoding UTF8 -Delimiter ";"
        }
    })

$statusLabel.Text = "Pronto."
$mainForm.ShowDialog()

```
